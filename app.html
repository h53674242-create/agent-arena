<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ü¶û Agent Arena</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Inter:wght@400;500;600;700&display=swap');
  
  :root {
    --bg: #08080c; --surface: #111118; --border: #2a2a3a;
    --text: #e4e4e7; --muted: #71717a; --accent: #fbbf24;
    --green: #22c55e; --red: #ef4444; --blue: #3b82f6;
    --sidebar-width: 240px;
  }
  
  * { margin: 0; padding: 0; box-sizing: border-box; }
  
  body {
    font-family: 'Inter', sans-serif;
    background: var(--bg);
    color: var(--text);
    height: 100vh;
    overflow: hidden;
    display: flex;
  }
  
  /* Sidebar */
  .sidebar {
    width: var(--sidebar-width);
    background: var(--surface);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    flex-shrink: 0;
    transition: transform 0.2s ease;
  }
  
  .sidebar-header {
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  .logo {
    font-family: 'Press Start 2P', monospace;
    font-size: 11px;
    color: var(--accent);
  }
  
  .status {
    margin-left: auto;
    font-size: 10px;
    padding: 3px 8px;
    border-radius: 8px;
    font-weight: 600;
  }
  
  .status.online {
    color: var(--green);
    background: rgba(34, 197, 94, 0.1);
  }
  
  .status.offline {
    color: var(--red);
    background: rgba(239, 68, 68, 0.1);
  }
  
  .agent-list {
    flex: 1;
    overflow-y: auto;
    padding: 12px 0;
  }
  
  .section-title {
    padding: 8px 20px;
    font-size: 11px;
    font-weight: 700;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .agent-item {
    padding: 12px 20px;
    cursor: pointer;
    border: none;
    background: none;
    width: 100%;
    text-align: left;
    color: var(--text);
    transition: background 0.1s ease;
    position: relative;
  }
  
  .agent-item:hover {
    background: rgba(255, 255, 255, 0.05);
  }
  
  .agent-item.selected {
    background: rgba(251, 191, 36, 0.1);
    border-right: 2px solid var(--accent);
  }
  
  .agent-item .agent-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 4px;
  }
  
  .agent-item .emoji {
    font-size: 16px;
    position: relative;
  }
  
  .agent-item .installed-dot {
    position: absolute;
    bottom: -1px;
    right: -1px;
    width: 6px;
    height: 6px;
    background: var(--green);
    border-radius: 50%;
    border: 1px solid var(--surface);
  }
  
  .agent-item .name {
    font-weight: 600;
    font-size: 13px;
  }
  
  .agent-item .tagline {
    font-size: 11px;
    color: var(--muted);
    line-height: 1.3;
  }
  
  /* Main Content */
  .main-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  
  /* Agent Detail View */
  .agent-detail {
    flex: 1;
    overflow-y: auto;
    padding: 40px;
    display: none;
  }
  
  .agent-detail.active {
    display: block;
  }
  
  .agent-hero {
    text-align: center;
    margin-bottom: 32px;
  }
  
  .agent-hero .emoji {
    font-size: 64px;
    margin-bottom: 16px;
    display: block;
  }
  
  .agent-hero h1 {
    font-size: 32px;
    font-weight: 700;
    margin-bottom: 8px;
  }
  
  .agent-hero .tagline {
    font-size: 16px;
    color: var(--muted);
    margin-bottom: 16px;
  }
  
  .agent-hero .price {
    display: inline-block;
    padding: 6px 12px;
    background: var(--green);
    color: #000;
    border-radius: 8px;
    font-weight: 700;
    font-size: 13px;
  }
  
  .agent-sections {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 32px;
    max-width: 1000px;
    margin: 0 auto;
  }
  
  .agent-section h3 {
    font-size: 16px;
    font-weight: 700;
    margin-bottom: 12px;
    color: var(--accent);
  }
  
  .skills {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }
  
  .skill-tag {
    padding: 4px 8px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    font-size: 12px;
    color: var(--text);
  }
  
  .description {
    line-height: 1.6;
    color: var(--muted);
  }
  
  .soul-preview {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 16px;
    font-family: 'Monaco', 'Menlo', monospace;
    font-size: 12px;
    line-height: 1.5;
    color: var(--muted);
    white-space: pre-wrap;
    max-height: 200px;
    overflow-y: auto;
  }
  
  .install-section {
    grid-column: 1 / -1;
    text-align: center;
    padding: 32px 0;
  }
  
  .install-button {
    display: inline-block;
    padding: 16px 32px;
    background: var(--accent);
    color: #000;
    border: none;
    border-radius: 8px;
    font-weight: 700;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.1s ease;
    text-decoration: none;
  }
  
  .install-button:hover {
    transform: translateY(-1px);
    filter: brightness(1.1);
  }
  
  .install-command {
    background: #000;
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 16px;
    margin-top: 16px;
    font-family: 'Monaco', 'Menlo', monospace;
    font-size: 13px;
    color: var(--green);
    max-width: 600px;
    margin-left: auto;
    margin-right: auto;
    position: relative;
  }
  
  .install-command .copy-btn {
    position: absolute;
    top: 8px;
    right: 8px;
    padding: 4px 8px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    font-size: 10px;
    cursor: pointer;
    color: var(--text);
  }
  
  /* Chat View */
  .chat-view {
    flex: 1;
    display: none;
    flex-direction: column;
  }
  
  .chat-view.active {
    display: flex;
  }
  
  .chat-header {
    padding: 16px 24px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  .chat-header .agent-info {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  .chat-header .emoji {
    font-size: 24px;
  }
  
  .chat-header .details {
    flex: 1;
  }
  
  .chat-header .name {
    font-size: 16px;
    font-weight: 700;
    margin-bottom: 2px;
  }
  
  .chat-header .status-text {
    font-size: 12px;
    color: var(--green);
  }
  
  .messages {
    flex: 1;
    overflow-y: auto;
    padding: 24px;
    display: flex;
    flex-direction: column;
    gap: 16px;
  }
  
  .message {
    max-width: 80%;
    padding: 12px 16px;
    border-radius: 12px;
    line-height: 1.5;
  }
  
  .message.user {
    align-self: flex-end;
    background: rgba(251, 191, 36, 0.1);
    border: 1px solid rgba(251, 191, 36, 0.2);
    color: var(--text);
  }
  
  .message.agent {
    align-self: flex-start;
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text);
  }
  
  .message .sender {
    font-size: 11px;
    font-weight: 700;
    margin-bottom: 4px;
    color: var(--muted);
  }
  
  .message.agent .sender {
    color: var(--accent);
  }
  
  .typing-indicator {
    align-self: flex-start;
    padding: 12px 16px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    font-size: 12px;
    color: var(--muted);
    display: none;
  }
  
  .typing-indicator.active {
    display: block;
  }
  
  .chat-input {
    padding: 16px 24px;
    border-top: 1px solid var(--border);
    display: flex;
    gap: 12px;
    align-items: end;
  }
  
  .chat-input input {
    flex: 1;
    padding: 12px 16px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-size: 14px;
    outline: none;
    resize: none;
    font-family: inherit;
  }
  
  .chat-input input:focus {
    border-color: var(--accent);
  }
  
  .chat-input button {
    padding: 12px 20px;
    background: var(--accent);
    color: #000;
    border: none;
    border-radius: 8px;
    font-weight: 700;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.1s ease;
  }
  
  .chat-input button:hover {
    filter: brightness(1.1);
  }
  
  .chat-input button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  
  /* Empty State */
  .empty-state {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 40px;
    color: var(--muted);
  }
  
  .empty-state .emoji {
    font-size: 48px;
    margin-bottom: 16px;
    opacity: 0.5;
  }
  
  .empty-state h3 {
    font-size: 18px;
    margin-bottom: 8px;
    color: var(--text);
  }
  
  .empty-state p {
    font-size: 14px;
    line-height: 1.5;
  }
  
  /* Mobile Responsive */
  @media (max-width: 768px) {
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      height: 100%;
      z-index: 100;
      transform: translateX(-100%);
      width: 280px;
    }
    
    .sidebar.mobile-open {
      transform: translateX(0);
    }
    
    .main-content {
      width: 100%;
    }
    
    .mobile-header {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      background: var(--surface);
    }
    
    .mobile-menu-btn {
      padding: 8px;
      background: none;
      border: none;
      color: var(--text);
      cursor: pointer;
      margin-right: 12px;
    }
    
    .agent-sections {
      grid-template-columns: 1fr;
      gap: 24px;
    }
    
    .mobile-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 99;
      display: none;
    }
    
    .mobile-overlay.active {
      display: block;
    }
  }
  
  @media (min-width: 769px) {
    .mobile-header {
      display: none;
    }
  }
  
  /* Waitlist Form */
  .waitlist-view {
    flex: 1;
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 40px;
    text-align: center;
  }
  
  .waitlist-view.active {
    display: flex;
  }
  
  .waitlist-hero {
    margin-bottom: 40px;
  }
  
  .waitlist-hero .emoji {
    font-size: 64px;
    margin-bottom: 24px;
    display: block;
  }
  
  .waitlist-hero h1 {
    font-family: 'Press Start 2P', monospace;
    font-size: 24px;
    color: var(--accent);
    margin-bottom: 16px;
    line-height: 1.4;
  }
  
  .waitlist-hero p {
    font-size: 16px;
    color: var(--muted);
    line-height: 1.6;
    max-width: 500px;
  }
  
  .waitlist-form {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 32px;
    max-width: 400px;
    width: 100%;
  }
  
  .waitlist-form h2 {
    font-size: 20px;
    margin-bottom: 8px;
  }
  
  .waitlist-form .subtitle {
    font-size: 14px;
    color: var(--muted);
    margin-bottom: 24px;
  }
  
  .waitlist-form .input-group {
    display: flex;
    gap: 12px;
    margin-bottom: 16px;
  }
  
  .waitlist-form input {
    flex: 1;
    padding: 12px 16px;
    background: #000;
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-size: 14px;
    outline: none;
  }
  
  .waitlist-form input:focus {
    border-color: var(--accent);
  }
  
  .waitlist-form button {
    padding: 12px 24px;
    background: var(--accent);
    color: #000;
    border: none;
    border-radius: 8px;
    font-weight: 700;
    font-size: 14px;
    cursor: pointer;
    white-space: nowrap;
  }
  
  .waitlist-success {
    display: none;
    text-align: center;
  }
  
  .waitlist-success.active {
    display: block;
  }
  
  .waitlist-success .check {
    font-size: 48px;
    margin-bottom: 16px;
  }
  
  /* Keyboard navigation indicator */
  .agent-item.keyboard-focused {
    outline: 2px solid var(--accent);
    outline-offset: -2px;
  }
</style>
</head>
<body>

<!-- Mobile Overlay -->
<div class="mobile-overlay" id="mobileOverlay"></div>

<!-- Sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <span class="logo">ü¶û AGENT ARENA</span>
    <span class="status offline" id="status">‚óè Offline</span>
  </div>
  <div class="agent-list" id="agentList">
    <!-- Agents will be populated here -->
  </div>
</div>

<!-- Main Content -->
<div class="main-content">
  <!-- Mobile Header -->
  <div class="mobile-header">
    <button class="mobile-menu-btn" id="mobileMenuBtn">‚ò∞</button>
    <span class="logo">ü¶û AGENT ARENA</span>
  </div>

  <!-- Empty State -->
  <div class="empty-state" id="emptyState">
    <div class="emoji">ü¶û</div>
    <h3>Welcome to Agent Arena</h3>
    <p>Select an agent from the sidebar to view details or start a conversation.</p>
  </div>

  <!-- Agent Detail View -->
  <div class="agent-detail" id="agentDetail">
    <!-- Agent details will be populated here -->
  </div>

  <!-- Chat View -->
  <div class="chat-view" id="chatView">
    <div class="chat-header">
      <div class="agent-info">
        <div class="emoji" id="chatAgentEmoji">ü§ñ</div>
        <div class="details">
          <div class="name" id="chatAgentName">Agent</div>
          <div class="status-text">‚óè Online</div>
        </div>
      </div>
    </div>
    <div class="messages" id="messages">
      <!-- Messages will be populated here -->
    </div>
    <div class="typing-indicator" id="typingIndicator">
      <span id="typingText">Agent is typing...</span>
    </div>
    <div class="chat-input">
      <input type="text" id="chatInput" placeholder="Type a message..." autocomplete="off">
      <button id="sendBtn" onclick="sendMessage()">Send</button>
    </div>
  </div>

  <!-- Waitlist View -->
  <div class="waitlist-view" id="waitlistView">
    <div class="waitlist-hero">
      <div class="emoji">ü¶û</div>
      <h1>Coming Soon</h1>
      <p>Agent Arena is currently in development. Join our waitlist to get early access to the next generation of AI agents.</p>
    </div>
    <div class="waitlist-form">
      <div id="waitlistFormContent">
        <h2>Join Waitlist</h2>
        <p class="subtitle">Be the first to hire your AI team</p>
        <div class="input-group">
          <input type="email" id="waitlistEmail" placeholder="you@example.com" required>
          <button onclick="submitWaitlist()">Join</button>
        </div>
      </div>
      <div class="waitlist-success" id="waitlistSuccess">
        <div class="check">‚úÖ</div>
        <h2>You're on the list!</h2>
        <p>We'll email you when Agent Arena is ready.</p>
      </div>
    </div>
  </div>
</div>

<script>
// Global state
let ws = null;
let agents = [];
let registeredAgents = [];
let currentAgent = null;
let currentView = 'empty'; // 'empty', 'detail', 'chat', 'waitlist'
let sessions = {}; // agentName -> sessionKey
let streamBuffers = {}; // runId -> text
let selectedIndex = -1; // For keyboard navigation

// WebSocket connection
const WS_URL = `ws://${location.host}`;
const LOCAL_SERVER = `${location.protocol}//${location.host}`;

// Initialize app
async function init() {
  setupMobile();
  setupKeyboardNavigation();
  await checkConnection();
}

// Check if local server is available
async function checkConnection() {
  try {
    const res = await fetch(`${LOCAL_SERVER}/api/agents`, { 
      signal: AbortSignal.timeout(3000) 
    });
    if (res.ok) {
      // Server is running locally
      updateStatus(true);
      await loadAgents();
      connectWebSocket();
      return;
    }
    throw new Error('not ok');
  } catch (e) {
    // Server not available - show waitlist
    showWaitlist();
  }
}

// Load agent data
async function loadAgents() {
  try {
    const [agentsRes, registeredRes] = await Promise.all([
      fetch(`${LOCAL_SERVER}/api/agents`),
      fetch(`${LOCAL_SERVER}/api/agents/registered`)
    ]);
    
    agents = await agentsRes.json();
    registeredAgents = await registeredRes.json();
    
    renderAgentList();
  } catch (e) {
    console.error('Failed to load agents:', e);
  }
}

// Render agent list in sidebar
function renderAgentList() {
  const agentList = document.getElementById('agentList');
  const registeredIds = new Set(registeredAgents.map(a => a.id));
  
  // Separate installed and available agents
  const installed = agents.filter(a => registeredIds.has(a.name.replace(/-agent$/, '')));
  const available = agents.filter(a => !registeredIds.has(a.name.replace(/-agent$/, '')));
  
  let html = '';
  
  if (installed.length > 0) {
    html += '<div class="section-title">Installed Agents</div>';
    installed.forEach(agent => {
      html += renderAgentItem(agent, true);
    });
  }
  
  if (available.length > 0) {
    html += '<div class="section-title">Available Agents</div>';
    available.forEach(agent => {
      html += renderAgentItem(agent, false);
    });
  }
  
  agentList.innerHTML = html;
  
  // Add click handlers
  agentList.querySelectorAll('.agent-item').forEach((item, index) => {
    item.addEventListener('click', () => selectAgent(index));
  });
}

function renderAgentItem(agent, installed) {
  return `
    <button class="agent-item" data-agent-name="${agent.name}" data-installed="${installed}">
      <div class="agent-header">
        <div class="emoji">
          ${agent.emoji || 'ü§ñ'}
          ${installed ? '<div class="installed-dot"></div>' : ''}
        </div>
        <div class="name">${agent.displayName || agent.name}</div>
      </div>
      <div class="tagline">${agent.title || agent.tagline || ''}</div>
    </button>
  `;
}

// Select an agent
function selectAgent(index) {
  // Update visual selection
  document.querySelectorAll('.agent-item').forEach((item, i) => {
    item.classList.toggle('selected', i === index);
    item.classList.remove('keyboard-focused');
  });
  selectedIndex = index;
  
  const agentItems = document.querySelectorAll('.agent-item');
  const selectedItem = agentItems[index];
  if (!selectedItem) return;
  
  const agentName = selectedItem.dataset.agentName;
  const isInstalled = selectedItem.dataset.installed === 'true';
  
  currentAgent = agents.find(a => a.name === agentName);
  if (!currentAgent) return;
  
  // Close mobile menu
  closeMobileMenu();
  
  // Show appropriate view
  if (isInstalled) {
    showChatView();
  } else {
    showAgentDetail();
  }
}

// Show agent detail view
function showAgentDetail() {
  currentView = 'detail';
  hideAllViews();
  
  const detailView = document.getElementById('agentDetail');
  detailView.innerHTML = `
    <div class="agent-hero">
      <div class="emoji">${currentAgent.emoji || 'ü§ñ'}</div>
      <h1>${currentAgent.displayName || currentAgent.name}</h1>
      <div class="tagline">${currentAgent.title || currentAgent.tagline || ''}</div>
      <div class="price">${typeof currentAgent.price === 'object' ? ('$' + currentAgent.price.amount + '/' + currentAgent.price.interval) : (currentAgent.price || 'FREE')}</div>
    </div>
    <div class="agent-sections">
      <div class="agent-section">
        <h3>Skills</h3>
        <div class="skills">
          ${(currentAgent.skills || []).map(skill => 
            `<div class="skill-tag">${skill}</div>`
          ).join('')}
        </div>
      </div>
      <div class="agent-section">
        <h3>Description</h3>
        <div class="description">${currentAgent.description || currentAgent.desc || 'No description available.'}</div>
      </div>
      <div class="agent-section">
        <h3>SOUL.md Preview</h3>
        <div class="soul-preview">${currentAgent.soul || 'Loading...'}</div>
      </div>
      <div class="install-section">
        <button class="install-button" onclick="installAgent()">Install Agent</button>
        <div class="install-command">
          <span>curl -fsSL raw.githubusercontent.com/h53674242-create/agent-arena/main/installer/install.sh | sh -s ${currentAgent.name}</span>
          <button class="copy-btn" onclick="copyInstallCommand()">Copy</button>
        </div>
      </div>
    </div>
  `;
  
  detailView.classList.add('active');
  
  // Load SOUL.md content
  loadSoulPreview();
}

// Load SOUL.md preview
async function loadSoulPreview() {
  try {
    const res = await fetch(`${LOCAL_SERVER}/api/agents/${currentAgent.name}`);
    const agentData = await res.json();
    const soulPreview = agentData.soul || 'No SOUL.md found for this agent.';
    
    const soulEl = document.querySelector('.soul-preview');
    if (soulEl) {
      soulEl.textContent = soulPreview.slice(0, 500) + (soulPreview.length > 500 ? '...' : '');
    }
  } catch (e) {
    console.error('Failed to load SOUL.md:', e);
  }
}

// Install agent
function installAgent() {
  const command = `curl -fsSL raw.githubusercontent.com/h53674242-create/agent-arena/main/installer/install.sh | sh -s ${currentAgent.name}`;
  
  if (navigator.clipboard) {
    navigator.clipboard.writeText(command);
    alert('Install command copied to clipboard! Run it in your terminal.');
  } else {
    prompt('Copy this command and run it in your terminal:', command);
  }
}

// Copy install command
function copyInstallCommand() {
  const command = `curl -fsSL raw.githubusercontent.com/h53674242-create/agent-arena/main/installer/install.sh | sh -s ${currentAgent.name}`;
  
  if (navigator.clipboard) {
    navigator.clipboard.writeText(command);
    document.querySelector('.copy-btn').textContent = 'Copied!';
    setTimeout(() => {
      const btn = document.querySelector('.copy-btn');
      if (btn) btn.textContent = 'Copy';
    }, 2000);
  }
}

// Show chat view
function showChatView() {
  currentView = 'chat';
  hideAllViews();
  
  const chatView = document.getElementById('chatView');
  chatView.classList.add('active');
  
  // Update header
  document.getElementById('chatAgentEmoji').textContent = currentAgent.emoji || 'ü§ñ';
  document.getElementById('chatAgentName').textContent = currentAgent.displayName || currentAgent.name;
  
  // Clear messages and load history
  const messages = document.getElementById('messages');
  messages.innerHTML = '';
  
  loadChatHistory();
  
  // Focus input
  document.getElementById('chatInput').focus();
}

// Load chat history
function loadChatHistory() {
  if (!currentAgent) return;
  
  const agentId = currentAgent.name.replace(/-agent$/, '');
  const savedMessages = localStorage.getItem(`chat-${agentId}`);
  
  if (savedMessages) {
    document.getElementById('messages').innerHTML = savedMessages;
    scrollToBottom();
  }
  
  // Load session key
  const savedSession = localStorage.getItem(`session-${agentId}`);
  if (savedSession) {
    sessions[currentAgent.name] = savedSession;
  }
}

// Save chat
function saveChatHistory() {
  if (!currentAgent) return;
  
  const agentId = currentAgent.name.replace(/-agent$/, '');
  const messagesHtml = document.getElementById('messages').innerHTML;
  localStorage.setItem(`chat-${agentId}`, messagesHtml);
  
  const sessionKey = sessions[currentAgent.name];
  if (sessionKey) {
    localStorage.setItem(`session-${agentId}`, sessionKey);
  }
}

// Show waitlist
function showWaitlist() {
  currentView = 'waitlist';
  hideAllViews();
  document.getElementById('waitlistView').classList.add('active');
  updateStatus(false);
}

// Hide all views
function hideAllViews() {
  document.getElementById('emptyState').style.display = 'none';
  document.getElementById('agentDetail').classList.remove('active');
  document.getElementById('chatView').classList.remove('active');
  document.getElementById('waitlistView').classList.remove('active');
}

// Connect WebSocket
function connectWebSocket() {
  if (ws && ws.readyState === WebSocket.OPEN) return;
  
  ws = new WebSocket(WS_URL);
  
  ws.onopen = () => {
    console.log('WebSocket connected');
    updateStatus(true);
  };
  
  ws.onclose = () => {
    console.log('WebSocket disconnected');
    updateStatus(false);
    setTimeout(connectWebSocket, 3000);
  };
  
  ws.onmessage = (event) => {
    try {
      const msg = JSON.parse(event.data);
      handleWebSocketMessage(msg);
    } catch (e) {
      console.error('WebSocket message error:', e);
    }
  };
  
  ws.onerror = (error) => {
    console.error('WebSocket error:', error);
  };
}

// Handle WebSocket messages
function handleWebSocketMessage(msg) {
  if (msg.type === 'status') {
    updateStatus(msg.connected);
  }
  
  if (msg.type === 'chat-delta') {
    handleChatDelta(msg);
  }
  
  if (msg.type === 'chat-final') {
    handleChatFinal(msg);
  }
  
  if (msg.type === 'error') {
    console.error('Server error:', msg.error);
  }
}

// Handle chat delta (streaming)
function handleChatDelta(msg) {
  if (currentView !== 'chat' || !currentAgent || msg.agentPkg !== currentAgent.name) return;
  
  const text = extractText(msg.message);
  if (text) {
    streamBuffers[msg.runId] = (streamBuffers[msg.runId] || '') + text;
    
    // Show typing indicator
    showTypingIndicator();
    
    // Save session key
    if (msg.sessionKey) {
      sessions[currentAgent.name] = msg.sessionKey;
    }
  }
}

// Handle chat final
function handleChatFinal(msg) {
  if (currentView !== 'chat' || !currentAgent || msg.agentPkg !== currentAgent.name) return;
  
  hideTypingIndicator();
  
  const text = streamBuffers[msg.runId] || extractText(msg.message);
  delete streamBuffers[msg.runId];
  
  if (text) {
    addMessage('agent', text);
    
    // Save session key
    if (msg.sessionKey) {
      sessions[currentAgent.name] = msg.sessionKey;
    }
    
    saveChatHistory();
  }
}

// Extract text from message
function extractText(message) {
  if (typeof message === 'string') return message;
  if (Array.isArray(message)) {
    return message.filter(p => p.type === 'text').map(p => p.text).join('');
  }
  if (message?.content) return extractText(message.content);
  return message?.text || '';
}

// Send message
function sendMessage() {
  const input = document.getElementById('chatInput');
  const text = input.value.trim();
  const sendBtn = document.getElementById('sendBtn');
  
  if (!text || !ws || ws.readyState !== WebSocket.OPEN || !currentAgent) return;
  
  input.value = '';
  sendBtn.disabled = true;
  
  // Add user message
  addMessage('user', text);
  
  // Send to WebSocket
  const agentId = currentAgent.name.replace(/-agent$/, '');
  const sessionKey = sessions[currentAgent.name] || null;
  
  ws.send(JSON.stringify({
    type: 'chat',
    agentPkg: currentAgent.name,
    message: text,
    sessionKey: sessionKey
  }));
  
  setTimeout(() => {
    sendBtn.disabled = false;
  }, 1000);
  
  saveChatHistory();
}

// Add message to chat
function addMessage(sender, text) {
  const messages = document.getElementById('messages');
  const message = document.createElement('div');
  message.className = `message ${sender}`;
  
  const senderName = sender === 'user' ? 'You' : (currentAgent?.displayName || 'Agent');
  const senderColor = sender === 'user' ? '' : `style="color: ${currentAgent?.color || '#fbbf24'}"`;
  
  message.innerHTML = `
    <div class="sender" ${senderColor}>${senderName}</div>
    ${escapeHtml(text).replace(/\n/g, '<br>')}
  `;
  
  messages.appendChild(message);
  scrollToBottom();
}

// Show/hide typing indicator
function showTypingIndicator() {
  const indicator = document.getElementById('typingIndicator');
  const text = document.getElementById('typingText');
  text.textContent = `${currentAgent?.displayName || 'Agent'} is typing...`;
  indicator.classList.add('active');
  scrollToBottom();
}

function hideTypingIndicator() {
  document.getElementById('typingIndicator').classList.remove('active');
}

// Scroll to bottom
function scrollToBottom() {
  const messages = document.getElementById('messages');
  messages.scrollTop = messages.scrollHeight;
}

// Update connection status
function updateStatus(connected) {
  const status = document.getElementById('status');
  status.textContent = connected ? '‚óè Online' : '‚óè Offline';
  status.className = `status ${connected ? 'online' : 'offline'}`;
}

// Mobile menu
function setupMobile() {
  const menuBtn = document.getElementById('mobileMenuBtn');
  const overlay = document.getElementById('mobileOverlay');
  const sidebar = document.getElementById('sidebar');
  
  menuBtn.addEventListener('click', () => {
    sidebar.classList.add('mobile-open');
    overlay.classList.add('active');
  });
  
  overlay.addEventListener('click', closeMobileMenu);
}

function closeMobileMenu() {
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('mobileOverlay');
  
  sidebar.classList.remove('mobile-open');
  overlay.classList.remove('active');
}

// Keyboard navigation
function setupKeyboardNavigation() {
  document.addEventListener('keydown', (e) => {
    // Only handle navigation when not typing in inputs
    if (e.target.tagName === 'INPUT') {
      if (e.key === 'Enter' && e.target.id === 'chatInput') {
        sendMessage();
      }
      return;
    }
    
    const agentItems = document.querySelectorAll('.agent-item');
    if (agentItems.length === 0) return;
    
    if (e.key === 'ArrowUp') {
      e.preventDefault();
      selectedIndex = Math.max(0, selectedIndex - 1);
      updateKeyboardSelection();
    } else if (e.key === 'ArrowDown') {
      e.preventDefault();
      selectedIndex = Math.min(agentItems.length - 1, selectedIndex + 1);
      updateKeyboardSelection();
    } else if (e.key === 'Enter' && selectedIndex >= 0) {
      e.preventDefault();
      selectAgent(selectedIndex);
    }
  });
}

function updateKeyboardSelection() {
  const agentItems = document.querySelectorAll('.agent-item');
  agentItems.forEach((item, index) => {
    item.classList.toggle('keyboard-focused', index === selectedIndex);
  });
  
  // Scroll into view
  if (agentItems[selectedIndex]) {
    agentItems[selectedIndex].scrollIntoView({ block: 'nearest' });
  }
}

// Waitlist submission
async function submitWaitlist() {
  const emailInput = document.getElementById('waitlistEmail');
  const email = emailInput.value.trim();
  
  if (!email || !email.includes('@')) {
    alert('Please enter a valid email address.');
    return;
  }
  
  try {
    // Try local server first
    await fetch('/api/waitlist', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        email: email,
        source: 'agent-arena-app',
        timestamp: new Date().toISOString()
      })
    });
  } catch (e) {
    // Fallback to external service or localStorage
    const waitlist = JSON.parse(localStorage.getItem('waitlist-emails') || '[]');
    waitlist.push({ email, timestamp: new Date().toISOString() });
    localStorage.setItem('waitlist-emails', JSON.stringify(waitlist));
  }
  
  // Show success
  document.getElementById('waitlistFormContent').style.display = 'none';
  document.getElementById('waitlistSuccess').classList.add('active');
}

// Utility functions
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Initialize app
init();
</script>

</body>
</html>