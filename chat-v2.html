<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0B0E13">
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ü§ù</text></svg>">
<title>HuddleClaw</title>
<link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiSHVkZGxlQ2xhdyIsInNob3J0X25hbWUiOiJIdWRkbGVDbGF3Iiwic3RhcnRfdXJsIjoiY2hhdC12Mi5odG1sIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiIzBCMEUxMyIsInRoZW1lX2NvbG9yIjoiIzBCMEUxMyJ9">
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0B0E13; --bg2: #0F1218; --surface: #151920; --surface2: #1B2028;
  --surface3: #222830; --border: #262D38; --border2: #333C4A;
  --text: #E4E8EE; --text2: #8892A0; --muted: #555E6E;
  --accent: #5B8DEF; --accent2: #7BA4F7; --accent-dim: rgba(91,141,239,0.10);
  --accent-glow: rgba(91,141,239,0.18);
  --green: #2DD4A8; --green-dim: rgba(45,212,168,0.10);
  --red: #EF6B6B; --red-dim: rgba(239,107,107,0.10);
  --orange: #F0A050; --orange-dim: rgba(240,160,80,0.10);
  --r: 12px; --r-sm: 8px; --r-lg: 16px;
  --safe-top: env(safe-area-inset-top, 0px);
  --safe-bottom: env(safe-area-inset-bottom, 0px);
  --tab-h: 56px;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%;overflow:hidden}
body{font-family:'Plus Jakarta Sans',system-ui,sans-serif;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
::selection{background:var(--accent-dim);color:var(--accent)}
input,button,textarea{font-family:inherit;border:none;outline:none}

/* ‚ïê‚ïê‚ïê Views ‚ïê‚ïê‚ïê */
.view{display:none;flex-direction:column;height:100%;position:absolute;inset:0}
.view.active{display:flex}

/* ‚ïê‚ïê‚ïê Onboarding ‚ïê‚ïê‚ïê */
#onboarding{display:flex;align-items:center;justify-content:center;background:var(--bg);padding:24px}
.onb-card{width:100%;max-width:380px;text-align:center}
.onb-logo{font-size:52px;margin-bottom:20px;animation:float 3s ease-in-out infinite}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
.onb-card h1{font-size:28px;font-weight:800;margin-bottom:8px;
  background:linear-gradient(135deg,var(--accent),var(--accent2),#A78BFA);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent}
.onb-card .sub{font-size:14px;color:var(--text2);line-height:1.6;margin-bottom:36px}
.onb-step{display:none;text-align:left}
.onb-step.active{display:block}
.onb-step label{display:block;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1.2px;color:var(--muted);margin-bottom:8px}
.onb-step input{width:100%;padding:14px 16px;border:1px solid var(--border);border-radius:var(--r);
  background:var(--surface);color:var(--text);font-size:14px;font-family:'JetBrains Mono',monospace;transition:border-color .15s}
.onb-step input:focus{border-color:var(--accent);box-shadow:0 0 0 2px var(--accent-glow)}
.onb-step input::placeholder{color:var(--muted)}
.onb-step .hint{font-size:11px;color:var(--muted);margin-top:8px;line-height:1.5}
.onb-step .hint code{font-family:'JetBrains Mono',monospace;font-size:10px;background:var(--surface2);padding:1px 5px;border-radius:4px}
.onb-actions{display:flex;gap:8px;margin-top:20px}
.btn-main{flex:1;padding:14px;border-radius:var(--r);font-size:14px;font-weight:700;cursor:pointer;transition:all .15s}
.btn-fill{background:var(--accent);color:#fff;border:none}
.btn-fill:hover{background:var(--accent2);transform:translateY(-1px);box-shadow:0 4px 16px var(--accent-glow)}
.btn-fill:disabled{opacity:.4;cursor:default;transform:none;box-shadow:none}
.btn-outline{background:none;border:1px solid var(--border);color:var(--text2)}
.btn-outline:hover{border-color:var(--text2);color:var(--text)}
.onb-error{color:var(--red);font-size:12px;margin-top:10px;min-height:18px}
.onb-dots{display:flex;justify-content:center;gap:8px;margin-top:24px}
.onb-dots .dot{width:8px;height:8px;border-radius:50%;background:var(--border);transition:all .2s}
.onb-dots .dot.active{background:var(--accent);width:24px;border-radius:4px}

/* Connecting animation */
.connecting-anim{display:none;text-align:center;padding:20px}
.connecting-anim.show{display:block}
.ca-dots{display:flex;justify-content:center;gap:6px;margin-bottom:12px}
.ca-dots span{width:10px;height:10px;border-radius:50%;background:var(--accent);animation:caAnim .6s ease-in-out infinite alternate}
.ca-dots span:nth-child(2){animation-delay:.2s}
.ca-dots span:nth-child(3){animation-delay:.4s}
@keyframes caAnim{from{opacity:.2;transform:scale(.8)}to{opacity:1;transform:scale(1)}}
.ca-text{font-size:13px;color:var(--text2)}

/* ‚ïê‚ïê‚ïê App Shell ‚ïê‚ïê‚ïê */
#app{background:var(--bg)}

/* Top bar (chat view) */
.topbar{display:flex;align-items:center;gap:12px;padding:12px 16px;
  border-bottom:1px solid var(--border);min-height:56px;flex-shrink:0;
  padding-top:max(12px, var(--safe-top));background:var(--bg)}
.topbar .tb-back{width:32px;height:32px;border-radius:var(--r-sm);background:none;
  color:var(--text2);font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.topbar .tb-back:hover{background:var(--surface);color:var(--text)}
.topbar .tb-avatar{width:36px;height:36px;border-radius:var(--r);background:var(--surface2);
  display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
.topbar .tb-info{flex:1;min-width:0}
.topbar .tb-name{font-size:15px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.topbar .tb-status{font-size:11px;display:flex;align-items:center;gap:4px}
.topbar .tb-status .dot{width:6px;height:6px;border-radius:50%;background:var(--green)}
.topbar .tb-status span{color:var(--text2)}
.topbar .tb-action{width:34px;height:34px;border-radius:var(--r-sm);background:none;
  color:var(--text2);cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;
  border:1px solid var(--border);transition:all .15s}
.topbar .tb-action:hover{border-color:var(--accent);color:var(--accent);background:var(--accent-dim)}

/* ‚ïê‚ïê‚ïê Tab Bar ‚ïê‚ïê‚ïê */
.tabbar{display:flex;border-top:1px solid var(--border);background:var(--bg2);flex-shrink:0;
  padding-bottom:var(--safe-bottom)}
.tabbar .tab{flex:1;display:flex;flex-direction:column;align-items:center;gap:3px;
  padding:8px 0;cursor:pointer;transition:color .15s;color:var(--muted);position:relative}
.tabbar .tab.active{color:var(--accent)}
.tabbar .tab .tab-icon{font-size:20px;height:24px;display:flex;align-items:center;justify-content:center}
.tabbar .tab .tab-label{font-size:10px;font-weight:700;letter-spacing:.5px}
.tabbar .tab .tab-badge{position:absolute;top:4px;right:50%;transform:translateX(14px);
  width:8px;height:8px;border-radius:50%;background:var(--accent);display:none}
.tabbar .tab .tab-badge.show{display:block}

/* ‚ïê‚ïê‚ïê Chats List ‚ïê‚ïê‚ïê */
.chats-list{flex:1;overflow-y:auto}
.cl-header{padding:20px 20px 12px;padding-top:max(20px, calc(var(--safe-top) + 12px))}
.cl-title{font-size:28px;font-weight:800;margin-bottom:12px}
.cl-search{display:flex;align-items:center;gap:8px;padding:10px 14px;
  background:var(--surface);border-radius:var(--r);border:1px solid transparent;transition:all .15s}
.cl-search:focus-within{border-color:var(--accent);box-shadow:0 0 0 2px var(--accent-glow)}
.cl-search .icon{color:var(--muted);font-size:14px}
.cl-search input{flex:1;background:none;color:var(--text);font-size:14px}
.cl-search input::placeholder{color:var(--muted)}

.chat-item{display:flex;align-items:center;gap:14px;padding:14px 20px;cursor:pointer;
  transition:background .1s;border-bottom:1px solid var(--border)}
.chat-item:hover{background:var(--surface)}
.chat-item:active{background:var(--surface2)}
.ci-avatar{width:48px;height:48px;border-radius:var(--r-lg);background:var(--surface2);
  display:flex;align-items:center;justify-content:center;font-size:24px;flex-shrink:0;position:relative}
.ci-avatar .ci-online{position:absolute;bottom:0;right:0;width:12px;height:12px;
  border-radius:50%;background:var(--green);border:2px solid var(--bg)}
.ci-body{flex:1;min-width:0}
.ci-top{display:flex;justify-content:space-between;align-items:baseline;gap:8px}
.ci-name{font-size:15px;font-weight:700}
.ci-time{font-size:11px;color:var(--muted);font-family:'JetBrains Mono',monospace;flex-shrink:0}
.ci-preview{font-size:13px;color:var(--text2);margin-top:2px;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.ci-unread{width:20px;height:20px;border-radius:50%;background:var(--accent);
  color:#fff;font-size:10px;font-weight:800;display:flex;align-items:center;justify-content:center;flex-shrink:0}

/* ‚ïê‚ïê‚ïê Chat View ‚ïê‚ïê‚ïê */
.chat-area{flex:1;overflow-y:auto;padding:12px 16px;display:flex;flex-direction:column}
.chat-area .spacer{flex:1}
.time-divider{text-align:center;padding:16px 0 8px;font-size:11px;color:var(--muted);font-weight:600}

.msg{display:flex;gap:10px;padding:4px 0;margin:2px 0;animation:msgIn .2s ease;max-width:100%}
@keyframes msgIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}
.msg.mine{flex-direction:row-reverse}
.msg .m-av{width:32px;height:32px;border-radius:var(--r-sm);background:var(--surface2);
  display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;margin-top:2px}
.msg.mine .m-av{display:none}
.msg .m-bubble{max-width:80%;min-width:60px}
.msg .m-head{display:flex;align-items:baseline;gap:6px;margin-bottom:2px}
.msg .m-name{font-size:12px;font-weight:700;color:var(--accent2)}
.msg .m-time{font-size:10px;color:var(--muted);font-family:'JetBrains Mono',monospace}
.msg.mine .m-head{flex-direction:row-reverse}
.msg.mine .m-name{color:var(--text2)}
.msg .m-content{padding:10px 14px;border-radius:var(--r-lg);font-size:14px;line-height:1.55;word-break:break-word}
.msg:not(.mine) .m-content{background:var(--surface);border-bottom-left-radius:4px}
.msg.mine .m-content{background:var(--accent);color:#fff;border-bottom-right-radius:4px}
.msg .m-content code{font-family:'JetBrains Mono',monospace;font-size:12px;padding:1px 5px;border-radius:4px}
.msg:not(.mine) .m-content code{background:var(--surface2)}
.msg.mine .m-content code{background:rgba(255,255,255,.15)}
.msg .m-content pre{margin:8px 0;padding:10px 12px;border-radius:var(--r-sm);overflow-x:auto;font-size:12px;line-height:1.5}
.msg:not(.mine) .m-content pre{background:var(--bg);border:1px solid var(--border)}
.msg.mine .m-content pre{background:rgba(0,0,0,.2)}
.msg .m-content pre code{background:none;padding:0}
.msg .m-content strong{font-weight:700}
.msg:not(.mine) .m-content strong{color:var(--accent2)}
.msg .m-content a{text-decoration:underline}
.msg:not(.mine) .m-content a{color:var(--accent2)}
.msg.mine .m-content a{color:#fff}
.msg .m-content ul,.msg .m-content ol{padding-left:18px;margin:4px 0}
.msg .m-content li{margin:2px 0}
.msg .m-content blockquote{border-left:3px solid;padding-left:10px;margin:6px 0;opacity:.8}
.msg .m-content h1,.msg .m-content h2,.msg .m-content h3{margin:10px 0 4px;font-size:14px;font-weight:700}

/* Typing */
.typing{padding:4px 16px 8px;min-height:24px;font-size:12px;color:var(--accent2);display:flex;align-items:center;gap:8px}
.typing-dots{display:flex;gap:3px}
.typing-dots span{width:6px;height:6px;border-radius:50%;background:var(--accent);animation:tdot .6s ease-in-out infinite alternate}
.typing-dots span:nth-child(2){animation-delay:.15s}
.typing-dots span:nth-child(3){animation-delay:.3s}
@keyframes tdot{from{opacity:.3;transform:translateY(0)}to{opacity:1;transform:translateY(-3px)}}

/* Input */
.chat-input{padding:8px 12px;border-top:1px solid var(--border);background:var(--bg);
  padding-bottom:max(8px, var(--safe-bottom));flex-shrink:0}
.ci-wrap{display:flex;align-items:flex-end;gap:6px;background:var(--surface);
  border:1px solid var(--border);border-radius:24px;padding:4px 4px 4px 16px;transition:border-color .15s}
.ci-wrap:focus-within{border-color:var(--accent);box-shadow:0 0 0 2px var(--accent-glow)}
.ci-wrap textarea{flex:1;background:none;color:var(--text);font-size:14px;resize:none;
  max-height:120px;padding:8px 0;line-height:1.4}
.ci-wrap textarea::placeholder{color:var(--muted)}
.ci-send{width:36px;height:36px;border-radius:50%;background:var(--accent);color:#fff;
  font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;
  transition:all .15s;flex-shrink:0;opacity:.3;transform:scale(.9)}
.ci-send.ready{opacity:1;transform:scale(1)}
.ci-send.ready:hover{background:var(--accent2);transform:scale(1.05)}
.ci-send:active{transform:scale(.92)}

/* ‚ïê‚ïê‚ïê Agents Tab ‚ïê‚ïê‚ïê */
.agents-view{flex:1;overflow-y:auto;padding:20px;padding-top:max(20px, calc(var(--safe-top) + 12px))}
.av-title{font-size:28px;font-weight:800;margin-bottom:4px}
.av-sub{font-size:13px;color:var(--text2);margin-bottom:20px}
.agent-card{display:flex;align-items:center;gap:14px;padding:16px;
  background:var(--surface);border:1px solid var(--border);border-radius:var(--r);
  margin-bottom:10px;cursor:pointer;transition:all .15s}
.agent-card:hover{border-color:var(--border2);transform:translateY(-1px)}
.agent-card:active{transform:translateY(0)}
.ac-avatar{width:48px;height:48px;border-radius:var(--r);background:var(--surface2);
  display:flex;align-items:center;justify-content:center;font-size:24px;flex-shrink:0}
.ac-info{flex:1;min-width:0}
.ac-name{font-size:15px;font-weight:700}
.ac-role{font-size:12px;color:var(--text2);margin-top:2px}
.ac-status{display:flex;align-items:center;gap:4px;font-size:11px;color:var(--green);margin-top:4px}
.ac-status .dot{width:6px;height:6px;border-radius:50%;background:var(--green)}
.ac-action{padding:8px 16px;border-radius:var(--r-sm);border:1px solid var(--border);
  background:none;color:var(--accent);font-size:12px;font-weight:700;cursor:pointer;transition:all .15s}
.ac-action:hover{background:var(--accent-dim);border-color:var(--accent)}

/* ‚ïê‚ïê‚ïê Settings Tab ‚ïê‚ïê‚ïê */
.settings-view{flex:1;overflow-y:auto;padding:20px;padding-top:max(20px, calc(var(--safe-top) + 12px))}
.sv-title{font-size:28px;font-weight:800;margin-bottom:20px}
.setting-group{margin-bottom:24px}
.sg-title{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1.2px;color:var(--muted);margin-bottom:10px}
.setting-item{display:flex;align-items:center;gap:14px;padding:14px 16px;
  background:var(--surface);border:1px solid var(--border);border-radius:var(--r);
  margin-bottom:6px;cursor:pointer;transition:all .15s}
.setting-item:hover{border-color:var(--border2)}
.setting-item:active{background:var(--surface2)}
.si-icon{font-size:18px;width:24px;text-align:center}
.si-info{flex:1}
.si-label{font-size:14px;font-weight:600}
.si-desc{font-size:11px;color:var(--muted);margin-top:2px}
.si-value{font-size:12px;color:var(--text2);font-family:'JetBrains Mono',monospace}
.si-arrow{color:var(--muted);font-size:14px}

.setting-item.danger{border-color:var(--red-dim)}
.setting-item.danger .si-label{color:var(--red)}
.setting-item.danger .si-icon{color:var(--red)}

/* ‚ïê‚ïê‚ïê Agent Profile Popup ‚ïê‚ïê‚ïê */
.profile-overlay{display:none;position:fixed;inset:0;z-index:200;background:rgba(0,0,0,.6);backdrop-filter:blur(4px);
  align-items:flex-end;justify-content:center}
.profile-overlay.open{display:flex}
.profile-sheet{width:100%;max-width:420px;background:var(--bg2);border-radius:var(--r-lg) var(--r-lg) 0 0;
  padding:24px;padding-bottom:max(24px, var(--safe-bottom));animation:sheetUp .25s ease}
@keyframes sheetUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.profile-sheet .ps-handle{width:40px;height:4px;border-radius:2px;background:var(--border);margin:0 auto 20px}
.profile-sheet .ps-avatar{width:64px;height:64px;border-radius:var(--r-lg);background:var(--surface2);
  display:flex;align-items:center;justify-content:center;font-size:32px;margin:0 auto 12px}
.profile-sheet .ps-name{text-align:center;font-size:20px;font-weight:800;margin-bottom:4px}
.profile-sheet .ps-id{text-align:center;font-size:12px;color:var(--muted);font-family:'JetBrains Mono',monospace;margin-bottom:16px}
.profile-sheet .ps-actions{display:flex;gap:8px}
.profile-sheet .ps-actions button{flex:1;padding:12px;border-radius:var(--r);font-size:13px;font-weight:700;cursor:pointer;transition:all .15s}

/* ‚ïê‚ïê‚ïê Desktop sidebar ‚ïê‚ïê‚ïê */
@media(min-width:769px){
  #app{flex-direction:row!important}
  .desktop-sidebar{display:flex!important;flex-direction:column;width:320px;border-right:1px solid var(--border);flex-shrink:0}
  .tabbar{display:none!important}
  .ds-header{padding:20px;border-bottom:1px solid var(--border)}
  .ds-brand{display:flex;align-items:center;gap:8px;margin-bottom:16px}
  .ds-brand h2{font-size:16px;font-weight:800;
    background:linear-gradient(135deg,var(--accent),var(--accent2));
    -webkit-background-clip:text;-webkit-text-fill-color:transparent}
  .ds-brand .dot{width:8px;height:8px;border-radius:50%;background:var(--green)}
  .ds-nav{display:flex;gap:4px;margin-bottom:12px}
  .ds-nav button{flex:1;padding:8px;border-radius:var(--r-sm);background:none;border:1px solid var(--border);
    color:var(--text2);font-size:12px;font-weight:700;cursor:pointer;transition:all .15s}
  .ds-nav button.active{background:var(--accent-dim);border-color:var(--accent);color:var(--accent)}
  .ds-nav button:hover{border-color:var(--accent)}
  .ds-list{flex:1;overflow-y:auto}
  .ds-footer{padding:12px 16px;border-top:1px solid var(--border);font-size:11px;color:var(--muted);
    display:flex;align-items:center;gap:6px;cursor:pointer}
  .ds-footer:hover{color:var(--text2)}
  .ds-footer code{font-family:'JetBrains Mono',monospace}

  /* Adjust main area */
  .main-area{flex:1;display:flex;flex-direction:column;min-width:0}
  .cl-header{display:none}
}
@media(max-width:768px){
  .desktop-sidebar{display:none!important}
  .main-area{width:100%}
}
</style>
</head>
<body>

<!-- Onboarding -->
<div class="view active" id="onboarding">
  <div class="onb-card">
    <div class="onb-logo">ü§ù</div>
    <h1>HuddleClaw</h1>
    <div class="sub">Chat with your AI agents from anywhere.</div>

    <div class="onb-step active" id="step0">
      <div style="text-align:center;margin-bottom:24px">
        <div style="font-size:40px;margin-bottom:12px">üöÄ</div>
        <div style="font-size:15px;font-weight:600;margin-bottom:8px">Connect your OpenClaw gateway</div>
        <div style="font-size:13px;color:var(--text2);line-height:1.6">Your agents live on your machine. HuddleClaw connects to them securely so you can chat from your phone, laptop, or anywhere.</div>
      </div>
      <div class="onb-actions"><button class="btn-main btn-fill" onclick="nextStep()">Get Started ‚Üí</button></div>
    </div>

    <div class="onb-step" id="step1">
      <label>Gateway URL</label>
      <input type="url" id="obUrl" placeholder="http://localhost:18789" spellcheck="false" autocomplete="url">
      <div class="hint">Usually <code>http://localhost:18789</code> if running locally</div>
      <div class="onb-actions" style="margin-top:16px">
        <button class="btn-main btn-outline" onclick="prevStep()">‚Üê</button>
        <button class="btn-main btn-fill" onclick="nextStep()">Next ‚Üí</button>
      </div>
    </div>

    <div class="onb-step" id="step2">
      <label>Gateway Token</label>
      <input type="password" id="obToken" placeholder="Paste your token" autocomplete="current-password">
      <div class="hint">Find it in <code>~/.openclaw/config.yaml</code> under <code>gateway.token</code></div>
      <div class="onb-actions" style="margin-top:16px">
        <button class="btn-main btn-outline" onclick="prevStep()">‚Üê</button>
        <button class="btn-main btn-fill" id="obConnect" onclick="doConnect()">Connect ‚Üí</button>
      </div>
    </div>

    <div class="connecting-anim" id="connectingAnim">
      <div class="ca-dots"><span></span><span></span><span></span></div>
      <div class="ca-text">Connecting to gateway...</div>
    </div>

    <div class="onb-error" id="obError"></div>
    <div class="onb-dots">
      <div class="dot active" id="dot0"></div>
      <div class="dot" id="dot1"></div>
      <div class="dot" id="dot2"></div>
    </div>
  </div>
</div>

<!-- App -->
<div class="view" id="app" style="flex-direction:column">
  <!-- Desktop sidebar -->
  <div class="desktop-sidebar">
    <div class="ds-header">
      <div class="ds-brand">
        <span class="dot"></span>
        <h2>HUDDLECLAW</h2>
      </div>
      <div class="cl-search">
        <span class="icon">üîç</span>
        <input type="text" placeholder="Search conversations..." id="dSearch" oninput="filterChats(this.value)">
      </div>
    </div>
    <div class="ds-list" id="dsList"></div>
    <div class="ds-footer" onclick="showSettings()">
      <span>‚öôÔ∏è</span> <span>Settings</span>
      <span style="flex:1"></span>
      <code id="dsUrl"></code>
    </div>
  </div>

  <!-- Main area -->
  <div class="main-area">
    <!-- Chats list (mobile) -->
    <div id="tabChats" style="display:flex;flex-direction:column;height:100%">
      <div class="chats-list" id="chatsList">
        <div class="cl-header">
          <div class="cl-title">Chats</div>
          <div class="cl-search">
            <span class="icon">üîç</span>
            <input type="text" placeholder="Search..." id="mSearch" oninput="filterChats(this.value)">
          </div>
        </div>
        <div id="mList"></div>
      </div>
    </div>

    <!-- Chat conversation -->
    <div id="tabChat" style="display:none;flex-direction:column;height:100%">
      <div class="topbar">
        <button class="tb-back" onclick="backToList()">‚Üê</button>
        <div class="tb-avatar" id="tbAvatar"></div>
        <div class="tb-info" onclick="showProfile()" style="cursor:pointer">
          <div class="tb-name" id="tbName"></div>
          <div class="tb-status"><div class="dot"></div><span>online</span></div>
        </div>
        <button class="tb-action" onclick="showProfile()">‚Ñπ</button>
      </div>
      <div class="chat-area" id="chatArea"><div class="spacer"></div></div>
      <div class="typing" id="typing"></div>
      <div class="chat-input">
        <div class="ci-wrap">
          <textarea id="msgInput" placeholder="Message..." rows="1"></textarea>
          <button class="ci-send" id="sendBtn" onclick="sendMsg()">‚Üë</button>
        </div>
      </div>
    </div>

    <!-- Agents tab (mobile) -->
    <div id="tabAgents" style="display:none;flex-direction:column;height:100%">
      <div class="agents-view" id="agentsView"></div>
    </div>

    <!-- Settings tab (mobile) -->
    <div id="tabSettings" style="display:none;flex-direction:column;height:100%">
      <div class="settings-view" id="settingsView"></div>
    </div>
  </div>

  <!-- Tab bar (mobile) -->
  <div class="tabbar">
    <div class="tab active" onclick="switchTab('Chats')" id="tabBtnChats">
      <div class="tab-icon">üí¨</div>
      <div class="tab-label">Chats</div>
      <div class="tab-badge" id="chatsBadge"></div>
    </div>
    <div class="tab" onclick="switchTab('Agents')" id="tabBtnAgents">
      <div class="tab-icon">ü§ñ</div>
      <div class="tab-label">Agents</div>
    </div>
    <div class="tab" onclick="switchTab('Settings')" id="tabBtnSettings">
      <div class="tab-icon">‚öôÔ∏è</div>
      <div class="tab-label">Settings</div>
    </div>
  </div>
</div>

<!-- Profile sheet -->
<div class="profile-overlay" id="profileOverlay" onclick="if(event.target===this)closeProfile()">
  <div class="profile-sheet" id="profileSheet">
    <div class="ps-handle"></div>
    <div class="ps-avatar" id="psAvatar"></div>
    <div class="ps-name" id="psName"></div>
    <div class="ps-id" id="psId"></div>
    <div class="ps-actions">
      <button class="btn-main btn-fill" onclick="closeProfile()">Done</button>
      <button class="btn-main btn-outline" style="color:var(--red);border-color:var(--red-dim)" onclick="clearChat()">Clear Chat</button>
    </div>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê State ‚ïê‚ïê‚ïê
let GW='',TOKEN='';
const AGENTS_MAP={main:{emoji:'ü¶û',name:'Hopper',role:'Product & Engineering'},creator:{emoji:'üìà',name:'Growth',role:'Distribution & Marketing'},founder:{emoji:'üî•',name:'Forge',role:'Code & Shipping'},devops:{emoji:'üîí',name:'DevOps',role:'Security & Infra'},sales:{emoji:'üí∞',name:'Sales',role:'Prospecting & CRM'}};
let agents=[];
let currentAgent=null;
let chats={};
let obStep=0;
let isStreaming=false;
let streamAbort=null;
let activeTab='Chats';

// ‚ïê‚ïê‚ïê Persistence ‚ïê‚ïê‚ïê
const save=(k,v)=>localStorage.setItem('hc2-'+k,JSON.stringify(v));
const load=(k,d)=>{try{return JSON.parse(localStorage.getItem('hc2-'+k))||d}catch{return d}};

// ‚ïê‚ïê‚ïê Init ‚ïê‚ïê‚ïê
function init(){
  chats=load('chats',{});
  setupInput();

  // Auto-connect if on localhost (server has token)
  if(location.hostname==='localhost'||location.hostname==='127.0.0.1'){
    GW='http://localhost:18789';TOKEN='';
    autoConnect();
    return;
  }
  const saved=load('conn',null);
  if(saved&&saved.url){GW=saved.url;TOKEN=saved.token||'';autoConnect();}
}

async function autoConnect(){
  try{
    const res=await fetch('/api/gateway/test',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({}),signal:AbortSignal.timeout(8000)});
    if(res.ok){
      agents=Object.keys(AGENTS_MAP);
      enterApp();return;
    }
  }catch{}
}

// ‚ïê‚ïê‚ïê Onboarding ‚ïê‚ïê‚ïê
function nextStep(){
  if(obStep===2)return doConnect();
  obStep++;showStep();
}
function prevStep(){obStep--;showStep();}
function showStep(){
  document.querySelectorAll('.onb-step').forEach((el,i)=>el.classList.toggle('active',i===obStep));
  document.querySelectorAll('.onb-dots .dot').forEach((el,i)=>el.classList.toggle('active',i===obStep));
  document.getElementById('obError').textContent='';
  if(obStep===1)document.getElementById('obUrl').focus();
  if(obStep===2)document.getElementById('obToken').focus();
}

async function doConnect(){
  const url=(document.getElementById('obUrl').value.trim()||'http://localhost:18789').replace(/\/+$/,'');
  const token=document.getElementById('obToken').value.trim();
  if(!token){document.getElementById('obError').textContent='Token is required';return;}

  GW=url;TOKEN=token;
  document.querySelectorAll('.onb-step').forEach(el=>el.classList.remove('active'));
  document.getElementById('connectingAnim').classList.add('show');
  document.getElementById('obError').textContent='';

  try{
    const res=await fetch('/api/gateway/test',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({gwUrl:GW,gwToken:TOKEN}),signal:AbortSignal.timeout(12000)});
    if(!res.ok)throw new Error('Connection failed');
    agents=Object.keys(AGENTS_MAP);
    save('conn',{url:GW,token:TOKEN});
    enterApp();
  }catch(e){
    document.getElementById('connectingAnim').classList.remove('show');
    document.getElementById('obError').textContent=e.message;
    obStep=2;showStep();
  }
}

function enterApp(){
  document.getElementById('onboarding').classList.remove('active');
  document.getElementById('app').classList.add('active');
  if(document.getElementById('dsUrl'))document.getElementById('dsUrl').textContent=GW.replace(/^https?:\/\//,'');
  renderChatsList();
  renderAgents();
  renderSettings();
  renderDesktopList();
}

// ‚ïê‚ïê‚ïê Tabs ‚ïê‚ïê‚ïê
function switchTab(tab){
  activeTab=tab;
  ['Chats','Agents','Settings'].forEach(t=>{
    const panel=document.getElementById('tab'+t);
    const btn=document.getElementById('tabBtn'+t);
    if(t===tab){panel.style.display='flex';btn?.classList.add('active')}
    else{panel.style.display='none';btn?.classList.remove('active')}
  });
  document.getElementById('tabChat').style.display='none';
  currentAgent=null;
}

function backToList(){
  document.getElementById('tabChat').style.display='none';
  document.getElementById('tabChats').style.display='flex';
  renderChatsList();
  renderDesktopList();
}

// ‚ïê‚ïê‚ïê Chat List ‚ïê‚ïê‚ïê
function renderChatsList(filter=''){
  const list=document.getElementById('mList');
  const fl=filter.toLowerCase();
  let html='';
  for(const id of agents){
    const a=AGENTS_MAP[id]||{emoji:'ü§ñ',name:id,role:''};
    if(fl&&!a.name.toLowerCase().includes(fl)&&!id.includes(fl))continue;
    const msgs=chats[id]||[];
    const last=msgs[msgs.length-1];
    const preview=last?truncate(last.text,50):'Tap to start chatting';
    const time=last?.time||'';
    html+=`<div class="chat-item" onclick="openChat('${id}')">
      <div class="ci-avatar">${a.emoji}<div class="ci-online"></div></div>
      <div class="ci-body">
        <div class="ci-top"><span class="ci-name">${esc(a.name)}</span><span class="ci-time">${time}</span></div>
        <div class="ci-preview">${esc(preview)}</div>
      </div>
    </div>`;
  }
  list.innerHTML=html;
}

function renderDesktopList(filter=''){
  const list=document.getElementById('dsList');
  if(!list)return;
  const fl=filter.toLowerCase();
  let html='';
  for(const id of agents){
    const a=AGENTS_MAP[id]||{emoji:'ü§ñ',name:id,role:''};
    if(fl&&!a.name.toLowerCase().includes(fl)&&!id.includes(fl))continue;
    const msgs=chats[id]||[];
    const last=msgs[msgs.length-1];
    const preview=last?truncate(last.text,40):'Start chatting';
    const time=last?.time||'';
    const isActive=currentAgent===id;
    html+=`<div class="chat-item${isActive?' style="background:var(--surface)"':''}" onclick="openChat('${id}')">
      <div class="ci-avatar" style="width:40px;height:40px;font-size:20px">${a.emoji}<div class="ci-online" style="width:10px;height:10px"></div></div>
      <div class="ci-body">
        <div class="ci-top"><span class="ci-name" style="font-size:14px">${esc(a.name)}</span><span class="ci-time">${time}</span></div>
        <div class="ci-preview">${esc(preview)}</div>
      </div>
    </div>`;
  }
  list.innerHTML=html;
}

function filterChats(v){renderChatsList(v);renderDesktopList(v);}

// ‚ïê‚ïê‚ïê Open Chat ‚ïê‚ïê‚ïê
function openChat(id){
  currentAgent=id;
  const a=AGENTS_MAP[id]||{emoji:'ü§ñ',name:id};

  // Mobile: hide list, show chat
  document.getElementById('tabChats').style.display='none';
  document.getElementById('tabChat').style.display='flex';

  document.getElementById('tbAvatar').textContent=a.emoji;
  document.getElementById('tbName').textContent=a.name;
  document.getElementById('msgInput').placeholder=`Message ${a.name}...`;

  renderMessages();
  renderDesktopList();

  if(window.innerWidth>768)document.getElementById('msgInput').focus();
}

function renderMessages(){
  const area=document.getElementById('chatArea');
  const msgs=chats[currentAgent]||[];

  if(!msgs.length){
    const a=AGENTS_MAP[currentAgent]||{emoji:'ü§ñ',name:currentAgent};
    area.innerHTML=`<div class="spacer"></div>
      <div style="text-align:center;padding:40px 20px;color:var(--muted)">
        <div style="font-size:40px;margin-bottom:12px">${a.emoji}</div>
        <div style="font-size:15px;font-weight:600;color:var(--text2);margin-bottom:6px">Chat with ${esc(a.name)}</div>
        <div style="font-size:13px;line-height:1.5">Full tool access ‚Ä¢ persistent memory ‚Ä¢ always on</div>
      </div>`;
    return;
  }

  let html='<div class="spacer"></div>';
  let lastDate='';
  for(const m of msgs){
    // Date divider
    const date=m.date||'';
    if(date&&date!==lastDate){html+=`<div class="time-divider">${date}</div>`;lastDate=date;}

    const isMine=m.role==='user';
    const a=AGENTS_MAP[currentAgent]||{emoji:'ü§ñ',name:currentAgent};
    html+=`<div class="msg${isMine?' mine':''}">
      <div class="m-av">${a.emoji}</div>
      <div class="m-bubble">
        <div class="m-head">
          <span class="m-name">${isMine?'You':esc(a.name)}</span>
          <span class="m-time">${m.time||''}</span>
        </div>
        <div class="m-content">${renderMd(m.text)}</div>
      </div>
    </div>`;
  }
  area.innerHTML=html;
  area.scrollTop=area.scrollHeight;
}

// ‚ïê‚ïê‚ïê Send ‚ïê‚ïê‚ïê
async function sendMsg(){
  const input=document.getElementById('msgInput');
  const text=input.value.trim();
  if(!text||!currentAgent||isStreaming)return;

  input.value='';input.style.height='auto';
  document.getElementById('sendBtn').classList.remove('ready');

  const now=new Date();
  const time=now.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
  const date=formatDate(now);
  addMsg(currentAgent,{role:'user',text,time,date});
  renderMessages();

  // Build history
  const history=(chats[currentAgent]||[]).filter(m=>m.role).slice(-20).map(m=>({role:m.role==='user'?'user':'assistant',content:m.text}));

  isStreaming=true;
  showTyping();

  try{
    const ctrl=new AbortController();streamAbort=ctrl;
    const res=await fetch('/api/gateway/chat',{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({agentId:currentAgent,model:`openclaw:${currentAgent}`,messages:history,stream:true}),
      signal:ctrl.signal
    });
    if(!res.ok)throw new Error(`Error ${res.status}`);

    const reader=res.body.getReader();const dec=new TextDecoder();
    let buf='',full='';
    while(true){
      const{done,value}=await reader.read();if(done)break;
      buf+=dec.decode(value,{stream:true});
      const lines=buf.split('\n');buf=lines.pop()||'';
      for(const line of lines){
        if(!line.startsWith('data: '))continue;
        const d=line.slice(6).trim();if(d==='[DONE]')continue;
        try{const c=JSON.parse(d);const delta=c.choices?.[0]?.delta?.content;
          if(delta){full+=delta;updateStreaming(full);}
        }catch{}
      }
    }
    hideTyping();
    if(full){
      removeStreaming();
      const t2=new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
      addMsg(currentAgent,{role:'assistant',text:full,time:t2,date:formatDate(new Date())});
      renderMessages();
    }
  }catch(e){
    hideTyping();removeStreaming();
    if(e.name!=='AbortError'){
      addMsg(currentAgent,{role:'system',text:'Error: '+e.message,time:'',date:''});renderMessages();
    }
  }finally{isStreaming=false;streamAbort=null;document.getElementById('msgInput').focus();}
}

function updateStreaming(text){
  if(!currentAgent)return;
  const area=document.getElementById('chatArea');
  let el=document.getElementById('stream-msg');
  const a=AGENTS_MAP[currentAgent]||{emoji:'ü§ñ',name:currentAgent};
  if(!el){
    const div=document.createElement('div');div.className='msg';div.id='stream-msg';
    div.innerHTML=`<div class="m-av">${a.emoji}</div><div class="m-bubble"><div class="m-head"><span class="m-name">${esc(a.name)}</span></div><div class="m-content" id="stream-text"></div></div>`;
    area.appendChild(div);
  }
  document.getElementById('stream-text').innerHTML=renderMd(text);
  area.scrollTop=area.scrollHeight;
}
function removeStreaming(){const el=document.getElementById('stream-msg');if(el)el.remove();}

// ‚ïê‚ïê‚ïê Messages ‚ïê‚ïê‚ïê
function addMsg(id,msg){if(!chats[id])chats[id]=[];chats[id].push(msg);if(chats[id].length>300)chats[id]=chats[id].slice(-300);save('chats',chats);}

function showTyping(){
  const a=AGENTS_MAP[currentAgent]||{name:'Agent'};
  document.getElementById('typing').innerHTML=`<div class="typing-dots"><span></span><span></span><span></span></div>${a.name} is thinking...`;
}
function hideTyping(){document.getElementById('typing').innerHTML='';}

// ‚ïê‚ïê‚ïê Agents Tab ‚ïê‚ïê‚ïê
function renderAgents(){
  const view=document.getElementById('agentsView');
  let html='<div class="av-title">Your Agents</div><div class="av-sub">All agents connected via your OpenClaw gateway</div>';
  for(const id of agents){
    const a=AGENTS_MAP[id]||{emoji:'ü§ñ',name:id,role:''};
    html+=`<div class="agent-card" onclick="openChat('${id}');switchTab('Chats')">
      <div class="ac-avatar">${a.emoji}</div>
      <div class="ac-info">
        <div class="ac-name">${esc(a.name)}</div>
        <div class="ac-role">${esc(a.role)}</div>
        <div class="ac-status"><div class="dot"></div>Online</div>
      </div>
      <button class="ac-action">Chat ‚Üí</button>
    </div>`;
  }
  view.innerHTML=html;
}

// ‚ïê‚ïê‚ïê Settings ‚ïê‚ïê‚ïê
function renderSettings(){
  const view=document.getElementById('settingsView');
  view.innerHTML=`<div class="sv-title">Settings</div>
    <div class="setting-group"><div class="sg-title">Connection</div>
      <div class="setting-item"><div class="si-icon">üîå</div><div class="si-info"><div class="si-label">Gateway</div><div class="si-desc">${esc(GW.replace(/^https?:\/\//,''))}</div></div><div class="si-value" style="color:var(--green)">Connected</div></div>
      <div class="setting-item" onclick="disconnect()"><div class="si-icon">üö™</div><div class="si-info"><div class="si-label">Disconnect</div><div class="si-desc">Switch to a different gateway</div></div><div class="si-arrow">‚Üí</div></div>
    </div>
    <div class="setting-group"><div class="sg-title">Data</div>
      <div class="setting-item danger" onclick="clearAllChats()"><div class="si-icon">üóë</div><div class="si-info"><div class="si-label">Clear All Chats</div><div class="si-desc">Delete all conversation history</div></div></div>
    </div>
    <div class="setting-group"><div class="sg-title">About</div>
      <div class="setting-item"><div class="si-icon">ü§ù</div><div class="si-info"><div class="si-label">HuddleClaw</div><div class="si-desc">Chat with your AI agents from anywhere</div></div><div class="si-value">v2.0</div></div>
    </div>`;
}

function disconnect(){
  localStorage.removeItem('hc2-conn');GW='';TOKEN='';
  document.getElementById('app').classList.remove('active');
  document.getElementById('onboarding').classList.add('active');
  obStep=0;showStep();
}

function clearAllChats(){
  if(!confirm('Delete all chat history?'))return;
  chats={};save('chats',chats);renderChatsList();renderDesktopList();
  if(currentAgent)renderMessages();
}

function clearChat(){
  if(!currentAgent)return;
  if(!confirm('Clear this conversation?'))return;
  delete chats[currentAgent];save('chats',chats);
  renderMessages();closeProfile();renderChatsList();renderDesktopList();
}

// ‚ïê‚ïê‚ïê Profile ‚ïê‚ïê‚ïê
function showProfile(){
  if(!currentAgent)return;
  const a=AGENTS_MAP[currentAgent]||{emoji:'ü§ñ',name:currentAgent};
  document.getElementById('psAvatar').textContent=a.emoji;
  document.getElementById('psName').textContent=a.name;
  document.getElementById('psId').textContent=currentAgent;
  document.getElementById('profileOverlay').classList.add('open');
}
function closeProfile(){document.getElementById('profileOverlay').classList.remove('open');}

function showSettings(){switchTab('Settings');}

// ‚ïê‚ïê‚ïê Input ‚ïê‚ïê‚ïê
function setupInput(){
  const input=document.getElementById('msgInput');
  input.addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMsg();}});
  input.addEventListener('input',()=>{
    input.style.height='auto';input.style.height=Math.min(input.scrollHeight,120)+'px';
    document.getElementById('sendBtn').classList.toggle('ready',!!input.value.trim());
  });
}

// ‚ïê‚ïê‚ïê Markdown ‚ïê‚ïê‚ïê
function renderMd(t){
  if(!t)return'';let h=esc(t);
  h=h.replace(/```(\w*)\n([\s\S]*?)```/g,(_,l,c)=>`<pre><code>${c.trim()}</code></pre>`);
  h=h.replace(/`([^`]+)`/g,'<code>$1</code>');
  h=h.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>');
  h=h.replace(/\*(.*?)\*/g,'<em>$1</em>');
  h=h.replace(/^### (.+)$/gm,'<h3>$1</h3>');
  h=h.replace(/^## (.+)$/gm,'<h2>$1</h2>');
  h=h.replace(/^# (.+)$/gm,'<h1>$1</h1>');
  h=h.replace(/^- (.+)$/gm,'<li>$1</li>');
  h=h.replace(/(<li>.*<\/li>)/gs,'<ul>$1</ul>');
  h=h.replace(/^&gt; (.+)$/gm,'<blockquote>$1</blockquote>');
  h=h.replace(/(https?:\/\/[^\s<]+)/g,'<a href="$1" target="_blank" rel="noopener">$1</a>');
  h=h.replace(/\n/g,'<br>');
  return h;
}

// ‚ïê‚ïê‚ïê Helpers ‚ïê‚ïê‚ïê
function esc(t){const d=document.createElement('div');d.textContent=t||'';return d.innerHTML;}
function truncate(s,n){return s&&s.length>n?s.slice(0,n)+'‚Ä¶':s||'';}
function formatDate(d){
  const today=new Date();const y=new Date(today);y.setDate(y.getDate()-1);
  if(d.toDateString()===today.toDateString())return'Today';
  if(d.toDateString()===y.toDateString())return'Yesterday';
  return d.toLocaleDateString([],{month:'short',day:'numeric'});
}

// ‚ïê‚ïê‚ïê Go ‚ïê‚ïê‚ïê
init();
</script>
</body>
</html>
