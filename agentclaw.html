<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#0C1117">
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üè†</text></svg>">
<title>AgentClaw ‚Äî AI Outbound for Real Estate</title>
<link href="https://fonts.googleapis.com/css2?family=Instrument+Serif&family=Satoshi:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0C1117; --bg2: #111820; --surface: #161D26; --surface2: #1C2530;
  --surface3: #222D3A; --border: #2A3544; --border2: #354354;
  --text: #E8ECF0; --text2: #8B98A8; --muted: #576270;
  --warm: #E8A838; --warm2: #F0C060; --warm-dim: rgba(232,168,56,0.10);
  --warm-glow: rgba(232,168,56,0.20);
  --green: #34D399; --green-dim: rgba(52,211,153,0.10);
  --red: #F87171; --red-dim: rgba(248,113,113,0.10);
  --blue: #60A5FA; --blue-dim: rgba(96,165,250,0.10);
  --r: 12px; --r-sm: 8px; --r-lg: 16px; --r-xl: 20px;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html{height:100%;overflow-x:hidden}
body{font-family:'Satoshi',system-ui,sans-serif;background:var(--bg);color:var(--text);min-height:100%;-webkit-font-smoothing:antialiased}
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
::selection{background:var(--warm-dim);color:var(--warm)}
input,button,textarea,select{font-family:inherit}
a{color:var(--warm2);text-decoration:none}

/* Grain overlay */
body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:9999;
  background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
  opacity:0.025;mix-blend-mode:overlay}

/* ‚ïê‚ïê‚ïê Layout ‚ïê‚ïê‚ïê */
.container{max-width:1100px;margin:0 auto;padding:0 20px}

/* ‚ïê‚ïê‚ïê Header ‚ïê‚ïê‚ïê */
header{padding:24px 0 0;position:sticky;top:0;z-index:50;background:var(--bg);
  border-bottom:1px solid transparent;transition:border-color .3s}
header.scrolled{border-bottom-color:var(--border)}
.header-inner{display:flex;align-items:center;gap:16px;padding-bottom:20px}
.brand{display:flex;align-items:center;gap:10px;flex:1}
.brand-icon{font-size:24px}
.brand h1{font-family:'Instrument Serif',Georgia,serif;font-size:22px;font-weight:400;
  background:linear-gradient(135deg,var(--warm),var(--warm2));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent}
.header-actions{display:flex;gap:8px}
.btn-ghost{padding:8px 16px;border:1px solid var(--border);border-radius:var(--r-sm);
  background:none;color:var(--text2);font-size:13px;font-weight:600;cursor:pointer;transition:all .15s}
.btn-ghost:hover{border-color:var(--warm);color:var(--warm);background:var(--warm-dim)}

/* ‚ïê‚ïê‚ïê Stats Bar ‚ïê‚ïê‚ïê */
.stats{display:flex;gap:12px;padding:16px 0;overflow-x:auto;-webkit-overflow-scrolling:touch}
.stat-card{flex:1;min-width:140px;background:var(--surface);border:1px solid var(--border);
  border-radius:var(--r);padding:16px;transition:all .2s}
.stat-card:hover{border-color:var(--border2);transform:translateY(-1px)}
.stat-label{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1.2px;color:var(--muted);margin-bottom:6px}
.stat-value{font-family:'JetBrains Mono',monospace;font-size:28px;font-weight:700;color:var(--text)}
.stat-value .unit{font-size:14px;color:var(--text2);font-weight:500;margin-left:2px}
.stat-card.warm .stat-value{color:var(--warm)}
.stat-card.green .stat-value{color:var(--green)}
.stat-card.blue .stat-value{color:var(--blue)}

/* ‚ïê‚ïê‚ïê Upload Zone ‚ïê‚ïê‚ïê */
.upload-zone{margin:20px 0;border:2px dashed var(--border);border-radius:var(--r-lg);
  padding:48px 24px;text-align:center;cursor:pointer;transition:all .25s;position:relative;overflow:hidden}
.upload-zone::before{content:'';position:absolute;inset:0;
  background:radial-gradient(ellipse at center,var(--warm-dim) 0%,transparent 70%);opacity:0;transition:opacity .3s}
.upload-zone:hover{border-color:var(--warm);background:var(--warm-dim)}
.upload-zone:hover::before{opacity:1}
.upload-zone.dragover{border-color:var(--warm);background:var(--warm-dim);transform:scale(1.01)}
.upload-zone.dragover::before{opacity:1}
.upload-zone.has-data{display:none}
.uz-icon{font-size:40px;margin-bottom:12px;position:relative;z-index:1}
.uz-title{font-size:17px;font-weight:700;margin-bottom:6px;position:relative;z-index:1}
.uz-sub{font-size:13px;color:var(--text2);line-height:1.5;position:relative;z-index:1}
.uz-sub code{font-family:'JetBrains Mono',monospace;font-size:11px;background:var(--surface2);padding:2px 6px;border-radius:4px}
.upload-zone input[type=file]{display:none}

/* ‚ïê‚ïê‚ïê Lead Cards ‚ïê‚ïê‚ïê */
.leads-section{margin:24px 0}
.leads-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
.leads-title{font-family:'Instrument Serif',Georgia,serif;font-size:20px}
.leads-count{font-size:12px;color:var(--muted);font-family:'JetBrains Mono',monospace}
.leads-grid{display:grid;grid-template-columns:1fr;gap:12px}

.lead-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);
  padding:18px 20px;cursor:pointer;transition:all .2s;position:relative;overflow:hidden}
.lead-card:hover{border-color:var(--border2);transform:translateY(-1px);box-shadow:0 4px 20px rgba(0,0,0,.3)}
.lead-card.active{border-color:var(--warm);box-shadow:0 0 0 1px var(--warm),0 4px 20px rgba(232,168,56,.1)}
.lead-card .lc-top{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-bottom:10px}
.lead-card .lc-name{font-size:16px;font-weight:700}
.lead-card .lc-status{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;
  padding:4px 10px;border-radius:20px;white-space:nowrap;flex-shrink:0}
.lc-status.foreclosure{background:var(--red-dim);color:var(--red)}
.lc-status.expired{background:rgba(255,169,77,.1);color:#FFA94D}
.lc-status.fsbo{background:var(--blue-dim);color:var(--blue)}
.lc-status.default{background:var(--surface2);color:var(--text2)}
.lead-card .lc-address{font-size:13px;color:var(--text2);margin-bottom:8px;display:flex;align-items:center;gap:6px}
.lead-card .lc-address::before{content:'üìç';font-size:12px}
.lead-card .lc-meta{display:flex;gap:16px;font-size:11px;color:var(--muted)}
.lead-card .lc-meta span{display:flex;align-items:center;gap:4px}
.lead-card .lc-enriched{margin-top:10px;padding-top:10px;border-top:1px solid var(--border);font-size:12px;color:var(--text2);line-height:1.5}
.lead-card .lc-actions{display:flex;gap:8px;margin-top:12px}

.badge{display:inline-flex;align-items:center;gap:4px;font-size:10px;font-weight:600;
  padding:3px 8px;border-radius:12px}
.badge.enriched{background:var(--green-dim);color:var(--green)}
.badge.drafted{background:var(--warm-dim);color:var(--warm)}
.badge.sent{background:var(--blue-dim);color:var(--blue)}

/* ‚ïê‚ïê‚ïê Detail Panel (slide-in) ‚ïê‚ïê‚ïê */
.detail-overlay{display:none;position:fixed;inset:0;z-index:200;background:rgba(0,0,0,.6);backdrop-filter:blur(4px)}
.detail-overlay.open{display:flex;justify-content:flex-end}
.detail-panel{width:100%;max-width:560px;background:var(--bg2);border-left:1px solid var(--border);
  overflow-y:auto;animation:slideIn .25s cubic-bezier(.4,0,.2,1)}
@keyframes slideIn{from{transform:translateX(100%)}to{transform:translateX(0)}}

.dp-header{padding:20px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px;position:sticky;top:0;background:var(--bg2);z-index:1}
.dp-close{width:36px;height:36px;border:1px solid var(--border);border-radius:var(--r-sm);
  background:none;color:var(--text2);font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s}
.dp-close:hover{border-color:var(--red);color:var(--red);background:var(--red-dim)}
.dp-title{flex:1;font-size:18px;font-weight:700}

.dp-section{padding:20px 24px;border-bottom:1px solid var(--border)}
.dp-section-title{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1.2px;color:var(--muted);margin-bottom:12px}

.dp-field{margin-bottom:12px}
.dp-field label{display:block;font-size:11px;font-weight:600;color:var(--text2);margin-bottom:4px}
.dp-field .val{font-size:14px;color:var(--text)}

/* Enrich button */
.btn-enrich{width:100%;padding:14px;border:1px solid var(--warm);border-radius:var(--r);
  background:var(--warm-dim);color:var(--warm);font-size:14px;font-weight:700;cursor:pointer;transition:all .15s}
.btn-enrich:hover{background:var(--warm);color:var(--bg);box-shadow:0 4px 20px var(--warm-glow)}
.btn-enrich:disabled{opacity:.4;cursor:default;background:var(--warm-dim);color:var(--warm)}
.btn-enrich.loading{pointer-events:none}
.btn-enrich.loading::after{content:'';display:inline-block;width:14px;height:14px;border:2px solid currentColor;
  border-top-color:transparent;border-radius:50%;animation:spin .6s linear infinite;margin-left:8px;vertical-align:middle}
@keyframes spin{to{transform:rotate(360deg)}}

/* Email editor */
.email-editor{margin-top:4px}
.email-editor textarea{width:100%;min-height:200px;padding:16px;border:1px solid var(--border);border-radius:var(--r);
  background:var(--surface);color:var(--text);font-size:14px;line-height:1.6;resize:vertical;outline:none;transition:border-color .15s}
.email-editor textarea:focus{border-color:var(--warm);box-shadow:0 0 0 2px var(--warm-glow)}
.email-editor textarea::placeholder{color:var(--muted)}

.email-actions{display:flex;gap:8px;margin-top:12px}
.btn-primary{padding:12px 24px;border:none;border-radius:var(--r);
  background:linear-gradient(135deg,var(--warm),var(--warm2));color:var(--bg);
  font-size:14px;font-weight:700;cursor:pointer;transition:all .15s}
.btn-primary:hover{transform:translateY(-1px);box-shadow:0 4px 20px var(--warm-glow)}
.btn-primary:disabled{opacity:.4;cursor:default;transform:none;box-shadow:none}
.btn-secondary{padding:12px 24px;border:1px solid var(--border);border-radius:var(--r);
  background:none;color:var(--text2);font-size:14px;font-weight:600;cursor:pointer;transition:all .15s}
.btn-secondary:hover{border-color:var(--text2);color:var(--text)}

/* ‚ïê‚ïê‚ïê Empty state ‚ïê‚ïê‚ïê */
.empty{text-align:center;padding:60px 20px;color:var(--muted)}
.empty .e-icon{font-size:48px;margin-bottom:16px;opacity:.5}
.empty .e-title{font-size:17px;font-weight:700;color:var(--text2);margin-bottom:8px}
.empty .e-sub{font-size:13px;line-height:1.6;max-width:360px;margin:0 auto}

/* ‚ïê‚ïê‚ïê Toast ‚ïê‚ïê‚ïê */
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(100px);
  background:var(--surface2);border:1px solid var(--border);border-radius:var(--r);
  padding:12px 20px;font-size:13px;font-weight:600;z-index:999;transition:transform .3s cubic-bezier(.4,0,.2,1);
  box-shadow:0 8px 30px rgba(0,0,0,.4);display:flex;align-items:center;gap:8px}
.toast.show{transform:translateX(-50%) translateY(0)}
.toast.success{border-color:var(--green);color:var(--green)}
.toast.error{border-color:var(--red);color:var(--red)}

/* ‚ïê‚ïê‚ïê Mobile ‚ïê‚ïê‚ïê */
@media(max-width:640px){
  .container{padding:0 14px}
  header{padding:16px 0 0}
  .brand h1{font-size:19px}
  .stats{gap:8px}
  .stat-card{padding:12px;min-width:110px}
  .stat-value{font-size:22px}
  .upload-zone{padding:32px 16px}
  .detail-panel{max-width:100%}
  .dp-header{padding:16px}
  .dp-section{padding:16px}
}

/* ‚ïê‚ïê‚ïê Animations ‚ïê‚ïê‚ïê */
.fade-in{animation:fadeIn .4s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.stagger-1{animation-delay:.05s}
.stagger-2{animation-delay:.1s}
.stagger-3{animation-delay:.15s}
.stagger-4{animation-delay:.2s}
</style>
</head>
<body>

<header id="header">
  <div class="container header-inner">
    <div class="brand">
      <span class="brand-icon">üè†</span>
      <h1>AgentClaw</h1>
    </div>
    <div class="header-actions">
      <button class="btn-ghost" onclick="document.getElementById('csvInput').click()">+ Import CSV</button>
      <button class="btn-ghost" onclick="clearAll()">Clear</button>
    </div>
  </div>
</header>

<div class="container">
  <!-- Stats -->
  <div class="stats" id="stats">
    <div class="stat-card"><div class="stat-label">Total Leads</div><div class="stat-value" id="statTotal">0</div></div>
    <div class="stat-card warm"><div class="stat-label">Enriched</div><div class="stat-value" id="statEnriched">0</div></div>
    <div class="stat-card green"><div class="stat-label">Drafted</div><div class="stat-value" id="statDrafted">0</div></div>
    <div class="stat-card blue"><div class="stat-label">Sent</div><div class="stat-value" id="statSent">0</div></div>
  </div>

  <!-- Upload Zone -->
  <div class="upload-zone" id="uploadZone" onclick="document.getElementById('csvInput').click()">
    <div class="uz-icon">üìã</div>
    <div class="uz-title">Drop your lead list here</div>
    <div class="uz-sub">
      CSV with columns like <code>name</code> <code>email</code> <code>address</code> <code>status</code> <code>notes</code><br>
      We'll match columns automatically ‚Äî don't worry about exact names
    </div>
    <input type="file" id="csvInput" accept=".csv,.tsv,.txt" onchange="handleFile(event)">
  </div>

  <!-- Leads -->
  <div class="leads-section" id="leadsSection" style="display:none">
    <div class="leads-header">
      <div class="leads-title">Your Leads</div>
      <div class="leads-count" id="leadsCount"></div>
    </div>
    <div class="leads-grid" id="leadsGrid"></div>
  </div>

  <!-- Empty state (no leads yet) -->
  <div class="empty" id="emptyState">
    <div class="e-icon">üè°</div>
    <div class="e-title">No leads yet</div>
    <div class="e-sub">Upload a CSV of property leads ‚Äî foreclosures, expired listings, FSBOs, whatever you've got. AI will enrich each one and draft personalized outreach emails.</div>
  </div>
</div>

<!-- Detail Overlay -->
<div class="detail-overlay" id="detailOverlay" onclick="if(event.target===this)closeDetail()">
  <div class="detail-panel" id="detailPanel"></div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê State ‚ïê‚ïê‚ïê
let leads = []; // [{id, name, email, address, status, notes, enrichment, emailDraft, sent}]

// ‚ïê‚ïê‚ïê CSV Parsing ‚ïê‚ïê‚ïê
function handleFile(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (ev) => parseCSV(ev.target.result);
  reader.readAsText(file);
  e.target.value = '';
}

// Drag & drop
const uz = document.getElementById('uploadZone');
uz.addEventListener('dragover', e => { e.preventDefault(); uz.classList.add('dragover'); });
uz.addEventListener('dragleave', () => uz.classList.remove('dragover'));
uz.addEventListener('drop', e => {
  e.preventDefault(); uz.classList.remove('dragover');
  const file = e.dataTransfer.files[0];
  if (file) { const r = new FileReader(); r.onload = ev => parseCSV(ev.target.result); r.readAsText(file); }
});

function parseCSV(text) {
  const lines = text.trim().split('\n');
  if (lines.length < 2) { showToast('CSV needs a header row + at least one data row', 'error'); return; }

  const sep = lines[0].includes('\t') ? '\t' : ',';
  const headers = parseCSVLine(lines[0], sep).map(h => h.toLowerCase().trim());

  // Smart column matching
  const colMap = {
    name: findCol(headers, ['name', 'owner', 'contact', 'full_name', 'fullname', 'owner_name']),
    email: findCol(headers, ['email', 'mail', 'email_address', 'contact_email']),
    address: findCol(headers, ['address', 'property', 'property_address', 'street', 'location']),
    status: findCol(headers, ['status', 'type', 'property_status', 'listing_status', 'category']),
    notes: findCol(headers, ['notes', 'comments', 'description', 'details', 'info']),
    phone: findCol(headers, ['phone', 'tel', 'telephone', 'mobile', 'cell']),
    price: findCol(headers, ['price', 'value', 'asking_price', 'list_price', 'amount']),
  };

  const newLeads = [];
  for (let i = 1; i < lines.length; i++) {
    const vals = parseCSVLine(lines[i], sep);
    if (vals.length < 2) continue;
    const lead = {
      id: crypto.randomUUID(),
      name: getVal(vals, colMap.name) || `Lead ${i}`,
      email: getVal(vals, colMap.email) || '',
      address: getVal(vals, colMap.address) || '',
      status: getVal(vals, colMap.status) || '',
      notes: getVal(vals, colMap.notes) || '',
      phone: getVal(vals, colMap.phone) || '',
      price: getVal(vals, colMap.price) || '',
      enrichment: null,
      emailDraft: '',
      sent: false,
      raw: {}
    };
    // Store all raw values
    headers.forEach((h, idx) => { if (vals[idx]) lead.raw[h] = vals[idx]; });
    newLeads.push(lead);
  }

  if (newLeads.length === 0) { showToast('No valid rows found in CSV', 'error'); return; }

  leads = [...leads, ...newLeads];
  saveLeads();
  render();
  showToast(`${newLeads.length} leads imported`, 'success');
}

function parseCSVLine(line, sep) {
  const result = [];
  let current = '';
  let inQuote = false;
  for (const ch of line) {
    if (ch === '"') { inQuote = !inQuote; }
    else if (ch === sep && !inQuote) { result.push(current.trim()); current = ''; }
    else { current += ch; }
  }
  result.push(current.trim());
  return result;
}

function findCol(headers, candidates) {
  for (const c of candidates) {
    const idx = headers.indexOf(c);
    if (idx >= 0) return idx;
  }
  // Fuzzy match
  for (const c of candidates) {
    const idx = headers.findIndex(h => h.includes(c) || c.includes(h));
    if (idx >= 0) return idx;
  }
  return -1;
}

function getVal(vals, idx) { return idx >= 0 && vals[idx] ? vals[idx].replace(/^["']|["']$/g, '').trim() : ''; }

// ‚ïê‚ïê‚ïê Persistence ‚ïê‚ïê‚ïê
function saveLeads() { localStorage.setItem('ac-leads', JSON.stringify(leads)); }
function loadLeads() { try { leads = JSON.parse(localStorage.getItem('ac-leads') || '[]'); } catch { leads = []; } }

// ‚ïê‚ïê‚ïê Render ‚ïê‚ïê‚ïê
function render() {
  // Stats
  document.getElementById('statTotal').textContent = leads.length;
  document.getElementById('statEnriched').textContent = leads.filter(l => l.enrichment).length;
  document.getElementById('statDrafted').textContent = leads.filter(l => l.emailDraft).length;
  document.getElementById('statSent').textContent = leads.filter(l => l.sent).length;

  // Toggle sections
  const hasLeads = leads.length > 0;
  document.getElementById('uploadZone').classList.toggle('has-data', hasLeads);
  document.getElementById('leadsSection').style.display = hasLeads ? '' : 'none';
  document.getElementById('emptyState').style.display = hasLeads ? 'none' : '';
  document.getElementById('leadsCount').textContent = `${leads.length} leads`;

  // Lead cards
  const grid = document.getElementById('leadsGrid');
  grid.innerHTML = leads.map((l, i) => {
    const statusClass = getStatusClass(l.status);
    const badges = [];
    if (l.enrichment) badges.push('<span class="badge enriched">‚úì Enriched</span>');
    if (l.emailDraft) badges.push('<span class="badge drafted">‚úâ Drafted</span>');
    if (l.sent) badges.push('<span class="badge sent">‚úà Sent</span>');

    return `<div class="lead-card fade-in" style="animation-delay:${Math.min(i * 0.03, 0.3)}s" onclick="openDetail('${l.id}')">
      <div class="lc-top">
        <div class="lc-name">${esc(l.name)}</div>
        ${l.status ? `<span class="lc-status ${statusClass}">${esc(l.status)}</span>` : ''}
      </div>
      ${l.address ? `<div class="lc-address">${esc(l.address)}</div>` : ''}
      <div class="lc-meta">
        ${l.email ? `<span>‚úâ ${esc(l.email)}</span>` : ''}
        ${l.phone ? `<span>üìû ${esc(l.phone)}</span>` : ''}
        ${l.price ? `<span>üí∞ ${esc(l.price)}</span>` : ''}
      </div>
      ${badges.length ? `<div style="margin-top:8px;display:flex;gap:6px">${badges.join('')}</div>` : ''}
    </div>`;
  }).join('');
}

function getStatusClass(status) {
  if (!status) return 'default';
  const s = status.toLowerCase();
  if (s.includes('foreclos')) return 'foreclosure';
  if (s.includes('expir')) return 'expired';
  if (s.includes('fsbo') || s.includes('by owner')) return 'fsbo';
  return 'default';
}

// ‚ïê‚ïê‚ïê Detail Panel ‚ïê‚ïê‚ïê
function openDetail(id) {
  const lead = leads.find(l => l.id === id);
  if (!lead) return;

  const panel = document.getElementById('detailPanel');
  panel.innerHTML = `
    <div class="dp-header">
      <button class="dp-close" onclick="closeDetail()">‚úï</button>
      <div class="dp-title">${esc(lead.name)}</div>
    </div>

    <div class="dp-section">
      <div class="dp-section-title">Lead Info</div>
      ${lead.address ? `<div class="dp-field"><label>Address</label><div class="val">üìç ${esc(lead.address)}</div></div>` : ''}
      ${lead.email ? `<div class="dp-field"><label>Email</label><div class="val">${esc(lead.email)}</div></div>` : ''}
      ${lead.phone ? `<div class="dp-field"><label>Phone</label><div class="val">${esc(lead.phone)}</div></div>` : ''}
      ${lead.status ? `<div class="dp-field"><label>Status</label><div class="val"><span class="lc-status ${getStatusClass(lead.status)}" style="display:inline-block">${esc(lead.status)}</span></div></div>` : ''}
      ${lead.price ? `<div class="dp-field"><label>Price</label><div class="val">${esc(lead.price)}</div></div>` : ''}
      ${lead.notes ? `<div class="dp-field"><label>Notes</label><div class="val" style="color:var(--text2)">${esc(lead.notes)}</div></div>` : ''}
    </div>

    <div class="dp-section">
      <div class="dp-section-title">AI Enrichment</div>
      ${lead.enrichment
        ? `<div class="val" style="font-size:13px;line-height:1.6;color:var(--text2)">${formatEnrichment(lead.enrichment)}</div>`
        : `<button class="btn-enrich" id="enrichBtn" onclick="enrichLead('${lead.id}')">üîç Enrich with AI</button>`
      }
    </div>

    <div class="dp-section">
      <div class="dp-section-title">Outreach Email</div>
      ${lead.emailDraft || lead.enrichment
        ? `<div class="email-editor">
            <textarea id="emailDraft" placeholder="AI will draft a personalized email...">${esc(lead.emailDraft)}</textarea>
            <div class="email-actions">
              ${!lead.emailDraft ? `<button class="btn-primary" onclick="draftEmail('${lead.id}')">‚úç Draft Email</button>` : ''}
              ${lead.emailDraft && !lead.sent ? `<button class="btn-primary" onclick="sendEmail('${lead.id}')">üìß Copy & Open Mail</button>` : ''}
              ${lead.emailDraft ? `<button class="btn-secondary" onclick="draftEmail('${lead.id}')">‚Üª Redraft</button>` : ''}
              ${lead.sent ? `<span class="badge sent" style="padding:10px 16px;font-size:12px">‚úà Sent</span>` : ''}
            </div>
          </div>`
        : `<div style="font-size:13px;color:var(--muted)">Enrich the lead first, then AI will draft a personalized email.</div>`
      }
    </div>

    <div class="dp-section">
      <button class="btn-secondary" style="width:100%;color:var(--red);border-color:var(--red-dim)" onclick="deleteLead('${lead.id}')">üóë Remove Lead</button>
    </div>
  `;

  document.getElementById('detailOverlay').classList.add('open');
}

function closeDetail() {
  document.getElementById('detailOverlay').classList.remove('open');
}

function formatEnrichment(text) {
  return esc(text).replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong style="color:var(--text)">$1</strong>');
}

// ‚ïê‚ïê‚ïê AI Calls ‚ïê‚ïê‚ïê
async function enrichLead(id) {
  const lead = leads.find(l => l.id === id);
  if (!lead) return;

  const btn = document.getElementById('enrichBtn');
  if (btn) { btn.disabled = true; btn.classList.add('loading'); btn.textContent = 'Enriching'; }

  const prompt = `You are a real estate research assistant. Given this property lead, provide a brief enrichment analysis. Be concise (under 150 words).

Lead info:
- Name: ${lead.name}
- Address: ${lead.address || 'Unknown'}
- Status: ${lead.status || 'Unknown'}
- Price: ${lead.price || 'Unknown'}
- Notes: ${lead.notes || 'None'}

Provide:
1. **Estimated Situation**: Why this property might be available (2-3 sentences)
2. **Outreach Angle**: The best way to approach this owner (1-2 sentences)
3. **Urgency Level**: Low / Medium / High with brief reason`;

  try {
    const result = await callAI(prompt);
    lead.enrichment = result;
    saveLeads();
    openDetail(id); // re-render panel
    render();
    showToast('Lead enriched', 'success');
  } catch (e) {
    showToast('Enrichment failed: ' + e.message, 'error');
    if (btn) { btn.disabled = false; btn.classList.remove('loading'); btn.textContent = 'üîç Enrich with AI'; }
  }
}

async function draftEmail(id) {
  const lead = leads.find(l => l.id === id);
  if (!lead) return;

  const ta = document.getElementById('emailDraft');
  if (ta) ta.value = 'Drafting...';

  const prompt = `You are a real estate agent writing a personalized cold outreach email. Write a warm, professional email under 150 words. No fake urgency, no pushy language. Be genuine and helpful.

Lead:
- Owner: ${lead.name}
- Property: ${lead.address || 'their property'}
- Status: ${lead.status || 'potential seller'}
- Context: ${lead.enrichment || lead.notes || 'No additional context'}

Write ONLY the email body (no subject line, no greeting template). Start with a personalized opening line about their specific situation. End with a soft call to action like grabbing coffee or a quick call.`;

  try {
    const result = await callAI(prompt);
    lead.emailDraft = result;
    saveLeads();
    openDetail(id);
    render();
    showToast('Email drafted', 'success');
  } catch (e) {
    showToast('Draft failed: ' + e.message, 'error');
    if (ta) ta.value = lead.emailDraft || '';
  }
}

async function callAI(prompt) {
  const res = await fetch('/api/gateway/chat', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      model: 'openclaw:main',
      messages: [{ role: 'user', content: prompt }],
      stream: false
    })
  });

  if (!res.ok) throw new Error(`API error ${res.status}`);

  const data = await res.json();
  return data.choices?.[0]?.message?.content || 'No response';
}

function sendEmail(id) {
  const lead = leads.find(l => l.id === id);
  if (!lead || !lead.emailDraft) return;

  // Save any edits from textarea
  const ta = document.getElementById('emailDraft');
  if (ta) lead.emailDraft = ta.value;

  // Copy to clipboard
  navigator.clipboard.writeText(lead.emailDraft).then(() => {
    // Open mailto link
    if (lead.email) {
      const subject = encodeURIComponent(`Your property at ${lead.address || 'your address'}`);
      const body = encodeURIComponent(lead.emailDraft);
      window.open(`mailto:${lead.email}?subject=${subject}&body=${body}`, '_blank');
    }

    lead.sent = true;
    saveLeads();
    openDetail(id);
    render();
    showToast('Email copied & mail opened', 'success');
  }).catch(() => {
    showToast('Could not copy ‚Äî please copy manually', 'error');
  });
}

function deleteLead(id) {
  leads = leads.filter(l => l.id !== id);
  saveLeads();
  closeDetail();
  render();
  showToast('Lead removed', 'success');
}

function clearAll() {
  if (!leads.length) return;
  if (!confirm('Clear all leads? This cannot be undone.')) return;
  leads = [];
  saveLeads();
  render();
  showToast('All leads cleared', 'success');
}

// ‚ïê‚ïê‚ïê UI Helpers ‚ïê‚ïê‚ïê
function showToast(msg, type = '') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast show ' + type;
  clearTimeout(t._timer);
  t._timer = setTimeout(() => t.className = 'toast', 3000);
}

function esc(t) { const d = document.createElement('div'); d.textContent = t || ''; return d.innerHTML; }

// ‚ïê‚ïê‚ïê Header scroll effect ‚ïê‚ïê‚ïê
window.addEventListener('scroll', () => {
  document.getElementById('header').classList.toggle('scrolled', window.scrollY > 10);
});

// ‚ïê‚ïê‚ïê Init ‚ïê‚ïê‚ïê
loadLeads();
render();
</script>
</body>
</html>
