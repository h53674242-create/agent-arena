<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ü¶û Agent Arena HQ</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Inter:wght@400;500;600;700&display=swap');
  :root {
    --bg: #0d0d14; --surface: #16161e; --border: #2a2a3a;
    --text: #e4e4e7; --muted: #71717a; --accent: #fbbf24;
    --green: #22c55e; --red: #ef4444; --blue: #3b82f6;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body { font-family:'Inter',sans-serif; background:var(--bg); color:var(--text); height:100vh; display:flex; flex-direction:column; }

  nav { padding:10px 20px; background:var(--surface); border-bottom:1px solid var(--border); display:flex; align-items:center; gap:16px; }
  nav .logo { font-family:'Press Start 2P',monospace; font-size:11px; color:var(--accent); }
  nav a { color:var(--muted); text-decoration:none; font-size:13px; }
  nav a:hover, nav a.active { color:var(--text); }
  nav .spacer { flex:1; }
  nav .status { font-size:11px; padding:4px 10px; border-radius:10px; }
  nav .status.online { color:var(--green); background:rgba(34,197,94,0.1); }
  nav .status.offline { color:var(--red); background:rgba(239,68,68,0.1); }

  .main { flex:1; display:flex; overflow:hidden; }

  .agents-panel { width:280px; border-right:1px solid var(--border); display:flex; flex-direction:column; }
  .agents-header { padding:14px 16px; font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:1px; border-bottom:1px solid var(--border); }
  .agents-list { flex:1; overflow-y:auto; }
  .agent-card { padding:14px 16px; border-bottom:1px solid var(--border); cursor:pointer; transition:background 0.15s; }
  .agent-card:hover { background:rgba(255,255,255,0.03); }
  .agent-card.active { background:rgba(251,191,36,0.06); border-left:3px solid var(--accent); }
  .agent-card .agent-top { display:flex; align-items:center; gap:10px; }
  .agent-card .agent-emoji { font-size:24px; }
  .agent-card .agent-info { flex:1; }
  .agent-card .agent-name { font-size:13px; font-weight:600; }
  .agent-card .agent-role { font-size:11px; color:var(--muted); margin-top:2px; }
  .agent-card .agent-dot { width:8px; height:8px; border-radius:50%; flex-shrink:0; }
  .agent-card .agent-dot.online { background:var(--green); box-shadow:0 0 6px rgba(34,197,94,0.4); }
  .agent-card .agent-dot.offline { background:var(--muted); }
  .empty-agents { padding:40px 20px; text-align:center; color:var(--muted); font-size:13px; line-height:1.6; }
  .empty-agents a { color:var(--accent); text-decoration:none; }

  .chat-area { flex:1; display:flex; flex-direction:column; }
  .chat-header { padding:14px 20px; border-bottom:1px solid var(--border); display:flex; align-items:center; gap:12px; }
  .chat-header .name { font-weight:600; font-size:14px; }
  .chat-header .meta { font-size:11px; color:var(--muted); }
  .chat-header .meta.online { color:var(--green); }
  .chat-header .hatch-btn { margin-left:auto; padding:6px 14px; background:var(--accent); color:#000; border:none; border-radius:6px; font-size:12px; font-weight:600; cursor:pointer; }
  .chat-header .hatch-btn:hover { filter:brightness(1.1); }
  .chat-header .hatch-btn:disabled { opacity:0.5; cursor:default; }

  .messages { flex:1; overflow-y:auto; padding:20px; display:flex; flex-direction:column; gap:12px; }
  .msg { max-width:75%; padding:10px 14px; border-radius:12px; font-size:13px; line-height:1.5; word-wrap:break-word; }
  .msg.agent { background:var(--surface); border:1px solid var(--border); align-self:flex-start; }
  .msg.user { background:rgba(251,191,36,0.1); border:1px solid rgba(251,191,36,0.2); align-self:flex-end; }
  .msg.system { align-self:center; color:var(--muted); font-size:11px; background:none; border:none; padding:4px; }
  .typing { align-self:flex-start; color:var(--muted); font-size:12px; padding:8px 14px; }
  .typing span { animation:blink 1.4s infinite; }
  .typing span:nth-child(2) { animation-delay:0.2s; }
  .typing span:nth-child(3) { animation-delay:0.4s; }
  @keyframes blink { 0%,80%,100%{opacity:0} 40%{opacity:1} }

  .no-chat { flex:1; display:flex; align-items:center; justify-content:center; color:var(--muted); font-size:13px; }

  .chat-input { padding:12px 20px; border-top:1px solid var(--border); display:flex; gap:8px; }
  .chat-input input { flex:1; padding:10px 14px; background:var(--surface); border:1px solid var(--border); border-radius:8px; color:var(--text); font-size:13px; outline:none; }
  .chat-input input:focus { border-color:var(--accent); }
  .chat-input button { padding:10px 16px; background:var(--accent); color:#000; border:none; border-radius:8px; font-weight:600; cursor:pointer; font-size:13px; }
  .chat-input button:disabled { opacity:0.4; cursor:default; }

  .hatch-anim { text-align:center; padding:60px 20px; }
  .hatch-anim .egg { font-size:64px; animation:wobble 0.5s ease-in-out infinite; }
  .hatch-anim .status-text { margin-top:12px; color:var(--muted); font-size:12px; }
  @keyframes wobble { 0%,100%{transform:rotate(0)} 25%{transform:rotate(-5deg)} 75%{transform:rotate(5deg)} }

  @media(max-width:640px) {
    .agents-panel { width:100%; border-right:none; border-bottom:1px solid var(--border); max-height:40vh; }
    .main { flex-direction:column; }
    .msg { max-width:90%; }
  }
</style>
</head>
<body>

<nav>
  <span class="logo">ü¶û AGENT ARENA</span>
  <a href="index.html">Home</a>
  <a href="agents.html">Agents</a>
  <a href="hq.html" class="active">HQ</a>
  <span class="spacer"></span>
  <span class="status offline" id="gwStatus">‚óè Disconnected</span>
</nav>

<div class="main">
  <div class="agents-panel">
    <div class="agents-header">Your Agents</div>
    <div class="agents-list" id="agentList">
      <div class="empty-agents">
        No agents installed yet.<br>
        <a href="agents.html">Browse the Arena ‚Üí</a>
      </div>
    </div>
  </div>

  <div class="chat-area" id="chatArea">
    <div class="no-chat">‚Üê Select an agent to chat</div>
  </div>
</div>

<script>
const WS_URL = `ws://${location.host}`;
let ws = null;
let selectedAgent = null;
let agentData = {};    // agentId -> { emoji, displayName, role, pkgName, online, sessionKey }
let chatState = {};    // agentId -> { messages:[], hatched, sessionKey }
let streamBuffers = {};

// ---- WebSocket ----
function connectWS() {
  ws = new WebSocket(WS_URL);
  ws.onopen = () => updateGW(true);
  ws.onclose = () => { updateGW(false); setTimeout(connectWS, 3000); };
  ws.onmessage = (e) => { try { handleMsg(JSON.parse(e.data)); } catch(err) { console.error(err); } };
}

function updateGW(on) {
  const el = document.getElementById('gwStatus');
  el.textContent = on ? '‚óè Connected' : '‚óè Disconnected';
  el.className = 'status ' + (on ? 'online' : 'offline');
}

function handleMsg(msg) {
  if (msg.type === 'status') updateGW(msg.connected);

  if (msg.type === 'hatch-ok') {
    const id = pkgToId(msg.agentPkg);
    const st = chatState[id];
    if (st) { st.hatched = true; st.sessionKey = msg.sessionKey; }
    if (agentData[id]) agentData[id].online = true;
    updateAgentDot(id);
    if (selectedAgent === id) renderChat();
  }

  if (msg.type === 'chat-delta') {
    const id = pkgToId(msg.agentPkg);
    if (!chatState[id]) return;
    if (!streamBuffers[msg.runId]) streamBuffers[msg.runId] = '';
    streamBuffers[msg.runId] += extractText(msg.message);
    if (selectedAgent === id) updateStream(msg.runId, streamBuffers[msg.runId]);
  }

  if (msg.type === 'chat-final') {
    const id = pkgToId(msg.agentPkg);
    const st = chatState[id];
    if (!st) return;
    let text = streamBuffers[msg.runId] || extractText(msg.message);
    delete streamBuffers[msg.runId];
    if (text) st.messages.push({ role:'agent', text });
    if (selectedAgent === id) renderChat();
  }

  if (msg.type === 'error') console.error('Server:', msg.error);
}

function extractText(m) {
  if (typeof m === 'string') return m;
  if (Array.isArray(m)) return m.filter(p=>p.type==='text').map(p=>p.text).join('');
  return m?.text || '';
}

function pkgToId(pkg) { return pkg?.replace(/-agent$/, '') || pkg; }

// ---- Load agents + sessions ----
async function init() {
  try {
    const [regRes, pkgRes, sessRes] = await Promise.all([
      fetch('/api/agents/registered'),
      fetch('/api/agents'),
      fetch('/api/sessions'),
    ]);
    const registered = await regRes.json();
    const packages = await pkgRes.json();
    const sessions = await sessRes.json();

    const pkgMap = {};
    packages.forEach(p => pkgMap[p.name] = p);

    // Build active session map: agentId -> main session only (not subagents)
    const sessionMap = {};
    sessions.forEach(s => {
      if (!s.agentId) return;
      // Only use main sessions (agent:X:main) ‚Äî subagent sessions are one-shot and finished
      if (s.key?.endsWith(':main')) {
        sessionMap[s.agentId] = s;
      }
    });

    const list = document.getElementById('agentList');
    if (registered.length === 0) return;
    list.innerHTML = '';

    registered.forEach(a => {
      const id = a.id;
      const pkg = pkgMap[id + '-agent'] || pkgMap[id] || {};
      const session = sessionMap[id];
      const online = !!session;

      agentData[id] = {
        emoji: pkg.emoji || 'ü§ñ',
        displayName: pkg.displayName || a.name || id,
        role: pkg.tagline || id,
        pkgName: pkg.name || id + '-agent',
        online,
        sessionKey: session?.key || null,
      };

      chatState[id] = chatState[id] || {
        messages: [],
        hatched: true,  // all registered agents are ready to chat (server auto-creates session)
        sessionKey: session?.key || null,
      };

      const card = document.createElement('div');
      card.className = 'agent-card';
      card.id = 'card-' + id;
      card.innerHTML = `
        <div class="agent-top">
          <span class="agent-emoji">${agentData[id].emoji}</span>
          <div class="agent-info">
            <div class="agent-name">${agentData[id].displayName}</div>
            <div class="agent-role">${agentData[id].role}</div>
          </div>
          <div class="agent-dot online" id="dot-${id}"></div>
        </div>`;
      card.onclick = () => selectAgent(id);
      list.appendChild(card);
    });
  } catch(e) {
    console.error('Init failed:', e);
  }
}

function updateAgentDot(id) {
  const dot = document.getElementById('dot-' + id);
  if (!dot) return;
  const on = agentData[id]?.online;
  dot.className = 'agent-dot ' + (on ? 'online' : 'offline');
}

function selectAgent(id) {
  selectedAgent = id;
  document.querySelectorAll('.agent-card').forEach(c => c.classList.toggle('active', c.id === 'card-' + id));
  renderChatArea();
}

function renderChatArea() {
  const id = selectedAgent;
  if (!id) return;
  const a = agentData[id];
  const st = chatState[id];
  const area = document.getElementById('chatArea');

  area.innerHTML = `
    <div class="chat-header">
      <span style="font-size:24px">${a.emoji}</span>
      <span class="name">${a.displayName}</span>
      <span class="meta online">‚óè Ready</span>
    </div>
    <div class="messages" id="messages"></div>
    <div class="chat-input">
      <input type="text" id="msgInput" placeholder="Message ${a.displayName}..." onkeydown="if(event.key==='Enter')sendMsg()">
      <button onclick="sendMsg()">Send</button>
    </div>`;

  renderChat();
}

function renderChat() {
  if (!selectedAgent) return;
  const st = chatState[selectedAgent];
  const msgs = document.getElementById('messages');
  if (!msgs) return;
  const a = agentData[selectedAgent];

  if (st.messages.length === 0) {
    msgs.innerHTML = '<div class="msg system">Send a message to start chatting</div>';
  } else {
    msgs.innerHTML = st.messages.map(m =>
      `<div class="msg ${m.role}">${esc(m.text)}</div>`
    ).join('');
  }
  msgs.scrollTop = msgs.scrollHeight;
}

function updateStream(runId, text) {
  const msgs = document.getElementById('messages');
  if (!msgs) return;
  let el = document.getElementById('stream-' + runId);
  if (!el) {
    el = document.createElement('div');
    el.id = 'stream-' + runId;
    el.className = 'msg agent';
    msgs.appendChild(el);
  }
  el.innerHTML = esc(text);
  msgs.scrollTop = msgs.scrollHeight;
}

function hatchAgent(id) {
  if (!ws || ws.readyState !== 1) return;
  const a = agentData[id];
  const btn = document.getElementById('hatchBtn');
  if (btn) { btn.disabled = true; btn.textContent = 'üê£ Hatching...'; }
  const msgs = document.getElementById('messages');
  if (msgs) msgs.innerHTML = '<div class="hatch-anim"><div class="egg">ü•ö</div><div class="status-text">Waking up...</div></div>';
  ws.send(JSON.stringify({ type: 'hatch', agentPkg: a.pkgName }));
}

function sendMsg() {
  const input = document.getElementById('msgInput');
  if (!input) return;
  const text = input.value.trim();
  if (!text || !selectedAgent) return;
  input.value = '';

  const st = chatState[selectedAgent];
  const a = agentData[selectedAgent];
  st.messages.push({ role:'user', text });
  renderChat();

  ws.send(JSON.stringify({ type:'chat', agentPkg: a.pkgName, message: text, sessionKey: st.sessionKey }));
}

function esc(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>');
}

// Init
init();
connectWS();
</script>
</body>
</html>
