<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ü¶û Agent Arena HQ</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Inter:wght@400;500;600;700&display=swap');
  :root {
    --bg: #0d0d14; --surface: #16161e; --border: #2a2a3a;
    --text: #e4e4e7; --muted: #71717a; --accent: #fbbf24;
    --green: #22c55e; --red: #ef4444; --blue: #3b82f6;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body { font-family:'Inter',sans-serif; background:var(--bg); color:var(--text); height:100vh; display:flex; flex-direction:column; }

  /* Nav */
  nav { padding:10px 20px; background:var(--surface); border-bottom:1px solid var(--border); display:flex; align-items:center; gap:16px; }
  nav .logo { font-family:'Press Start 2P',monospace; font-size:11px; color:var(--accent); }
  nav a { color:var(--muted); text-decoration:none; font-size:13px; }
  nav a:hover, nav a.active { color:var(--text); }
  nav .spacer { flex:1; }
  nav .status { font-size:11px; padding:4px 10px; border-radius:10px; }
  nav .status.online { color:var(--green); background:rgba(34,197,94,0.1); }
  nav .status.offline { color:var(--red); background:rgba(239,68,68,0.1); }

  /* Main layout */
  .main { flex:1; display:flex; overflow:hidden; }

  /* Agent list (left) */
  .agents-panel { width:280px; border-right:1px solid var(--border); display:flex; flex-direction:column; }
  .agents-header { padding:14px 16px; font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:1px; border-bottom:1px solid var(--border); }
  .agents-list { flex:1; overflow-y:auto; }
  .agent-card { padding:14px 16px; border-bottom:1px solid var(--border); cursor:pointer; transition:background 0.15s; }
  .agent-card:hover { background:rgba(255,255,255,0.03); }
  .agent-card.active { background:rgba(251,191,36,0.06); border-left:3px solid var(--accent); }
  .agent-card .agent-top { display:flex; align-items:center; gap:10px; }
  .agent-card .agent-emoji { font-size:24px; }
  .agent-card .agent-info { flex:1; }
  .agent-card .agent-name { font-size:13px; font-weight:600; }
  .agent-card .agent-role { font-size:11px; color:var(--muted); margin-top:2px; }
  .agent-card .agent-dot { width:8px; height:8px; border-radius:50%; }
  .agent-card .agent-dot.online { background:var(--green); box-shadow:0 0 6px rgba(34,197,94,0.4); }
  .agent-card .agent-dot.offline { background:var(--muted); }
  .empty-agents { padding:40px 20px; text-align:center; color:var(--muted); font-size:13px; line-height:1.6; }
  .empty-agents a { color:var(--accent); text-decoration:none; }

  /* Chat area (right) */
  .chat-area { flex:1; display:flex; flex-direction:column; }
  .chat-header { padding:14px 20px; border-bottom:1px solid var(--border); display:flex; align-items:center; gap:12px; }
  .chat-header .name { font-weight:600; font-size:14px; }
  .chat-header .meta { font-size:11px; color:var(--muted); }
  .chat-header .hatch-btn { margin-left:auto; padding:6px 14px; background:var(--accent); color:#000; border:none; border-radius:6px; font-size:12px; font-weight:600; cursor:pointer; }
  .chat-header .hatch-btn:hover { filter:brightness(1.1); }
  .chat-header .hatch-btn:disabled { opacity:0.5; cursor:default; }

  .messages { flex:1; overflow-y:auto; padding:20px; display:flex; flex-direction:column; gap:12px; }
  .msg { max-width:75%; padding:10px 14px; border-radius:12px; font-size:13px; line-height:1.5; word-wrap:break-word; }
  .msg.agent { background:var(--surface); border:1px solid var(--border); align-self:flex-start; }
  .msg.user { background:rgba(251,191,36,0.1); border:1px solid rgba(251,191,36,0.2); align-self:flex-end; }
  .msg.system { align-self:center; color:var(--muted); font-size:11px; background:none; border:none; padding:4px; }
  .msg code { background:rgba(255,255,255,0.06); padding:1px 4px; border-radius:3px; font-size:12px; }
  .msg pre { background:rgba(0,0,0,0.3); padding:8px; border-radius:6px; overflow-x:auto; margin:6px 0; font-size:12px; }
  .typing { align-self:flex-start; color:var(--muted); font-size:12px; padding:8px 14px; }
  .typing span { animation:blink 1.4s infinite; }
  .typing span:nth-child(2) { animation-delay:0.2s; }
  .typing span:nth-child(3) { animation-delay:0.4s; }
  @keyframes blink { 0%,80%,100%{opacity:0} 40%{opacity:1} }

  .no-chat { flex:1; display:flex; align-items:center; justify-content:center; color:var(--muted); font-size:13px; }

  .chat-input { padding:12px 20px; border-top:1px solid var(--border); display:flex; gap:8px; }
  .chat-input input { flex:1; padding:10px 14px; background:var(--surface); border:1px solid var(--border); border-radius:8px; color:var(--text); font-size:13px; outline:none; }
  .chat-input input:focus { border-color:var(--accent); }
  .chat-input button { padding:10px 16px; background:var(--accent); color:#000; border:none; border-radius:8px; font-weight:600; cursor:pointer; font-size:13px; }
  .chat-input button:disabled { opacity:0.4; cursor:default; }

  /* Hatch animation */
  .hatch-anim { text-align:center; padding:60px 20px; }
  .hatch-anim .egg { font-size:64px; animation:wobble 0.5s ease-in-out infinite; }
  .hatch-anim .status-text { margin-top:12px; color:var(--muted); font-size:12px; }
  @keyframes wobble { 0%,100%{transform:rotate(0)} 25%{transform:rotate(-5deg)} 75%{transform:rotate(5deg)} }

  /* Mobile */
  @media(max-width:640px) {
    .agents-panel { width:100%; border-right:none; border-bottom:1px solid var(--border); max-height:40vh; }
    .main { flex-direction:column; }
    .msg { max-width:90%; }
  }
</style>
</head>
<body>

<nav>
  <span class="logo">ü¶û AGENT ARENA</span>
  <a href="index.html">Home</a>
  <a href="agents.html">Agents</a>
  <a href="hq.html" class="active">HQ</a>
  <span class="spacer"></span>
  <span class="status offline" id="gwStatus">‚óè Disconnected</span>
</nav>

<div class="main">
  <div class="agents-panel">
    <div class="agents-header">Your Agents</div>
    <div class="agents-list" id="agentList">
      <div class="empty-agents">
        No agents installed yet.<br>
        <a href="agents.html">Browse the Arena ‚Üí</a>
      </div>
    </div>
  </div>

  <div class="chat-area" id="chatArea">
    <div class="no-chat" id="noChat">‚Üê Select an agent to chat</div>
  </div>
</div>

<script>
const WS_URL = `ws://${location.host}`;
let ws = null;
let selectedAgent = null;
let agentStates = {}; // agentPkg -> { hatched, sessionKey, messages:[] }
let streamBuffers = {}; // runId -> accumulated text

// Connect WebSocket
function connectWS() {
  ws = new WebSocket(WS_URL);
  ws.onopen = () => updateGatewayStatus(true);
  ws.onclose = () => { updateGatewayStatus(false); setTimeout(connectWS, 3000); };
  ws.onmessage = (e) => {
    try { handleMsg(JSON.parse(e.data)); } catch(err) { console.error('ws msg error', err); }
  };
}

function updateGatewayStatus(connected) {
  const el = document.getElementById('gwStatus');
  if (connected) { el.textContent = '‚óè Connected'; el.className = 'status online'; }
  else { el.textContent = '‚óè Disconnected'; el.className = 'status offline'; }
}

function handleMsg(msg) {
  if (msg.type === 'status') {
    updateGatewayStatus(msg.connected);
  }

  if (msg.type === 'hatch-ok') {
    const st = agentStates[msg.agentPkg];
    if (st) { st.hatched = true; st.sessionKey = msg.sessionKey; }
    if (selectedAgent === msg.agentPkg) renderChat();
  }

  if (msg.type === 'chat-delta') {
    const st = agentStates[msg.agentPkg];
    if (!st) return;
    if (!streamBuffers[msg.runId]) streamBuffers[msg.runId] = '';
    // Extract text
    let text = '';
    if (typeof msg.message === 'string') text = msg.message;
    else if (Array.isArray(msg.message)) msg.message.forEach(p => { if (p.type==='text') text += p.text; });
    else if (msg.message?.text) text = msg.message.text;
    streamBuffers[msg.runId] += text;
    if (selectedAgent === msg.agentPkg) updateStreamingMsg(msg.runId, streamBuffers[msg.runId]);
  }

  if (msg.type === 'chat-final') {
    const st = agentStates[msg.agentPkg];
    if (!st) return;
    let text = streamBuffers[msg.runId] || '';
    if (!text) {
      if (typeof msg.message === 'string') text = msg.message;
      else if (Array.isArray(msg.message)) msg.message.forEach(p => { if (p.type==='text') text += p.text; });
      else if (msg.message?.text) text = msg.message.text;
    }
    delete streamBuffers[msg.runId];
    if (text) { st.messages.push({ role:'agent', text }); }
    if (selectedAgent === msg.agentPkg) renderChat();
  }

  if (msg.type === 'agent-event') {
    // Could show tool use in future
  }

  if (msg.type === 'error') {
    console.error('Server error:', msg.error);
  }
}

// Fetch registered agents from server
async function loadAgents() {
  try {
    const res = await fetch('/api/agents/registered');
    const agents = await res.json();
    // Also get package info for display
    const pkgRes = await fetch('/api/agents');
    const packages = await pkgRes.json();
    const pkgMap = {};
    packages.forEach(p => pkgMap[p.name] = p);

    const list = document.getElementById('agentList');
    if (agents.length === 0) return; // keep empty state

    list.innerHTML = '';
    agents.forEach(a => {
      const pkg = pkgMap[a.id + '-agent'] || pkgMap[a.id] || {};
      const emoji = pkg.emoji || 'ü§ñ';
      const displayName = pkg.displayName || a.name || a.id;
      const role = pkg.tagline || a.id;
      const pkgName = pkg.name || a.id + '-agent';

      agentStates[pkgName] = agentStates[pkgName] || { hatched:false, sessionKey:null, messages:[] };

      const card = document.createElement('div');
      card.className = 'agent-card';
      card.dataset.pkg = pkgName;
      card.innerHTML = `
        <div class="agent-top">
          <span class="agent-emoji">${emoji}</span>
          <div class="agent-info">
            <div class="agent-name">${displayName}</div>
            <div class="agent-role">${role}</div>
          </div>
          <div class="agent-dot offline"></div>
        </div>`;
      card.onclick = () => selectAgent(pkgName, displayName, emoji);
      list.appendChild(card);
    });
  } catch(e) {
    console.error('Failed to load agents:', e);
  }
}

function selectAgent(pkgName, displayName, emoji) {
  selectedAgent = pkgName;
  // Update active card
  document.querySelectorAll('.agent-card').forEach(c => c.classList.toggle('active', c.dataset.pkg === pkgName));

  const st = agentStates[pkgName];
  const area = document.getElementById('chatArea');

  area.innerHTML = `
    <div class="chat-header">
      <span style="font-size:24px">${emoji}</span>
      <span class="name">${displayName}</span>
      <span class="meta">${st.hatched ? '‚óè Online' : 'Not started'}</span>
      <button class="hatch-btn" id="hatchBtn" onclick="hatchAgent('${pkgName}')" ${st.hatched ? 'disabled' : ''}>
        ${st.hatched ? '‚úì Running' : 'ü•ö Hatch'}
      </button>
    </div>
    <div class="messages" id="messages"></div>
    <div class="chat-input" id="chatInput" style="${st.hatched ? '' : 'display:none'}">
      <input type="text" id="msgInput" placeholder="Message ${displayName}..." onkeydown="if(event.key==='Enter')sendMsg()">
      <button onclick="sendMsg()">Send</button>
    </div>`;

  renderChat();
}

function renderChat() {
  if (!selectedAgent) return;
  const st = agentStates[selectedAgent];
  const msgs = document.getElementById('messages');
  if (!msgs) return;

  if (!st.hatched && st.messages.length === 0) {
    msgs.innerHTML = '<div class="msg system">Click "Hatch" to wake this agent up</div>';
    return;
  }

  msgs.innerHTML = st.messages.map(m =>
    `<div class="msg ${m.role}">${escapeHtml(m.text)}</div>`
  ).join('');
  msgs.scrollTop = msgs.scrollHeight;

  // Show input if hatched
  const input = document.getElementById('chatInput');
  if (input) input.style.display = st.hatched ? '' : 'none';
}

function updateStreamingMsg(runId, text) {
  const msgs = document.getElementById('messages');
  if (!msgs) return;
  let el = document.getElementById('stream-' + runId);
  if (!el) {
    el = document.createElement('div');
    el.id = 'stream-' + runId;
    el.className = 'msg agent';
    msgs.appendChild(el);
  }
  el.textContent = text;
  msgs.scrollTop = msgs.scrollHeight;
}

function hatchAgent(pkgName) {
  if (!ws || ws.readyState !== 1) return;
  const btn = document.getElementById('hatchBtn');
  if (btn) { btn.disabled = true; btn.textContent = 'üê£ Hatching...'; }

  const msgs = document.getElementById('messages');
  if (msgs) msgs.innerHTML = '<div class="hatch-anim"><div class="egg">ü•ö</div><div class="status-text">Waking up...</div></div>';

  ws.send(JSON.stringify({ type: 'hatch', agentPkg: pkgName }));
}

function sendMsg() {
  const input = document.getElementById('msgInput');
  if (!input) return;
  const text = input.value.trim();
  if (!text || !selectedAgent) return;
  input.value = '';

  const st = agentStates[selectedAgent];
  st.messages.push({ role:'user', text });
  renderChat();

  ws.send(JSON.stringify({ type:'chat', agentPkg: selectedAgent, message: text }));
}

function escapeHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>');
}

// Init
loadAgents();
connectWS();
</script>
</body>
</html>
