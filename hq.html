<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ü¶û Agent Arena HQ</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Inter:wght@400;500;600;700&display=swap');
  :root {
    --bg: #08080c; --surface: #111118; --surface2: #1a1a24;
    --border: #2a2a3a; --text: #e4e4e7; --muted: #71717a;
    --accent: #fbbf24; --green: #22c55e; --red: #ef4444; --blue: #3b82f6;
    --purple: #a78bfa;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body { font-family:'Inter',sans-serif; background:var(--bg); color:var(--text); height:100vh; overflow:hidden; display:flex; flex-direction:column; }

  /* Top Bar */
  .topbar { padding:10px 20px; background:var(--surface); border-bottom:1px solid var(--border); display:flex; align-items:center; gap:16px; flex-shrink:0; z-index:10; }
  .topbar .logo { font-family:'Press Start 2P',monospace; font-size:11px; color:var(--accent); cursor:pointer; }
  .topbar a { color:var(--muted); text-decoration:none; font-size:13px; transition:color .15s; }
  .topbar a:hover { color:var(--text); }
  .topbar .spacer { flex:1; }
  .topbar .badge { font-size:10px; padding:4px 10px; border-radius:10px; font-weight:600; }
  .topbar .badge.online { color:var(--green); background:rgba(34,197,94,0.1); }
  .topbar .badge.offline { color:var(--red); background:rgba(239,68,68,0.1); }
  .topbar .clock { font-size:11px; color:var(--muted); font-variant-numeric:tabular-nums; }

  /* Main */
  .main { flex:1; display:flex; overflow:hidden; }

  /* ‚ïê‚ïê‚ïê Office ‚ïê‚ïê‚ïê */
  .office {
    flex:1; position:relative; overflow:hidden; min-width:0;
    background: linear-gradient(180deg, #1e1b2e 0%, #151320 50%, #13111f 100%);
    transition: flex 0.3s ease;
  }
  .office .wall { position:absolute; top:0; left:0; right:0; height:90px; background:linear-gradient(180deg,#2a2545,#1e1b2e); border-bottom:2px solid rgba(251,191,36,0.06); }
  .wall-item { position:absolute; z-index:2; }
  .wall-item.title { top:16px; left:50%; transform:translateX(-50%); font-family:'Press Start 2P',monospace; font-size:9px; color:var(--accent); background:rgba(0,0,0,0.4); padding:8px 16px; border-radius:4px; border:1px solid rgba(251,191,36,0.15); }
  .wall-item.poster { padding:6px 12px; border-radius:3px; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.06); font-size:9px; color:var(--muted); }
  .wall-item.p1 { top:20px; left:40px; }
  .wall-item.p2 { top:20px; right:40px; }
  .wall-item.window { top:10px; right:180px; width:70px; height:50px; background:linear-gradient(180deg,#1a2040,#2a3060); border:2px solid rgba(255,255,255,0.08); border-radius:4px; }
  .wall-item.window::after { content:'‚ú¶ ¬∑ ‚úß'; position:absolute; top:12px; left:12px; font-size:7px; color:rgba(255,255,255,0.3); }
  .wall-item.whiteboard { top:10px; left:180px; width:100px; height:55px; background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.06); border-radius:3px; font-size:7px; padding:5px; color:var(--muted); line-height:1.4; overflow:hidden; }
  .office .floor { position:absolute; bottom:0; left:0; right:0; height:40px; background:linear-gradient(180deg,#13111f,#0d0b18); border-top:1px solid rgba(255,255,255,0.03); }
  .deco { position:absolute; z-index:2; filter:drop-shadow(0 2px 4px rgba(0,0,0,0.3)); }
  .deco.plant1 { bottom:50px; left:30px; font-size:28px; }
  .deco.plant2 { bottom:50px; right:40px; font-size:22px; }
  .deco.cat { bottom:45px; left:80px; font-size:20px; cursor:pointer; transition:transform .2s; }
  .deco.cat:hover { transform:scale(1.2) rotate(-5deg); }
  .deco.coffee { top:60px; left:50px; font-size:14px; }
  .deco.clock-w { top:18px; left:50%; margin-left:120px; font-size:14px; }
  .deco.rug { bottom:42px; left:50%; transform:translateX(-50%); width:500px; height:20px; background:rgba(167,139,250,0.04); border-radius:50%; border:1px solid rgba(167,139,250,0.06); }

  /* Desks */
  .desk-area { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); display:flex; gap:32px; z-index:4; }
  .desk { width:140px; position:relative; cursor:pointer; transition:transform 0.2s; display:flex; flex-direction:column; align-items:center; }
  .desk:hover { transform:translateY(-3px); }
  .desk.selected .agent-avatar { border-color:var(--accent) !important; box-shadow:0 0 20px rgba(251,191,36,0.3) !important; }
  .agent-avatar { width:44px; height:44px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:24px; background:rgba(17,17,24,0.9); border:2px solid var(--border); transition:all 0.3s; position:relative; }
  .desk.active .agent-avatar { border-color:var(--green); box-shadow:0 0 16px rgba(34,197,94,0.2); }
  .desk.empty .agent-avatar { border:2px dashed var(--border); opacity:0.4; }
  .status-dot { position:absolute; bottom:0; right:0; width:10px; height:10px; border-radius:50%; border:2px solid var(--bg); }
  .status-dot.online { background:var(--green); }
  .status-dot.offline { background:var(--muted); }
  .status-dot.busy { background:var(--accent); animation:pulse 1.5s infinite; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }
  .agent-label { margin-top:6px; font-size:10px; font-weight:600; text-align:center; color:var(--text); white-space:nowrap; }
  .desk.empty .agent-label { color:var(--muted); }
  .desk-obj { margin-top:6px; width:100px; height:30px; background:linear-gradient(180deg,#3d3355,#2d2545); border:1px solid rgba(255,255,255,0.06); border-radius:5px; position:relative; box-shadow:0 4px 12px rgba(0,0,0,0.3); }
  .desk-monitor { position:absolute; top:-20px; left:50%; transform:translateX(-50%); width:40px; height:28px; background:linear-gradient(180deg,#0a0a12,#12121e); border:1px solid rgba(255,255,255,0.08); border-radius:3px; }
  .desk-monitor .glow { position:absolute; inset:3px 3px 5px 3px; background:rgba(59,130,246,0.06); border-radius:1px; }
  .desk.active .desk-monitor .glow { background:rgba(34,197,94,0.12); }
  .desk-monitor::after { content:''; position:absolute; bottom:-3px; left:50%; transform:translateX(-50%); width:10px; height:3px; background:#2d2545; border-radius:0 0 2px 2px; }
  .speech-bubble { position:absolute; top:-20px; left:50%; transform:translateX(-50%); background:var(--surface); border:1px solid var(--border); border-radius:8px; padding:5px 10px; font-size:9px; color:var(--muted); white-space:nowrap; max-width:180px; overflow:hidden; text-overflow:ellipsis; opacity:0; transition:opacity 0.3s; z-index:6; }
  .speech-bubble::after { content:''; position:absolute; bottom:-4px; left:50%; transform:translateX(-50%); border-left:4px solid transparent; border-right:4px solid transparent; border-top:4px solid var(--surface); }
  .speech-bubble.visible { opacity:1; }
  .add-agent-desk { width:140px; display:flex; flex-direction:column; align-items:center; cursor:pointer; transition:transform 0.2s; opacity:0.5; }
  .add-agent-desk:hover { opacity:0.8; transform:translateY(-3px); }
  .add-circle { width:44px; height:44px; border-radius:50%; border:2px dashed var(--accent); display:flex; align-items:center; justify-content:center; font-size:20px; color:var(--accent); }
  .add-agent-desk:hover .add-circle { border-style:solid; background:rgba(251,191,36,0.05); }
  .add-label { margin-top:6px; font-size:10px; font-weight:600; color:var(--accent); }

  /* Fire button */
  .fire-btn {
    position:absolute; top:-6px; right:8px; width:20px; height:20px;
    border-radius:50%; background:var(--surface); border:1px solid var(--border);
    color:var(--muted); font-size:11px; cursor:pointer; z-index:5;
    display:none; align-items:center; justify-content:center; transition:all .15s;
    line-height:1;
  }
  .desk:hover .fire-btn { display:flex; }
  .fire-btn:hover { background:var(--red); color:#fff; border-color:var(--red); }

  /* Meeting bar */
  .meeting-bar { position:absolute; bottom:0; left:0; right:0; z-index:8; background:rgba(17,17,24,0.95); border-top:1px solid var(--border); padding:8px 16px; display:flex; align-items:center; gap:12px; backdrop-filter:blur(8px); }
  .meeting-bar .label { font-size:11px; color:var(--accent); font-weight:700; }
  .meeting-bar .parts { font-size:10px; color:var(--muted); }
  .meeting-bar .spacer { flex:1; }
  .meeting-bar button { padding:6px 14px; border:none; border-radius:6px; font-size:11px; font-weight:600; cursor:pointer; }
  .meeting-bar .start-btn { background:var(--green); color:#000; }
  .meeting-bar .start-btn:hover { filter:brightness(1.1); }
  .meeting-bar .end-btn { background:var(--red); color:#fff; display:none; }

  /* ‚ïê‚ïê‚ïê Agent Detail Modal ‚ïê‚ïê‚ïê */
  .agent-detail-overlay {
    display:none; position:fixed; top:0; left:0; right:0; bottom:0;
    background:rgba(0,0,0,0.7); z-index:50; align-items:center; justify-content:center;
    backdrop-filter:blur(4px);
  }
  .agent-detail-overlay.open { display:flex; }
  .agent-detail {
    width:700px; max-width:90vw; max-height:85vh;
    background:var(--surface); border:1px solid var(--border); border-radius:12px;
    display:flex; flex-direction:column; overflow:hidden;
    animation:modalIn 0.2s ease;
    box-shadow:0 20px 60px rgba(0,0,0,0.5);
  }
  @keyframes modalIn { from{opacity:0;transform:scale(0.95) translateY(10px)} to{opacity:1;transform:scale(1) translateY(0)} }

  .detail-header {
    padding:16px 20px; border-bottom:1px solid var(--border);
    display:flex; align-items:center; gap:14px; flex-shrink:0;
  }
  .detail-header .back-btn {
    width:28px; height:28px; border-radius:6px; border:1px solid var(--border);
    background:none; color:var(--muted); cursor:pointer; font-size:14px;
    display:flex; align-items:center; justify-content:center; transition:all .15s;
  }
  .detail-header .back-btn:hover { color:var(--text); border-color:var(--accent); }
  .detail-header .agent-info { flex:1; }
  .detail-header .agent-name { font-size:16px; font-weight:700; display:flex; align-items:center; gap:8px; }
  .detail-header .agent-role { font-size:11px; color:var(--muted); margin-top:2px; }
  .detail-header .status-pill { font-size:10px; padding:3px 10px; border-radius:8px; font-weight:600; }
  .detail-header .status-pill.online { color:var(--green); background:rgba(34,197,94,0.1); }

  /* Detail stats */
  .detail-stats {
    display:flex; gap:1px; background:var(--border); flex-shrink:0;
  }
  .stat-card {
    flex:1; padding:12px 16px; background:var(--surface); text-align:center;
  }
  .stat-card .stat-value { font-size:18px; font-weight:700; color:var(--text); }
  .stat-card .stat-label { font-size:9px; color:var(--muted); margin-top:2px; text-transform:uppercase; letter-spacing:0.5px; }

  /* Detail tabs */
  .detail-tabs { display:flex; border-bottom:1px solid var(--border); flex-shrink:0; }
  .detail-tab {
    flex:1; padding:10px; font-size:11px; font-weight:600; color:var(--muted);
    cursor:pointer; text-align:center; border:none; background:none;
    border-bottom:2px solid transparent; transition:all .15s;
  }
  .detail-tab:hover { color:var(--text); }
  .detail-tab.active { color:var(--accent); border-bottom-color:var(--accent); }

  /* Detail content */
  .detail-content { flex:1; overflow-y:auto; }
  .detail-section { display:none; }
  .detail-section.active { display:block; }

  /* Timeline */
  .timeline { padding:12px 16px; }
  .tl-item {
    display:flex; gap:12px; padding:10px 0;
    border-bottom:1px solid rgba(255,255,255,0.03);
    font-size:12px;
  }
  .tl-item:last-child { border-bottom:none; }
  .tl-icon { width:28px; height:28px; border-radius:6px; display:flex; align-items:center; justify-content:center; font-size:13px; flex-shrink:0; background:var(--surface2); }
  .tl-icon.msg { background:rgba(34,197,94,0.1); }
  .tl-icon.tool { background:rgba(167,139,250,0.1); }
  .tl-icon.think { background:rgba(59,130,246,0.1); }
  .tl-icon.sys { background:rgba(251,191,36,0.1); }
  .tl-body { flex:1; min-width:0; }
  .tl-title { font-weight:600; color:var(--text); margin-bottom:2px; display:flex; align-items:center; gap:6px; }
  .tl-title .tool-badge { font-size:9px; padding:1px 6px; border-radius:4px; background:rgba(167,139,250,0.15); color:var(--purple); font-weight:500; }
  .tl-preview { color:var(--muted); line-height:1.4; overflow:hidden; display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical; }
  .tl-preview.expanded { -webkit-line-clamp:unset; }
  .tl-time { font-size:10px; color:var(--muted); margin-top:3px; }
  .tl-expand { font-size:10px; color:var(--accent); cursor:pointer; margin-top:2px; }
  .tl-expand:hover { text-decoration:underline; }

  /* Sessions list */
  .sessions-list { padding:12px 16px; }
  .session-item {
    padding:10px 12px; border:1px solid var(--border); border-radius:8px;
    margin-bottom:8px; cursor:default;
  }
  .session-item .sess-header { display:flex; align-items:center; gap:8px; margin-bottom:4px; }
  .session-item .sess-label { font-size:12px; font-weight:600; }
  .session-item .sess-kind { font-size:9px; padding:2px 6px; border-radius:4px; background:rgba(59,130,246,0.1); color:var(--blue); }
  .session-item .sess-time { font-size:10px; color:var(--muted); }
  .session-item .sess-model { font-size:10px; color:var(--muted); }

  /* Loading */
  .detail-loading { padding:40px; text-align:center; color:var(--muted); font-size:13px; }

  /* ‚ïê‚ïê‚ïê Right Panel (Chat) ‚ïê‚ïê‚ïê */
  .right-panel {
    flex:0 0 380px; display:flex; flex-direction:column; overflow:hidden;
    background:var(--surface); border-left:1px solid var(--border);
  }
  .chat-header { padding:10px 20px; border-bottom:1px solid var(--border); display:flex; align-items:center; gap:12px; flex-shrink:0; }
  .chat-header h3 { font-size:13px; font-weight:700; }
  .chat-header .channel { font-size:11px; color:var(--muted); }
  .messages { flex:1; overflow-y:auto; padding:12px 16px; display:flex; flex-direction:column; gap:2px; }
  .msg { padding:5px 0; line-height:1.5; font-size:13px; animation:fadeIn 0.2s ease; }
  @keyframes fadeIn { from{opacity:0;transform:translateY(4px)} to{opacity:1;transform:translateY(0)} }
  .msg .time { font-size:10px; color:var(--muted); margin-right:6px; }
  .msg .sender { font-weight:700; font-size:12px; margin-right:6px; }
  .msg .content { color:var(--text); }
  .msg .content code { background:rgba(255,255,255,0.06); padding:1px 4px; border-radius:3px; font-size:12px; }
  .msg-system { font-size:11px; color:var(--muted); text-align:center; padding:8px 0; font-style:italic; }
  .typing-line { font-size:11px; color:var(--muted); padding:4px 16px; display:none; }
  .typing-line.active { display:block; }
  .typing-dots span { animation:blink 1.4s infinite; }
  .typing-dots span:nth-child(2) { animation-delay:0.2s; }
  .typing-dots span:nth-child(3) { animation-delay:0.4s; }
  @keyframes blink { 0%,100%{opacity:0.2} 50%{opacity:1} }
  .chat-input { padding:12px 16px; border-top:1px solid var(--border); display:flex; gap:8px; flex-shrink:0; }
  .chat-input input { flex:1; padding:10px 14px; background:var(--bg); border:1px solid var(--border); border-radius:8px; color:var(--text); font-size:13px; outline:none; font-family:inherit; }
  .chat-input input:focus { border-color:var(--accent); }
  .chat-input input::placeholder { color:var(--muted); }
  .chat-input button { padding:10px 16px; background:var(--accent); color:#000; border:none; border-radius:8px; font-weight:700; font-size:13px; cursor:pointer; }
  .chat-input button:hover { filter:brightness(1.1); }

  /* Upsell */
  .upsell { padding:12px 16px; background:linear-gradient(90deg,rgba(251,191,36,0.08),rgba(251,191,36,0.02)); border-top:1px solid var(--border); flex-shrink:0; display:flex; align-items:center; gap:10px; cursor:pointer; transition:background .15s; }
  .upsell:hover { background:rgba(251,191,36,0.1); }
  .upsell .upsell-icon { font-size:18px; }
  .upsell .upsell-text { flex:1; }
  .upsell .upsell-title { font-size:11px; font-weight:700; color:var(--accent); }
  .upsell .upsell-desc { font-size:10px; color:var(--muted); margin-top:1px; }
  .upsell .upsell-btn { padding:5px 12px; background:var(--accent); color:#000; border:none; border-radius:6px; font-size:10px; font-weight:700; cursor:pointer; }

  /* Hire Modal */
  .hire-overlay {
    display:none; position:fixed; top:0; left:0; right:0; bottom:0;
    background:rgba(0,0,0,0.7); z-index:50; align-items:center; justify-content:center;
    backdrop-filter:blur(4px); overflow-y:auto; padding:20px 0;
  }
  .hire-overlay.open { display:flex; }
  .hire-modal {
    width:640px; max-width:90vw; max-height:85vh;
    background:var(--surface); border:1px solid var(--border); border-radius:12px;
    display:flex; flex-direction:column; overflow:hidden;
    animation:modalIn 0.2s ease; box-shadow:0 20px 60px rgba(0,0,0,0.5);
  }
  .hire-modal-header {
    padding:20px 24px; border-bottom:1px solid var(--border);
    display:flex; align-items:center; gap:12px;
  }
  .hire-modal-header h2 { font-size:18px; font-weight:700; flex:1; }
  .hire-modal-header .close-btn {
    width:32px; height:32px; border-radius:8px; border:1px solid var(--border);
    background:none; color:var(--muted); font-size:16px; cursor:pointer;
    display:flex; align-items:center; justify-content:center;
  }
  .hire-modal-header .close-btn:hover { color:var(--text); border-color:var(--accent); }

  /* Hire views */
  .hire-view { display:none; flex:1; min-height:0; overflow-y:auto; }
  .hire-view.active { display:flex; flex-direction:column; }

  /* Browse view */
  .hire-list { flex:1; overflow-y:auto; padding:16px; min-height:0; }
  .hire-card {
    padding:20px; border:1px solid var(--border); border-radius:10px;
    margin-bottom:12px; cursor:pointer; transition:all .15s;
  }
  .hire-card:hover { border-color:rgba(251,191,36,0.3); background:rgba(251,191,36,0.02); }
  .hire-card.on-team { cursor:default; }
  .hire-card .hire-top { display:flex; align-items:center; gap:14px; margin-bottom:10px; }
  .hire-card .hire-emoji { font-size:36px; }
  .hire-card .hire-meta { flex:1; }
  .hire-card .hire-name { font-size:15px; font-weight:700; }
  .hire-card .hire-title { font-size:12px; color:var(--muted); margin-top:1px; }
  .hire-card .hire-price { font-size:12px; padding:3px 10px; border-radius:6px; font-weight:700; }
  .hire-card .hire-price.free { color:var(--green); background:rgba(34,197,94,0.1); }
  .hire-card .hire-price.paid { color:var(--accent); background:rgba(251,191,36,0.1); }
  .hire-card .on-team-badge { font-size:11px; color:var(--green); font-weight:600; }
  .hire-card .hire-desc { font-size:12px; color:var(--muted); line-height:1.5; margin-bottom:10px; }
  .hire-skills { display:flex; flex-wrap:wrap; gap:6px; }
  .hire-skill { padding:3px 8px; background:var(--surface2); border:1px solid var(--border); border-radius:5px; font-size:10px; color:var(--text); }

  /* Detail view */
  .hire-detail { padding:24px; overflow-y:auto; flex:1; }
  .hire-detail .hd-hero { text-align:center; margin-bottom:24px; }
  .hire-detail .hd-emoji { font-size:64px; margin-bottom:12px; }
  .hire-detail .hd-name { font-size:24px; font-weight:700; }
  .hire-detail .hd-title { font-size:14px; color:var(--muted); margin-top:4px; }
  .hire-detail .hd-price { display:inline-block; margin-top:10px; padding:5px 14px; border-radius:8px; font-weight:700; font-size:13px; }
  .hire-detail .hd-section { margin-bottom:20px; }
  .hire-detail .hd-section h3 { font-size:13px; font-weight:700; color:var(--accent); margin-bottom:8px; }
  .hire-detail .hd-section p { font-size:13px; color:var(--muted); line-height:1.6; }
  .hire-detail .hd-skills { display:flex; flex-wrap:wrap; gap:8px; }
  .hire-detail .hd-skill { padding:5px 12px; background:var(--surface2); border:1px solid var(--border); border-radius:6px; font-size:11px; }
  .hire-detail .hd-hire-btn {
    display:block; width:100%; padding:14px; background:var(--accent); color:#000; border:none;
    border-radius:10px; font-weight:700; font-size:15px; cursor:pointer; margin-top:20px;
    transition:filter .15s;
  }
  .hire-detail .hd-hire-btn:hover { filter:brightness(1.1); }
  .hire-detail .hd-back { background:none; border:none; color:var(--muted); font-size:12px; cursor:pointer; margin-bottom:16px; }
  .hire-detail .hd-back:hover { color:var(--text); }

  /* Onboarding view */
  .onboarding { padding:40px 24px; text-align:center; flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; }
  .onboarding .ob-emoji { font-size:80px; margin-bottom:20px; animation:bounce 0.6s ease infinite alternate; }
  @keyframes bounce { from{transform:translateY(0)} to{transform:translateY(-10px)} }
  .onboarding .ob-title { font-size:20px; font-weight:700; margin-bottom:8px; }
  .onboarding .ob-subtitle { font-size:14px; color:var(--muted); margin-bottom:24px; }
  .onboarding .ob-steps { text-align:left; max-width:300px; margin:0 auto; }
  .ob-step { display:flex; align-items:center; gap:12px; padding:8px 0; font-size:13px; color:var(--muted); transition:color 0.3s; }
  .ob-step.done { color:var(--green); }
  .ob-step.active { color:var(--text); }
  .ob-step .ob-check { width:20px; text-align:center; }
  .ob-progress { width:200px; height:4px; background:var(--border); border-radius:2px; margin-top:20px; overflow:hidden; }
  .ob-progress .ob-bar { height:100%; background:var(--accent); border-radius:2px; transition:width 0.5s ease; width:0%; }

  /* Celebration */
  .celebration { padding:40px; text-align:center; }
  .celebration .cel-emoji { font-size:80px; margin-bottom:16px; animation:celebratePop 0.5s ease; }
  @keyframes celebratePop { 0%{transform:scale(0)} 50%{transform:scale(1.2)} 100%{transform:scale(1)} }
  .celebration h2 { font-size:22px; font-weight:700; margin-bottom:8px; }
  .celebration p { font-size:14px; color:var(--muted); margin-bottom:24px; }
  .celebration .cel-btn {
    padding:12px 32px; background:var(--accent); color:#000; border:none;
    border-radius:10px; font-weight:700; font-size:14px; cursor:pointer;
  }
  .confetti { position:fixed; top:0; left:0; right:0; bottom:0; pointer-events:none; z-index:100; }
  .confetti-piece { position:absolute; width:8px; height:8px; border-radius:2px; animation:confettiFall 2s ease forwards; }
  @keyframes confettiFall { 0%{transform:translateY(-20px) rotate(0);opacity:1} 100%{transform:translateY(100vh) rotate(720deg);opacity:0} }

  /* Confirm Modal */
  .confirm-overlay {
    display:none; position:fixed; top:0; left:0; right:0; bottom:0;
    background:rgba(0,0,0,0.7); z-index:60; align-items:center; justify-content:center;
    backdrop-filter:blur(4px);
  }
  .confirm-overlay.open { display:flex; }
  .confirm-box {
    width:400px; max-width:90vw; background:var(--surface); border:1px solid var(--border);
    border-radius:12px; padding:28px; text-align:center;
    animation:modalIn 0.2s ease; box-shadow:0 20px 60px rgba(0,0,0,0.5);
  }
  .confirm-box .conf-emoji { font-size:40px; margin-bottom:12px; }
  .confirm-box h3 { font-size:16px; font-weight:700; margin-bottom:8px; }
  .confirm-box p { font-size:13px; color:var(--muted); line-height:1.5; margin-bottom:20px; }
  .confirm-box .conf-btns { display:flex; gap:12px; justify-content:center; }
  .confirm-box .conf-btn {
    padding:10px 24px; border:none; border-radius:8px; font-weight:700; font-size:13px; cursor:pointer;
  }
  .confirm-box .conf-cancel { background:var(--surface2); color:var(--text); border:1px solid var(--border); }
  .confirm-box .conf-cancel:hover { border-color:var(--text); }
  .confirm-box .conf-danger { background:var(--red); color:#fff; }
  .confirm-box .conf-danger:hover { filter:brightness(1.1); }

  /* Waitlist */
  .waitlist-gate { display:none; flex:1; flex-direction:column; align-items:center; justify-content:center; padding:40px; text-align:center; }
  .waitlist-gate.active { display:flex; }
  .waitlist-gate .big-emoji { font-size:80px; margin-bottom:24px; }
  .waitlist-gate h1 { font-family:'Press Start 2P',monospace; font-size:20px; color:var(--accent); margin-bottom:16px; line-height:1.4; }
  .waitlist-gate p { font-size:15px; color:var(--muted); line-height:1.6; max-width:480px; margin-bottom:32px; }
  .waitlist-gate .form-row { display:flex; gap:12px; max-width:400px; width:100%; }
  .waitlist-gate input { flex:1; padding:14px 18px; background:var(--surface); border:1px solid var(--border); border-radius:8px; color:var(--text); font-size:14px; outline:none; }
  .waitlist-gate input:focus { border-color:var(--accent); }
  .waitlist-gate .join-btn { padding:14px 24px; background:var(--accent); color:#000; border:none; border-radius:8px; font-weight:700; font-size:14px; cursor:pointer; white-space:nowrap; }
  .waitlist-gate .success-msg { display:none; font-size:18px; color:var(--green); }
  .waitlist-gate .success-msg.show { display:block; }
  .waitlist-gate .preview-cards { display:flex; gap:16px; margin-top:40px; flex-wrap:wrap; justify-content:center; }
  .waitlist-gate .preview-card { background:var(--surface); border:1px solid var(--border); border-radius:10px; padding:20px; width:160px; text-align:center; }
  .waitlist-gate .preview-card .emoji { font-size:28px; margin-bottom:8px; }
  .waitlist-gate .preview-card .title { font-size:12px; font-weight:700; margin-bottom:4px; }
  .waitlist-gate .preview-card .desc { font-size:10px; color:var(--muted); }
</style>
</head>
<body>

<div class="topbar">
  <span class="logo" onclick="closeDetail()">ü¶û AGENT ARENA HQ</span>
  <a href="index.html">Home</a>
  <a href="agents.html">Agents</a>
  <a href="app.html">Dashboard</a>
  <div class="spacer"></div>
  <span class="clock" id="clock"></span>
  <span class="badge offline" id="statusBadge">‚óè Offline</span>
</div>

<div class="waitlist-gate" id="waitlistGate">
  <div class="big-emoji">ü¶û</div>
  <h1>Agent Arena HQ</h1>
  <p>Your AI team's virtual office. Watch them work, join meetings, and collaborate in real-time.</p>
  <div class="form-row" id="waitlistForm">
    <input type="email" id="waitlistEmail" placeholder="you@example.com">
    <button class="join-btn" onclick="submitWaitlist()">Get Early Access ü¶û</button>
  </div>
  <div class="success-msg" id="waitlistSuccess">‚úÖ You're on the list!</div>
  <div class="preview-cards">
    <div class="preview-card"><div class="emoji">üè¢</div><div class="title">Virtual Office</div><div class="desc">See your agents at their desks</div></div>
    <div class="preview-card"><div class="emoji">üìã</div><div class="title">Control Plane</div><div class="desc">See every action in real-time</div></div>
    <div class="preview-card"><div class="emoji">üîí</div><div class="title">100% Local</div><div class="desc">Agents never leave your machine</div></div>
  </div>
</div>

<div class="main" id="mainLayout" style="display:none;">
  <!-- Office -->
  <div class="office" id="office">
    <div class="wall"></div>
    <div class="wall-item title">AGENT ARENA HQ</div>
    <div class="wall-item poster p1">üìä Q1 Goals</div>
    <div class="wall-item poster p2">üöÄ Ship It</div>
    <div class="wall-item window"></div>
    <div class="wall-item whiteboard">üìã Sprint<br>‚Üí Launch v1<br>‚Üí Get users<br>‚Üí Revenue</div>
    <div class="deco plant1">ü™¥</div>
    <div class="deco plant2">üåø</div>
    <div class="deco cat" id="officeCat" title="Click me!">üò∫</div>
    <div class="deco coffee">‚òï</div>
    <div class="deco clock-w" id="wallClock">üïê</div>
    <div class="deco rug"></div>
    <div class="desk-area" id="deskArea"></div>
    <div class="floor"></div>
    <div class="meeting-bar">
      <span class="label">üéôÔ∏è Team Standup</span>
      <span class="parts" id="meetingParts">No agents online</span>
      <div class="spacer"></div>
      <button class="start-btn" id="startBtn" onclick="startMeeting()">Start Meeting</button>
      <button class="end-btn" id="endBtn" onclick="endMeeting()">End Meeting</button>
    </div>

  </div><!-- end .office -->

  <!-- Agent Detail Modal -->
  <div class="agent-detail-overlay" id="agentDetailOverlay" onclick="if(event.target===this)closeDetail()">
    <div class="agent-detail" id="agentDetail">
      <div class="detail-header">
        <button class="back-btn" onclick="closeDetail()">‚Üê</button>
        <div class="agent-info">
          <div class="agent-name" id="detailName">ü§ñ Agent</div>
          <div class="agent-role" id="detailRole">Role</div>
        </div>
        <span class="status-pill online" id="detailStatus">‚óè Online</span>
      </div>
      <div class="detail-stats" id="detailStats">
        <div class="stat-card"><div class="stat-value" id="statSessions">-</div><div class="stat-label">Sessions</div></div>
        <div class="stat-card"><div class="stat-value" id="statMessages">-</div><div class="stat-label">Messages</div></div>
        <div class="stat-card"><div class="stat-value" id="statTools">-</div><div class="stat-label">Tool Calls</div></div>
      </div>
      <div class="detail-tabs">
        <button class="detail-tab active" onclick="switchDetailTab('timeline')">üïê Timeline</button>
        <button class="detail-tab" onclick="switchDetailTab('sessions')">üìÇ Sessions</button>
      </div>
      <div class="detail-content">
        <div class="detail-section active" id="sectionTimeline">
          <div class="detail-loading" id="timelineLoading">Loading activity...</div>
          <div class="timeline" id="timeline"></div>
        </div>
        <div class="detail-section" id="sectionSessions">
          <div class="sessions-list" id="sessionsList"></div>
        </div>
      </div>
    </div>
  </div><!-- end agent detail modal -->

  <!-- Hire Modal -->
  <div class="hire-overlay" id="hireOverlay" onclick="if(event.target===this)closeHireModal()">
    <div class="hire-modal">
      <div class="hire-modal-header" id="hireModalHeader">
        <h2 id="hireModalTitle">‚ö° Hire an Agent</h2>
        <button class="close-btn" onclick="closeHireModal()">‚úï</button>
      </div>
      <!-- Browse View -->
      <div class="hire-view active" id="hireBrowse">
        <div class="hire-list" id="hireList"></div>
      </div>
      <!-- Detail View -->
      <div class="hire-view hire-detail" id="hireDetailView"></div>
      <!-- Onboarding View -->
      <div class="hire-view onboarding" id="hireOnboarding"></div>
      <!-- Celebration View -->
      <div class="hire-view celebration" id="hireCelebration"></div>
    </div>
  </div>

  <!-- Right Panel: Chat -->
  <div class="right-panel">
    <div class="chat-header">
      <h3>üí¨ #general</h3>
      <span class="channel">Team Chat</span>
    </div>
    <div class="messages" id="messages"></div>
    <div class="typing-line" id="typingLine">
      <span id="typingWho"></span> is typing<span class="typing-dots"><span>.</span><span>.</span><span>.</span></span>
    </div>
    <div class="chat-input">
      <input type="text" id="chatInput" placeholder="Message your team..." autocomplete="off">
      <button onclick="sendMessage()">Send</button>
    </div>
    <div class="upsell" onclick="openHireModal()">
      <div class="upsell-icon">‚ö°</div>
      <div class="upsell-text">
        <div class="upsell-title">Grow Your Team</div>
        <div class="upsell-desc" id="upsellDesc">Hire more agents for your team</div>
      </div>
      <button class="upsell-btn">Hire Agents</button>
    </div>
  </div>
</div>

<!-- Confirm Modal -->
<div class="confirm-overlay" id="confirmOverlay">
  <div class="confirm-box" id="confirmBox"></div>
</div>

<script>
let ws=null, agents=[], registeredAgents=[], sessions={}, streamBuffers={}, selectedAgent=null;
const LOCAL=`${location.protocol}//${location.host}`;

// Stable client ID ‚Äî persists across refreshes so agent sessions carry over
function getClientId() {
  let id = localStorage.getItem('hq-client-id');
  if (!id) { id = crypto.randomUUID().slice(0,8); localStorage.setItem('hq-client-id', id); }
  return id;
}
const CLIENT_ID = getClientId();

async function init() {
  updateClock(); setInterval(updateClock,30000);
  setupInput(); setupCat();
  await checkConnection();
}

async function checkConnection() {
  try {
    const res=await fetch(`${LOCAL}/api/agents`,{signal:AbortSignal.timeout(3000)});
    if(!res.ok) throw 0;
    updateStatus(true);
    document.getElementById('mainLayout').style.display='flex';
    await loadAgents(); connectWS(); loadChat(); updateUpsell();
  } catch { document.getElementById('waitlistGate').classList.add('active'); updateStatus(false); }
}

async function loadAgents() {
  const [a,r]=await Promise.all([fetch(`${LOCAL}/api/agents`).then(r=>r.json()),fetch(`${LOCAL}/api/agents/registered`).then(r=>r.json())]);
  agents=a; registeredAgents=r; renderDesks(); updateMeetingParts();
}

function isInstalled(a) {
  const regIds=new Set(registeredAgents.map(x=>x.id));
  return regIds.has(a.name.replace(/-agent$/,''))||regIds.has(a.agentId);
}

function renderDesks() {
  const area=document.getElementById('deskArea');
  const installed=agents.filter(isInstalled);
  const uninstalled=agents.filter(a=>!isInstalled(a));

  let html=installed.map(agent=>{
    const id=agent.agentId||agent.name.replace(/-agent$/,'');
    return `
      <div class="desk active" data-agent="${agent.name}" onclick="openAgentDetail('${agent.name}')">
        <button class="fire-btn" onclick="event.stopPropagation();fireAgent('${agent.name}')" title="Remove from team">‚úï</button>
        <div class="speech-bubble" id="bubble-${id}"></div>
        <div class="agent-avatar">${agent.emoji||'ü§ñ'}<div class="status-dot online" id="dot-${id}"></div></div>
        <div class="agent-label">${agent.displayName||agent.name}</div>
        <div class="desk-obj"><div class="desk-monitor"><div class="glow"></div></div></div>
      </div>`;
  }).join('');

  // No greyed-out desks ‚Äî uninstalled agents only available via Hire page
  html+=`<div class="add-agent-desk" onclick="openHireModal()"><div class="add-circle">+</div><div class="add-label">Hire Agent</div></div>`;
  area.innerHTML=html;
}

// ‚ïê‚ïê‚ïê Agent Detail ‚ïê‚ïê‚ïê
async function openAgentDetail(agentName) {
  const agent=agents.find(a=>a.name===agentName);
  if(!agent) return;
  selectedAgent=agent;

  // Highlight desk
  document.querySelectorAll('.desk').forEach(d=>d.classList.remove('selected'));
  document.querySelector(`.desk[data-agent="${agentName}"]`)?.classList.add('selected');

  // Fill header
  document.getElementById('detailName').innerHTML=`${agent.emoji||'ü§ñ'} ${agent.displayName||agent.name}`;
  document.getElementById('detailRole').textContent=agent.title||agent.description||'';

  // Show modal
  document.getElementById('agentDetailOverlay').classList.add('open');

  // Reset
  document.getElementById('timeline').innerHTML='';
  document.getElementById('timelineLoading').style.display='block';
  document.getElementById('statSessions').textContent='-';
  document.getElementById('statMessages').textContent='-';
  document.getElementById('statTools').textContent='-';
  switchDetailTab('timeline');

  // Fetch activity
  try {
    const res=await fetch(`${LOCAL}/api/agents/${agentName}/activity`);
    const data=await res.json();
    renderAgentActivity(data);
  } catch(e) {
    document.getElementById('timelineLoading').textContent='Failed to load activity';
  }
}

function renderAgentActivity(data) {
  const {sessions:sess, history}=data;
  document.getElementById('timelineLoading').style.display='none';

  // Stats
  document.getElementById('statSessions').textContent=sess.length;
  let msgCount=0, toolCount=0;

  // Build timeline from history
  const tl=document.getElementById('timeline');
  if(!history||!history.length) {
    tl.innerHTML='<div class="detail-loading">No recent activity found.</div>';
  } else {
    let html='';
    for(const msg of history) {
      const role=msg.role||'unknown';
      const text=msg.text||'';
      const tools=msg.toolCalls||[];
      const time=msg.timestamp?new Date(msg.timestamp):null;
      const timeStr=time?time.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}):'';

      if(role==='assistant') {
        msgCount++;
        if(tools.length) {
          for(const tc of tools) {
            toolCount++;
            html+=`<div class="tl-item">
              <div class="tl-icon tool">üîß</div>
              <div class="tl-body">
                <div class="tl-title">Used tool <span class="tool-badge">${esc(tc.name||'tool')}</span></div>
                <div class="tl-preview" onclick="this.classList.toggle('expanded')">${esc((tc.input||'').slice(0,300))}</div>
                <div class="tl-time">${timeStr}</div>
              </div></div>`;
          }
        }
        if(text) {
          html+=`<div class="tl-item">
            <div class="tl-icon msg">üí¨</div>
            <div class="tl-body">
              <div class="tl-title">Sent a message</div>
              <div class="tl-preview" onclick="this.classList.toggle('expanded')">${esc(text.slice(0,500))}</div>
              ${text.length>200?'<div class="tl-expand" onclick="this.previousElementSibling.classList.toggle(\'expanded\')">show more</div>':''}
              <div class="tl-time">${timeStr}</div>
            </div></div>`;
        }
      } else if(role==='user') {
        if(text) {
          html+=`<div class="tl-item">
            <div class="tl-icon sys">üë§</div>
            <div class="tl-body">
              <div class="tl-title">Received input</div>
              <div class="tl-preview" onclick="this.classList.toggle('expanded')">${esc(text.slice(0,300))}</div>
              <div class="tl-time">${timeStr}</div>
            </div></div>`;
        }
      } else if(role==='tool'||role==='toolResult') {
        html+=`<div class="tl-item">
          <div class="tl-icon tool">üìÑ</div>
          <div class="tl-body">
            <div class="tl-title">Tool result</div>
            <div class="tl-preview" onclick="this.classList.toggle('expanded')">${esc((text||'(result)').slice(0,200))}</div>
            <div class="tl-time">${timeStr}</div>
          </div></div>`;
      }
    }
    tl.innerHTML=html||'<div class="detail-loading">No activity to display.</div>';
  }

  document.getElementById('statMessages').textContent=msgCount;
  document.getElementById('statTools').textContent=toolCount;

  // Sessions list
  const sl=document.getElementById('sessionsList');
  sl.innerHTML=sess.map(s=>{
    const t=s.updatedAt?timeAgo(new Date(s.updatedAt)):'';
    const label=s.label||s.key?.split(':').pop()||'session';
    return `<div class="session-item">
      <div class="sess-header">
        <span class="sess-label">${esc(label)}</span>
        <span class="sess-kind">${s.kind||'chat'}</span>
      </div>
      <div class="sess-time">${t}${s.model?' ¬∑ '+s.model:''}</div>
    </div>`;
  }).join('')||'<div class="detail-loading">No sessions found.</div>';
}

function extractMsgText(msg) {
  if(typeof msg.content==='string') return msg.content;
  if(Array.isArray(msg.content)) return msg.content.filter(c=>c.type==='text').map(c=>c.text).join('');
  return msg.text||'';
}

function closeDetail() {
  document.getElementById('agentDetailOverlay').classList.remove('open');
  document.querySelectorAll('.desk').forEach(d=>d.classList.remove('selected'));
  selectedAgent=null;
}

function switchDetailTab(tab) {
  document.querySelectorAll('.detail-tab').forEach((t,i)=>{
    t.classList.toggle('active',(i===0&&tab==='timeline')||(i===1&&tab==='sessions'));
  });
  document.getElementById('sectionTimeline').classList.toggle('active',tab==='timeline');
  document.getElementById('sectionSessions').classList.toggle('active',tab==='sessions');
}

// ‚ïê‚ïê‚ïê Hire Modal ‚ïê‚ïê‚ïê
function showHireView(view) {
  document.querySelectorAll('.hire-view').forEach(v=>{v.classList.remove('active');v.style.display='none';});
  const el=document.getElementById(view);
  el.classList.add('active');
  el.style.display='flex';
}

function openHireModal() {
  document.getElementById('hireModalTitle').textContent='‚ö° Hire an Agent';
  renderHireList();
  showHireView('hireBrowse');
  document.getElementById('hireOverlay').classList.add('open');
}

function closeHireModal() {
  document.getElementById('hireOverlay').classList.remove('open');
}

function renderHireList() {
  const list=document.getElementById('hireList');
  const installedSet=new Set(agents.filter(isInstalled).map(a=>a.name));

  list.innerHTML=agents.map(agent=>{
    const installed=installedSet.has(agent.name);
    const price=formatPrice(agent.price);
    const priceClass=(!agent.price||agent.price==='FREE')?'free':'paid';
    const skills=(agent.skills||[]).slice(0,5);
    return `<div class="hire-card ${installed?'on-team':''}" onclick="${installed?'':`showAgentDetail('${agent.name}')`}">
      <div class="hire-top">
        <div class="hire-emoji">${agent.emoji||'ü§ñ'}</div>
        <div class="hire-meta">
          <div class="hire-name">${agent.displayName||agent.name}</div>
          <div class="hire-title">${agent.title||''}</div>
        </div>
        ${installed
          ?'<span class="on-team-badge">‚úì On Team</span>'
          :`<span class="hire-price ${priceClass}">${price}</span>`
        }
      </div>
      <div class="hire-desc">${agent.description||agent.desc||''}</div>
      ${skills.length?`<div class="hire-skills">${skills.map(s=>`<span class="hire-skill">${esc(s)}</span>`).join('')}</div>`:''}
    </div>`;
  }).join('');
}

function showAgentDetail(agentName) {
  const agent=agents.find(a=>a.name===agentName);
  if(!agent) return;
  document.getElementById('hireModalTitle').textContent='Agent Details';
  const price=formatPrice(agent.price);
  const priceClass=(!agent.price||agent.price==='FREE')?'free':'paid';
  const skills=agent.skills||[];
  const tags=agent.tags||[];

  document.getElementById('hireDetailView').innerHTML=`
    <button class="hd-back" onclick="showHireView('hireBrowse');document.getElementById('hireModalTitle').textContent='‚ö° Hire an Agent'">‚Üê Back to agents</button>
    <div class="hd-hero">
      <div class="hd-emoji">${agent.emoji||'ü§ñ'}</div>
      <div class="hd-name">${agent.displayName||agent.name}</div>
      <div class="hd-title">${agent.title||''}</div>
      <div class="hd-price ${priceClass}">${price}</div>
    </div>
    <div class="hd-section">
      <h3>About</h3>
      <p>${agent.description||agent.desc||'A powerful AI agent ready to join your team.'}</p>
    </div>
    ${skills.length?`<div class="hd-section">
      <h3>Skills & Tools</h3>
      <div class="hd-skills">${skills.map(s=>`<span class="hd-skill">üîß ${esc(s)}</span>`).join('')}</div>
    </div>`:''}
    ${tags.length?`<div class="hd-section">
      <h3>Tags</h3>
      <div class="hd-skills">${tags.map(t=>`<span class="hd-skill">${esc(t)}</span>`).join('')}</div>
    </div>`:''}
    <button class="hd-hire-btn" onclick="startOnboarding('${agent.name}')">Hire ${agent.displayName||agent.name} ‚Üí</button>
  `;
  showHireView('hireDetailView');
}

async function startOnboarding(agentName) {
  const agent=agents.find(a=>a.name===agentName);
  const name=agent?.displayName||agentName;
  document.getElementById('hireModalTitle').textContent='Onboarding';

  document.getElementById('hireOnboarding').innerHTML=`
    <div class="ob-emoji">${agent?.emoji||'ü§ñ'}</div>
    <div class="ob-title">Hiring ${name}...</div>
    <div class="ob-subtitle">Setting up their workspace and tools</div>
    <div class="ob-steps">
      <div class="ob-step active" id="ob-step-1"><span class="ob-check">‚è≥</span> Creating workspace</div>
      <div class="ob-step" id="ob-step-2"><span class="ob-check">‚óã</span> Installing personality</div>
      <div class="ob-step" id="ob-step-3"><span class="ob-check">‚óã</span> Configuring tools</div>
      <div class="ob-step" id="ob-step-4"><span class="ob-check">‚óã</span> Booting agent</div>
    </div>
    <div class="ob-progress"><div class="ob-bar" id="obBar"></div></div>
  `;
  showHireView('hireOnboarding');

  // Animate steps while installing
  const steps=['ob-step-1','ob-step-2','ob-step-3','ob-step-4'];
  const bar=document.getElementById('obBar');
  let step=0;

  function advanceStep() {
    if(step>0) {
      const prev=document.getElementById(steps[step-1]);
      if(prev){prev.classList.remove('active');prev.classList.add('done');prev.querySelector('.ob-check').textContent='‚úì';}
    }
    if(step<steps.length) {
      const cur=document.getElementById(steps[step]);
      if(cur){cur.classList.add('active');cur.querySelector('.ob-check').textContent='‚è≥';}
      bar.style.width=((step+1)/steps.length*100)+'%';
    }
    step++;
  }

  // Step 1: Creating workspace
  advanceStep();
  await sleep(800);

  // Step 2: Installing personality
  advanceStep();

  // Actually install
  try {
    const res=await fetch(`${LOCAL}/api/agents/${agentName}/install`,{method:'POST'});
    const data=await res.json();
    if(!data.ok) throw new Error(data.error);
  } catch(e) {
    alert('Hire failed: '+e.message);
    showHireView('hireBrowse');
    return;
  }

  await sleep(600);
  // Step 3: Configuring tools
  advanceStep();
  await sleep(800);

  // Step 4: Booting agent
  advanceStep();
  await sleep(1000);

  // Final step done
  const last=document.getElementById(steps[3]);
  if(last){last.classList.remove('active');last.classList.add('done');last.querySelector('.ob-check').textContent='‚úì';}
  bar.style.width='100%';

  await sleep(500);

  // Show celebration
  showCelebration(agent);
}

function showCelebration(agent) {
  const name=agent?.displayName||agent?.name||'Agent';
  document.getElementById('hireModalTitle').textContent='üéâ Welcome!';

  document.getElementById('hireCelebration').innerHTML=`
    <div class="cel-emoji">${agent?.emoji||'ü§ñ'}</div>
    <h2>${name} has joined the team!</h2>
    <p>They're at their desk and ready to work. Say hi in the team chat!</p>
    <button class="cel-btn" onclick="finishHiring()">Go to HQ ‚Üí</button>
  `;
  showHireView('hireCelebration');

  // Confetti!
  spawnConfetti();

  // Reload agents in background
  loadAgents().then(()=>updateUpsell());
}

function finishHiring() {
  closeHireModal();
  // Desk already updated from loadAgents()
  addSystemMsg('üéâ New team member is at their desk!');
}

function spawnConfetti() {
  const container=document.createElement('div');
  container.className='confetti';
  document.body.appendChild(container);
  const colors=['#fbbf24','#22c55e','#3b82f6','#ef4444','#a78bfa','#f472b6'];
  for(let i=0;i<60;i++){
    const piece=document.createElement('div');
    piece.className='confetti-piece';
    piece.style.left=Math.random()*100+'%';
    piece.style.background=colors[Math.floor(Math.random()*colors.length)];
    piece.style.animationDelay=Math.random()*1+'s';
    piece.style.animationDuration=(1.5+Math.random()*1.5)+'s';
    container.appendChild(piece);
  }
  setTimeout(()=>container.remove(),4000);
}

function formatPrice(p) {
  if(!p||p==='FREE') return 'FREE';
  if(typeof p==='object') return `$${p.amount}/${p.interval}`;
  return p;
}

function sleep(ms){return new Promise(r=>setTimeout(r,ms));}

// ‚ïê‚ïê‚ïê Fire Agent ‚ïê‚ïê‚ïê
function fireAgent(agentName) {
  const agent=agents.find(a=>a.name===agentName);
  const name=agent?.displayName||agentName;
  const emoji=agent?.emoji||'ü§ñ';

  document.getElementById('confirmBox').innerHTML=`
    <div class="conf-emoji">${emoji}</div>
    <h3>Remove ${esc(name)}?</h3>
    <p>They'll leave your team but their workspace and memory files will be kept. You can always hire them back later.</p>
    <div class="conf-btns">
      <button class="conf-btn conf-cancel" onclick="document.getElementById('confirmOverlay').classList.remove('open')">Keep on Team</button>
      <button class="conf-btn conf-danger" onclick="doFireAgent('${agentName}')">Remove Agent</button>
    </div>
  `;
  document.getElementById('confirmOverlay').classList.add('open');
}

async function doFireAgent(agentName) {
  document.getElementById('confirmOverlay').classList.remove('open');
  const agent=agents.find(a=>a.name===agentName);
  const name=agent?.displayName||agentName;
  try {
    const res=await fetch(`${LOCAL}/api/agents/${agentName}/fire`,{method:'POST'});
    const data=await res.json();
    if(data.ok) { addSystemMsg(`üëã ${name} has left the team.`); setTimeout(()=>{loadAgents();updateUpsell()},2000); }
    else throw new Error(data.error);
  } catch(e) { alert('Failed to remove: '+e.message); }
}

// ‚ïê‚ïê‚ïê WebSocket ‚ïê‚ïê‚ïê
function connectWS() {
  if(ws&&ws.readyState===WebSocket.OPEN) return;
  ws=new WebSocket(`ws://${location.host}`);
  ws.onopen=()=>{updateStatus(true);ws.send(JSON.stringify({type:'identify',clientId:CLIENT_ID}));};
  ws.onclose=()=>{updateStatus(false);setTimeout(connectWS,3000)};
  ws.onmessage=e=>{try{handleMsg(JSON.parse(e.data))}catch(err){console.error(err)}};
}
function handleMsg(msg) {
  if(msg.type==='status') updateStatus(msg.connected);
  if(msg.type==='chat-delta') onDelta(msg);
  if(msg.type==='chat-final') onFinal(msg);
}
function onDelta(msg) {
  const text=extractText(msg.message); if(!text) return;
  // chat-delta contains FULL cumulative text, not incremental
  streamBuffers[msg.runId]=text;
  if(msg.sessionKey) sessions[msg.agentPkg]=msg.sessionKey;
  const agent=agents.find(a=>a.name===msg.agentPkg);
  const id=agent?.agentId||msg.agentPkg.replace(/-agent$/,'');
  showTyping(agent?.displayName||id);
  const bubble=document.getElementById(`bubble-${id}`);
  if(bubble){bubble.textContent=(streamBuffers[msg.runId]||'').slice(-60);bubble.classList.add('visible');}
  const dot=document.getElementById(`dot-${id}`);
  if(dot) dot.className='status-dot busy';
}
function onFinal(msg) {
  const text=streamBuffers[msg.runId]||extractText(msg.message);
  delete streamBuffers[msg.runId];
  if(msg.sessionKey) sessions[msg.agentPkg]=msg.sessionKey;
  const agent=agents.find(a=>a.name===msg.agentPkg);
  const id=agent?.agentId||msg.agentPkg.replace(/-agent$/,'');
  if(text){addChatMsg(agent?.displayName||id,text,agent?.emoji||'ü§ñ');saveChat();}
  hideTyping();
  const bubble=document.getElementById(`bubble-${id}`);
  if(bubble) setTimeout(()=>bubble.classList.remove('visible'),3000);
  const dot=document.getElementById(`dot-${id}`);
  if(dot) dot.className='status-dot online';
}
function extractText(m){if(typeof m==='string')return m;if(Array.isArray(m))return m.filter(p=>p.type==='text').map(p=>p.text).join('');if(m?.content)return extractText(m.content);return m?.text||'';}

// ‚ïê‚ïê‚ïê Chat ‚ïê‚ïê‚ïê
function sendMessage(){
  const input=document.getElementById('chatInput');const text=input.value.trim();
  if(!text||!ws||ws.readyState!==WebSocket.OPEN)return;
  input.value=''; addChatMsg('You',text,'üë§');
  agents.filter(isInstalled).forEach(agent=>{
    ws.send(JSON.stringify({type:'chat',agentPkg:agent.name,message:text,sessionKey:sessions[agent.name]||null}));
  });
  saveChat();
}
function addChatMsg(sender,text,emoji){
  const c=document.getElementById('messages');const el=document.createElement('div');el.className='msg';
  const now=new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
  const color=sender==='You'?'var(--accent)':'var(--green)';
  let html=esc(text).replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/`([^`]+)`/g,'<code>$1</code>').replace(/\n/g,'<br>');
  el.innerHTML=`<span class="time">${now}</span><span class="sender" style="color:${color}">${emoji} ${sender}</span><span class="content">${html}</span>`;
  c.appendChild(el);c.scrollTop=c.scrollHeight;
}
function addSystemMsg(text){const c=document.getElementById('messages');const el=document.createElement('div');el.className='msg-system';el.textContent=text;c.appendChild(el);c.scrollTop=c.scrollHeight;}
function showTyping(name){document.getElementById('typingWho').textContent=name;document.getElementById('typingLine').classList.add('active');}
function hideTyping(){document.getElementById('typingLine').classList.remove('active');}
function saveChat(){localStorage.setItem('hq-chat',document.getElementById('messages').innerHTML);localStorage.setItem('hq-sessions',JSON.stringify(sessions));}
function loadChat(){const s=localStorage.getItem('hq-chat');if(s)document.getElementById('messages').innerHTML=s;const ss=localStorage.getItem('hq-sessions');if(ss)sessions=JSON.parse(ss);document.getElementById('messages').scrollTop=document.getElementById('messages').scrollHeight;}

// ‚ïê‚ïê‚ïê Meeting ‚ïê‚ïê‚ïê
function startMeeting(){document.getElementById('startBtn').style.display='none';document.getElementById('endBtn').style.display='block';addSystemMsg('üéôÔ∏è Team standup started');const inp=document.getElementById('chatInput');const old=inp.value;inp.value="Quick standup: What are you working on? Any blockers? Keep it brief.";sendMessage();inp.value=old;}
function endMeeting(){document.getElementById('startBtn').style.display='block';document.getElementById('endBtn').style.display='none';addSystemMsg('üéôÔ∏è Standup ended');}

// ‚ïê‚ïê‚ïê Helpers ‚ïê‚ïê‚ïê
function updateStatus(on){const b=document.getElementById('statusBadge');b.textContent=on?'‚óè Online':'‚óè Offline';b.className=`badge ${on?'online':'offline'}`;}
function updateClock(){const now=new Date();document.getElementById('clock').textContent=now.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});const h=now.getHours()%12;const clocks=['üïõ','üïê','üïë','üïí','üïì','üïî','üïï','üïñ','üïó','üïò','üïô','üïö'];const el=document.getElementById('wallClock');if(el)el.textContent=clocks[h];}
function updateMeetingParts(){const online=agents.filter(isInstalled);document.getElementById('meetingParts').textContent=online.length>0?`${online.map(a=>a.emoji||'ü§ñ').join(' ')} ${online.length} agent${online.length>1?'s':''} ready`:'No agents online';}
function updateUpsell(){const c=agents.filter(isInstalled).length;const a=agents.length-c;document.getElementById('upsellDesc').textContent=a>0?`${a} more agent${a>1?'s':''} available`:'Hire from the marketplace';}
function setupInput(){document.getElementById('chatInput').addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMessage();}});}
function setupCat(){const cat=document.getElementById('officeCat');const f=['üò∫','üò∏','üòπ','üòª','üòº','üòΩ','üôÄ','üòø','üòæ'];let i=0;cat.addEventListener('click',()=>{i=(i+1)%f.length;cat.textContent=f[i];});}
function timeAgo(d){const s=Math.floor((Date.now()-d.getTime())/1000);if(s<60)return'just now';if(s<3600)return`${Math.floor(s/60)}m ago`;if(s<86400)return`${Math.floor(s/3600)}h ago`;return`${Math.floor(s/86400)}d ago`;}
function esc(t){const d=document.createElement('div');d.textContent=t;return d.innerHTML;}
async function submitWaitlist(){const email=document.getElementById('waitlistEmail').value.trim();if(!email||!email.includes('@'))return alert('Enter a valid email.');try{await fetch('/api/waitlist',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,source:'hq',timestamp:new Date().toISOString()})});}catch{const l=JSON.parse(localStorage.getItem('waitlist-emails')||'[]');l.push({email,timestamp:new Date().toISOString()});localStorage.setItem('waitlist-emails',JSON.stringify(l));}document.getElementById('waitlistForm').style.display='none';document.getElementById('waitlistSuccess').classList.add('show');}

init();
</script>
</body>
</html>
