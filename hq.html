<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ü¶û</text></svg>">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Agent HQ</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Satoshi:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0a0a0f; --bg2: #0e0e15; --surface: #13131c; --surface2: #1a1a26;
  --surface3: #22222f; --border: #2a2a3a; --border2: #353548;
  --text: #e8e8ed; --text2: #a0a0b0; --muted: #6a6a7a;
  --accent: #f0b429; --accent2: #d49b20; --accent-dim: rgba(240,180,41,0.08);
  --green: #34d399; --green-dim: rgba(52,211,153,0.1);
  --red: #f87171; --red-dim: rgba(248,113,113,0.1);
  --blue: #60a5fa; --blue-dim: rgba(96,165,250,0.1);
  --purple: #a78bfa; --purple-dim: rgba(167,139,250,0.1);
  --pink: #f472b6;
  --sidebar-w: 250px;
  --radius: 8px; --radius-sm: 5px; --radius-lg: 12px;
}
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:'Satoshi',system-ui,sans-serif; background:var(--bg); color:var(--text); height:100vh; overflow:hidden; }
::-webkit-scrollbar { width:6px; }
::-webkit-scrollbar-track { background:transparent; }
::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }
::-webkit-scrollbar-thumb:hover { background:var(--border2); }
::selection { background:rgba(240,180,41,0.25); }
input,button,textarea { font-family:inherit; }

/* ‚ïê‚ïê‚ïê Layout ‚ïê‚ïê‚ïê */
.app { display:flex; height:100vh; }

/* ‚ïê‚ïê‚ïê Sidebar ‚ïê‚ïê‚ïê */
.sidebar {
  width:var(--sidebar-w); background:var(--bg2); border-right:1px solid var(--border);
  display:flex; flex-direction:column; flex-shrink:0; user-select:none;
}
.sidebar-header {
  padding:16px 16px 12px; border-bottom:1px solid var(--border);
  display:flex; align-items:center; gap:10px;
}
.sidebar-header .logo {
  font-family:'JetBrains Mono',monospace; font-size:13px; font-weight:700;
  color:var(--accent); letter-spacing:-0.5px;
}
.sidebar-header .status-dot-sm {
  width:8px; height:8px; border-radius:50%; background:var(--green);
  box-shadow:0 0 6px rgba(52,211,153,0.4);
}
.sidebar-header .status-dot-sm.off { background:var(--red); box-shadow:0 0 6px rgba(248,113,113,0.4); }

.sidebar-nav { flex:1; overflow-y:auto; padding:8px 0; }

.nav-section { padding:0 12px; margin-bottom:4px; }
.nav-section-title {
  font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:1.2px;
  color:var(--muted); padding:8px 4px 4px; display:flex; align-items:center; gap:6px;
}
.nav-section-title .section-action {
  margin-left:auto; font-size:12px; cursor:pointer; opacity:0; transition:opacity .15s;
  color:var(--text2);
}
.nav-section:hover .section-action { opacity:1; }
.nav-section-title .section-action:hover { color:var(--accent); }

.nav-item {
  display:flex; align-items:center; gap:8px; padding:5px 8px; margin:1px 0;
  border-radius:var(--radius-sm); cursor:pointer; transition:all .1s;
  font-size:13px; color:var(--text2); position:relative;
}
.nav-item:hover { background:var(--surface); color:var(--text); }
.nav-item.active { background:var(--accent-dim); color:var(--accent); font-weight:600; }
.nav-item .nav-icon { width:18px; text-align:center; font-size:13px; flex-shrink:0; }
.nav-item .nav-label { flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.nav-item .nav-badge {
  font-size:9px; font-weight:700; padding:1px 5px; border-radius:8px;
  background:var(--red); color:#fff; min-width:16px; text-align:center;
  animation:badgePop .2s ease;
}
@keyframes badgePop { from{transform:scale(0)} to{transform:scale(1)} }
.nav-item.unread { color:var(--text); font-weight:600; }
.nav-item.unread .nav-label { color:var(--text); }
.nav-item .status-indicator {
  width:6px; height:6px; border-radius:50%; flex-shrink:0;
}
.nav-item .status-indicator.online { background:var(--green); }
.nav-item .status-indicator.offline { background:var(--muted); }
.nav-item .status-indicator.busy { background:var(--accent); animation:pulse 1.5s infinite; }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

.nav-divider { height:1px; background:var(--border); margin:8px 12px; }

/* Sidebar footer */
.sidebar-footer {
  padding:12px; border-top:1px solid var(--border);
  display:flex; align-items:center; gap:8px;
}
.sidebar-footer .user-avatar {
  width:30px; height:30px; border-radius:var(--radius-sm); background:var(--surface2);
  display:flex; align-items:center; justify-content:center; font-size:16px;
}
.sidebar-footer .user-info { flex:1; min-width:0; }
.sidebar-footer .user-name { font-size:12px; font-weight:600; }
.sidebar-footer .user-role { font-size:10px; color:var(--muted); }
.sidebar-footer .settings-btn {
  width:28px; height:28px; border-radius:var(--radius-sm); border:none;
  background:none; color:var(--muted); cursor:pointer; font-size:14px;
  display:flex; align-items:center; justify-content:center; transition:all .15s;
}
.sidebar-footer .settings-btn:hover { color:var(--text); background:var(--surface); }

/* ‚ïê‚ïê‚ïê Main Content ‚ïê‚ïê‚ïê */
.main-content { flex:1; display:flex; flex-direction:column; min-width:0; }

/* Channel Header */
.channel-header {
  padding:12px 20px; border-bottom:1px solid var(--border);
  display:flex; align-items:center; gap:12px; flex-shrink:0;
  background:var(--bg);
}
.channel-header .ch-icon { font-size:16px; }
.channel-header .ch-info { flex:1; }
.channel-header .ch-name { font-size:14px; font-weight:700; display:flex; align-items:center; gap:6px; }
.channel-header .ch-topic { font-size:11px; color:var(--muted); margin-top:1px; }
.channel-header .ch-actions { display:flex; gap:4px; }
.ch-action-btn {
  width:32px; height:32px; border-radius:var(--radius-sm); border:1px solid var(--border);
  background:none; color:var(--text2); cursor:pointer; font-size:14px;
  display:flex; align-items:center; justify-content:center; transition:all .15s;
}
.ch-action-btn:hover { color:var(--text); border-color:var(--accent); background:var(--accent-dim); }
.ch-action-btn.active { color:var(--accent); border-color:var(--accent); background:var(--accent-dim); }

/* Messages Area */
.messages-area { flex:1; overflow-y:auto; padding:16px 20px; display:flex; flex-direction:column; }
.messages-area .spacer { flex:1; }

/* Message styles */
.message-group { display:flex; gap:10px; padding:4px 0; margin:2px 0; border-radius:var(--radius); }
.message-group:hover { background:rgba(255,255,255,0.015); }
.message-group .msg-avatar {
  width:34px; height:34px; border-radius:var(--radius-sm); flex-shrink:0;
  display:flex; align-items:center; justify-content:center; font-size:18px;
  background:var(--surface2); margin-top:2px;
}
.message-group .msg-body { flex:1; min-width:0; }
.message-group .msg-header { display:flex; align-items:baseline; gap:8px; margin-bottom:2px; }
.message-group .msg-sender { font-size:13px; font-weight:700; }
.message-group .msg-sender.you { color:var(--accent); }
.message-group .msg-sender.agent { color:var(--green); }
.message-group .msg-sender.system { color:var(--muted); font-weight:500; font-style:italic; }
.message-group .msg-time { font-size:10px; color:var(--muted); font-family:'JetBrains Mono',monospace; }
.message-group .msg-text {
  font-size:13.5px; line-height:1.55; color:var(--text);
  word-wrap:break-word; overflow-wrap:break-word;
}
.message-group .msg-text code {
  font-family:'JetBrains Mono',monospace; font-size:12px;
  background:var(--surface2); padding:1px 5px; border-radius:3px; border:1px solid var(--border);
}
.message-group .msg-text strong { font-weight:700; color:var(--text); }
.message-group .msg-text a { color:var(--blue); text-decoration:none; }
.message-group .msg-text a:hover { text-decoration:underline; }

.msg-system-line {
  display:flex; align-items:center; gap:12px; padding:6px 0; margin:4px 0;
}
.msg-system-line::before, .msg-system-line::after {
  content:''; flex:1; height:1px; background:var(--border);
}
.msg-system-line span { font-size:11px; color:var(--muted); white-space:nowrap; }

/* Typing indicator */
.typing-bar {
  padding:4px 20px 8px; font-size:11px; color:var(--muted); min-height:24px;
  flex-shrink:0; display:flex; align-items:center; gap:4px;
}
.typing-bar:empty { visibility:hidden; }
.typing-dots span { animation:blink 1.4s infinite; }
.typing-dots span:nth-child(2) { animation-delay:0.2s; }
.typing-dots span:nth-child(3) { animation-delay:0.4s; }
@keyframes blink { 0%,100%{opacity:0.2} 50%{opacity:1} }

/* Chat Input */
.chat-input-area {
  padding:12px 16px 16px; flex-shrink:0; border-top:1px solid var(--border);
}
.chat-input-wrapper {
  display:flex; align-items:flex-end; gap:8px;
  background:var(--surface); border:1px solid var(--border); border-radius:var(--radius-lg);
  padding:4px 4px 4px 14px; transition:border-color .15s;
}
.chat-input-wrapper:focus-within { border-color:var(--accent); }
.chat-input-wrapper textarea {
  flex:1; background:none; border:none; color:var(--text); font-size:13.5px;
  resize:none; outline:none; padding:8px 0; max-height:120px; min-height:20px;
  line-height:1.4;
}
.chat-input-wrapper textarea::placeholder { color:var(--muted); }
.send-btn {
  width:34px; height:34px; border-radius:var(--radius); border:none;
  background:var(--accent); color:var(--bg); cursor:pointer; font-size:15px;
  display:flex; align-items:center; justify-content:center; transition:all .15s;
  flex-shrink:0;
}
.send-btn:hover { filter:brightness(1.1); transform:scale(1.05); }
.send-btn:active { transform:scale(0.95); }

/* ‚ïê‚ïê‚ïê Office Panel (right) ‚ïê‚ïê‚ïê */
.office-panel {
  width:0; overflow:hidden; border-left:1px solid var(--border);
  background:linear-gradient(180deg, #1e1b2e 0%, #151320 50%, #13111f 100%);
  transition:width .3s ease; flex-shrink:0; position:relative;
}
.office-panel.open { width:360px; }
.office-panel .office-inner { width:360px; height:100%; position:relative; overflow:hidden; }

/* Office elements */
.office-wall { position:absolute; top:0; left:0; right:0; height:80px; background:linear-gradient(180deg,#2a2545,#1e1b2e); border-bottom:2px solid rgba(251,191,36,0.06); }
.office-title { position:absolute; top:14px; left:50%; transform:translateX(-50%); font-family:'JetBrains Mono',monospace; font-size:8px; color:var(--accent); background:rgba(0,0,0,0.4); padding:6px 12px; border-radius:3px; border:1px solid rgba(251,191,36,0.15); z-index:2; white-space:nowrap; }
.office-floor { position:absolute; bottom:0; left:0; right:0; height:30px; background:linear-gradient(180deg,#13111f,#0d0b18); border-top:1px solid rgba(255,255,255,0.03); }
.office-desk-area { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); display:flex; flex-wrap:wrap; gap:20px; z-index:4; justify-content:center; max-width:340px; }
.office-desk {
  width:70px; display:flex; flex-direction:column; align-items:center;
  cursor:pointer; transition:transform .2s;
}
.office-desk:hover { transform:translateY(-2px); }
.office-desk .od-avatar {
  width:32px; height:32px; border-radius:50%; display:flex; align-items:center;
  justify-content:center; font-size:16px; background:rgba(17,17,24,0.9);
  border:2px solid var(--green); position:relative;
}
.office-desk .od-dot {
  position:absolute; bottom:-1px; right:-1px; width:8px; height:8px;
  border-radius:50%; background:var(--green); border:2px solid #1e1b2e;
}
.office-desk .od-name { margin-top:4px; font-size:8px; font-weight:600; color:var(--text2); text-align:center; }
.office-desk .od-table {
  margin-top:3px; width:50px; height:16px;
  background:linear-gradient(180deg,#3d3355,#2d2545); border:1px solid rgba(255,255,255,0.06);
  border-radius:3px; box-shadow:0 2px 8px rgba(0,0,0,0.3);
}
.office-deco { position:absolute; z-index:2; }
.office-deco.plant1 { bottom:40px; left:20px; font-size:20px; }
.office-deco.plant2 { bottom:40px; right:20px; font-size:16px; }
.office-deco.cat { bottom:35px; left:55px; font-size:14px; cursor:pointer; }
.office-deco.window { top:10px; right:30px; width:50px; height:35px; background:linear-gradient(180deg,#1a2040,#2a3060); border:2px solid rgba(255,255,255,0.08); border-radius:3px; }
.office-deco.whiteboard { top:8px; left:20px; width:90px; height:52px; background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.08); border-radius:2px; font-size:6px; padding:4px; color:var(--muted); line-height:1.3; overflow:hidden; }

/* ‚ïê‚ïê‚ïê Agent Detail Modal ‚ïê‚ïê‚ïê */
.modal-overlay {
  display:none; position:fixed; top:0; left:0; right:0; bottom:0;
  background:rgba(0,0,0,0.6); z-index:50; align-items:center; justify-content:center;
  backdrop-filter:blur(6px);
}
.modal-overlay.open { display:flex; }
.modal {
  width:640px; max-width:90vw; max-height:85vh;
  background:var(--surface); border:1px solid var(--border); border-radius:var(--radius-lg);
  display:flex; flex-direction:column; overflow:hidden;
  animation:modalSlide .25s ease; box-shadow:0 24px 80px rgba(0,0,0,0.5);
}
@keyframes modalSlide { from{opacity:0;transform:translateY(12px)} to{opacity:1;transform:translateY(0)} }

.modal-header {
  padding:16px 20px; border-bottom:1px solid var(--border);
  display:flex; align-items:center; gap:12px;
}
.modal-header h2 { flex:1; font-size:16px; font-weight:700; }
.modal-close {
  width:30px; height:30px; border-radius:var(--radius-sm); border:1px solid var(--border);
  background:none; color:var(--muted); cursor:pointer; font-size:14px;
  display:flex; align-items:center; justify-content:center; transition:all .15s;
}
.modal-close:hover { color:var(--text); border-color:var(--text2); }

/* Detail modal content */
.detail-stats { display:flex; gap:1px; background:var(--border); flex-shrink:0; }
.detail-stat { flex:1; padding:12px 16px; background:var(--surface); text-align:center; }
.detail-stat .val { font-size:18px; font-weight:700; font-family:'JetBrains Mono',monospace; }
.detail-stat .lbl { font-size:9px; color:var(--muted); text-transform:uppercase; letter-spacing:0.5px; margin-top:2px; }

.detail-tabs { display:flex; border-bottom:1px solid var(--border); }
.detail-tab {
  flex:1; padding:10px; font-size:11px; font-weight:600; color:var(--muted);
  cursor:pointer; text-align:center; border:none; background:none;
  border-bottom:2px solid transparent; transition:all .15s;
}
.detail-tab:hover { color:var(--text); }
.detail-tab.active { color:var(--accent); border-bottom-color:var(--accent); }

.detail-body { flex:1; overflow-y:auto; }
.detail-section { display:none; }
.detail-section.active { display:block; }

.timeline-item {
  display:flex; gap:10px; padding:10px 16px;
  border-bottom:1px solid rgba(255,255,255,0.03); font-size:12px;
}
.tl-icon { width:26px; height:26px; border-radius:var(--radius-sm); display:flex; align-items:center; justify-content:center; font-size:12px; flex-shrink:0; }
.tl-icon.msg { background:var(--green-dim); }
.tl-icon.tool { background:var(--purple-dim); }
.tl-icon.sys { background:var(--accent-dim); }
.tl-body { flex:1; min-width:0; }
.tl-title { font-weight:600; display:flex; align-items:center; gap:6px; margin-bottom:1px; }
.tl-title .tool-tag { font-size:9px; padding:1px 5px; border-radius:3px; background:var(--purple-dim); color:var(--purple); }
.tl-preview { color:var(--muted); line-height:1.4; overflow:hidden; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; cursor:pointer; }
.tl-preview.expanded { -webkit-line-clamp:unset; }
.tl-time { font-size:10px; color:var(--muted); margin-top:2px; font-family:'JetBrains Mono',monospace; }

.sessions-list { padding:8px 16px; }
.session-card {
  padding:10px 12px; border:1px solid var(--border); border-radius:var(--radius);
  margin-bottom:6px;
}
.session-card .sc-header { display:flex; align-items:center; gap:8px; }
.session-card .sc-label { font-size:12px; font-weight:600; }
.session-card .sc-kind { font-size:9px; padding:2px 6px; border-radius:3px; background:var(--blue-dim); color:var(--blue); }
.session-card .sc-time { font-size:10px; color:var(--muted); margin-top:2px; }

/* Hire Modal */
.hire-card {
  padding:16px; border:1px solid var(--border); border-radius:var(--radius);
  margin:8px 16px; cursor:pointer; transition:all .15s;
}
.hire-card:hover { border-color:rgba(240,180,41,0.3); background:var(--accent-dim); }
.hire-card.on-team { cursor:default; opacity:0.6; }
.hire-card .hc-top { display:flex; align-items:center; gap:12px; margin-bottom:8px; }
.hire-card .hc-emoji { font-size:28px; }
.hire-card .hc-meta { flex:1; }
.hire-card .hc-name { font-size:14px; font-weight:700; }
.hire-card .hc-title { font-size:11px; color:var(--muted); }
.hire-card .hc-price { font-size:11px; padding:3px 8px; border-radius:var(--radius-sm); font-weight:700; }
.hire-card .hc-price.free { color:var(--green); background:var(--green-dim); }
.hire-card .hc-price.paid { color:var(--accent); background:var(--accent-dim); }
.hire-card .hc-desc { font-size:12px; color:var(--text2); line-height:1.5; }
.hire-card .on-team-badge { font-size:10px; color:var(--green); font-weight:600; }

.hire-detail-view { padding:20px; overflow-y:auto; }
.hd-hero { text-align:center; margin-bottom:20px; }
.hd-hero .hd-emoji { font-size:56px; }
.hd-hero .hd-name { font-size:22px; font-weight:800; margin-top:8px; }
.hd-hero .hd-title { font-size:13px; color:var(--muted); margin-top:4px; }
.hd-section { margin-bottom:16px; }
.hd-section h3 { font-size:12px; font-weight:700; color:var(--accent); margin-bottom:6px; text-transform:uppercase; letter-spacing:0.5px; }
.hd-section p { font-size:13px; color:var(--text2); line-height:1.5; }
.hd-skills { display:flex; flex-wrap:wrap; gap:6px; }
.hd-skill { padding:3px 8px; background:var(--surface2); border:1px solid var(--border); border-radius:var(--radius-sm); font-size:10px; }
.hd-hire-btn {
  display:block; width:100%; padding:12px; background:var(--accent); color:var(--bg);
  border:none; border-radius:var(--radius); font-weight:700; font-size:14px;
  cursor:pointer; margin-top:16px; transition:filter .15s;
}
.hd-hire-btn:hover { filter:brightness(1.1); }
.hd-back { background:none; border:none; color:var(--muted); font-size:12px; cursor:pointer; margin-bottom:12px; }
.hd-back:hover { color:var(--text); }

/* Onboarding */
.onboarding-view { padding:40px 20px; text-align:center; display:flex; flex-direction:column; align-items:center; justify-content:center; }
.ob-emoji { font-size:64px; margin-bottom:16px; animation:bounce .6s ease infinite alternate; }
@keyframes bounce { from{transform:translateY(0)} to{transform:translateY(-8px)} }
.ob-title { font-size:18px; font-weight:700; margin-bottom:6px; }
.ob-subtitle { font-size:13px; color:var(--muted); margin-bottom:20px; }
.ob-steps { text-align:left; max-width:260px; }
.ob-step { display:flex; align-items:center; gap:10px; padding:6px 0; font-size:12px; color:var(--muted); transition:color .3s; }
.ob-step.done { color:var(--green); }
.ob-step.active { color:var(--text); }
.ob-step .ob-check { width:18px; text-align:center; font-size:12px; }
.ob-progress { width:180px; height:3px; background:var(--border); border-radius:2px; margin-top:16px; overflow:hidden; }
.ob-progress .ob-bar { height:100%; background:var(--accent); border-radius:2px; transition:width .5s ease; width:0%; }

/* Celebration */
.celebration-view { padding:40px; text-align:center; }
.cel-emoji { font-size:64px; animation:celebratePop .5s ease; }
@keyframes celebratePop { 0%{transform:scale(0)} 50%{transform:scale(1.2)} 100%{transform:scale(1)} }
.celebration-view h2 { font-size:20px; font-weight:700; margin:12px 0 6px; }
.celebration-view p { font-size:13px; color:var(--muted); margin-bottom:20px; }
.cel-btn { padding:10px 28px; background:var(--accent); color:var(--bg); border:none; border-radius:var(--radius); font-weight:700; font-size:13px; cursor:pointer; }

.confetti { position:fixed; top:0; left:0; right:0; bottom:0; pointer-events:none; z-index:100; }
.confetti-piece { position:absolute; width:8px; height:8px; border-radius:2px; animation:confettiFall 2s ease forwards; }
@keyframes confettiFall { 0%{transform:translateY(-20px) rotate(0);opacity:1} 100%{transform:translateY(100vh) rotate(720deg);opacity:0} }

/* Confirm */
.confirm-overlay { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.6); z-index:60; align-items:center; justify-content:center; backdrop-filter:blur(4px); }
.confirm-overlay.open { display:flex; }
.confirm-box { width:380px; max-width:90vw; background:var(--surface); border:1px solid var(--border); border-radius:var(--radius-lg); padding:24px; text-align:center; animation:modalSlide .2s ease; }
.confirm-box .conf-emoji { font-size:36px; margin-bottom:10px; }
.confirm-box h3 { font-size:15px; font-weight:700; margin-bottom:6px; }
.confirm-box p { font-size:12px; color:var(--muted); line-height:1.5; margin-bottom:16px; }
.conf-btns { display:flex; gap:10px; justify-content:center; }
.conf-btn { padding:8px 20px; border:none; border-radius:var(--radius); font-weight:700; font-size:12px; cursor:pointer; }
.conf-cancel { background:var(--surface2); color:var(--text); border:1px solid var(--border); }
.conf-cancel:hover { border-color:var(--text2); }
.conf-danger { background:var(--red); color:#fff; }
.conf-danger:hover { filter:brightness(1.1); }

/* Waitlist */
.waitlist-page { display:none; flex:1; flex-direction:column; align-items:center; justify-content:center; padding:40px; text-align:center; background:var(--bg); }
.waitlist-page.active { display:flex; }
.waitlist-page .wl-emoji { font-size:64px; margin-bottom:20px; }
.waitlist-page h1 { font-family:'JetBrains Mono',monospace; font-size:18px; color:var(--accent); margin-bottom:12px; }
.waitlist-page p { font-size:14px; color:var(--muted); line-height:1.5; max-width:440px; margin-bottom:24px; }
.waitlist-page .wl-form { display:flex; gap:10px; max-width:380px; width:100%; }
.waitlist-page input { flex:1; padding:12px 16px; background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); color:var(--text); font-size:13px; outline:none; }
.waitlist-page input:focus { border-color:var(--accent); }
.waitlist-page .wl-btn { padding:12px 20px; background:var(--accent); color:var(--bg); border:none; border-radius:var(--radius); font-weight:700; font-size:13px; cursor:pointer; white-space:nowrap; }
.waitlist-page .wl-success { display:none; font-size:16px; color:var(--green); }
.waitlist-page .wl-success.show { display:block; }

/* File browser */
.file-tree { list-style:none; padding:0; }
.file-item {
  display:flex; align-items:center; gap:8px; padding:6px 8px; margin:1px 0;
  border-radius:var(--radius-sm); cursor:pointer; transition:all .1s; font-size:12px;
}
.file-item:hover { background:var(--surface2); }
.file-item .fi-icon { width:16px; text-align:center; font-size:12px; flex-shrink:0; }
.file-item .fi-name { flex:1; font-family:'JetBrains Mono',monospace; font-size:11px; }
.file-item .fi-size { font-size:10px; color:var(--muted); font-family:'JetBrains Mono',monospace; }
.file-item .fi-time { font-size:10px; color:var(--muted); }
.file-item.dir { color:var(--accent); font-weight:600; }
.file-item.dir .fi-name { font-weight:600; }

/* File viewer overlay */
.file-viewer-overlay {
  display:none; position:fixed; top:0; left:0; right:0; bottom:0;
  background:rgba(0,0,0,0.7); z-index:70; align-items:center; justify-content:center;
  backdrop-filter:blur(6px);
}
.file-viewer-overlay.open { display:flex; }
.file-viewer {
  width:800px; max-width:92vw; max-height:88vh;
  background:var(--surface); border:1px solid var(--border); border-radius:var(--radius-lg);
  display:flex; flex-direction:column; overflow:hidden;
  animation:modalSlide .25s ease; box-shadow:0 24px 80px rgba(0,0,0,0.5);
}
.file-viewer-header {
  padding:12px 16px; border-bottom:1px solid var(--border);
  display:flex; align-items:center; gap:10px;
}
.file-viewer-header .fv-path {
  flex:1; font-family:'JetBrains Mono',monospace; font-size:12px; color:var(--accent);
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
.file-viewer-header .fv-close {
  width:28px; height:28px; border-radius:var(--radius-sm); border:1px solid var(--border);
  background:none; color:var(--muted); cursor:pointer; font-size:13px;
  display:flex; align-items:center; justify-content:center;
}
.file-viewer-header .fv-close:hover { color:var(--text); border-color:var(--text2); }
.file-viewer-content {
  flex:1; overflow-y:auto; padding:16px; font-family:'JetBrains Mono',monospace;
  font-size:12px; line-height:1.6; white-space:pre-wrap; word-wrap:break-word;
  color:var(--text);
}
.file-viewer-content h1,.file-viewer-content h2,.file-viewer-content h3 { color:var(--accent); margin:12px 0 6px; }
.file-viewer-content strong { color:var(--text); }

/* Create Channel Modal */
.create-channel-overlay {
  display:none; position:fixed; top:0; left:0; right:0; bottom:0;
  background:rgba(0,0,0,0.6); z-index:55; align-items:center; justify-content:center;
  backdrop-filter:blur(6px);
}
.create-channel-overlay.open { display:flex; }
.create-channel-box {
  width:420px; max-width:90vw; background:var(--surface); border:1px solid var(--border);
  border-radius:var(--radius-lg); padding:24px; animation:modalSlide .25s ease;
  box-shadow:0 24px 80px rgba(0,0,0,0.5);
}
.create-channel-box h3 { font-size:16px; font-weight:700; margin-bottom:4px; }
.create-channel-box .cc-desc { font-size:12px; color:var(--muted); margin-bottom:16px; }
.create-channel-box label { display:block; font-size:11px; font-weight:600; color:var(--text2); margin-bottom:4px; text-transform:uppercase; letter-spacing:0.5px; }
.create-channel-box input[type="text"] {
  width:100%; padding:10px 12px; background:var(--bg); border:1px solid var(--border);
  border-radius:var(--radius); color:var(--text); font-size:13px; outline:none; margin-bottom:14px;
}
.create-channel-box input[type="text"]:focus { border-color:var(--accent); }
.cc-agents { display:flex; flex-wrap:wrap; gap:8px; margin-bottom:16px; }
.cc-agent-chip {
  display:flex; align-items:center; gap:5px; padding:5px 10px;
  background:var(--surface2); border:1px solid var(--border); border-radius:var(--radius);
  cursor:pointer; font-size:12px; transition:all .15s; user-select:none;
}
.cc-agent-chip:hover { border-color:var(--text2); }
.cc-agent-chip.selected { border-color:var(--accent); background:var(--accent-dim); color:var(--accent); }
.cc-agent-chip .cc-check { width:14px; text-align:center; font-size:10px; }
.cc-btns { display:flex; gap:10px; justify-content:flex-end; }
.cc-btn { padding:8px 20px; border:none; border-radius:var(--radius); font-weight:700; font-size:12px; cursor:pointer; }
.cc-btn-cancel { background:var(--surface2); color:var(--text); border:1px solid var(--border); }
.cc-btn-cancel:hover { border-color:var(--text2); }
.cc-btn-create { background:var(--accent); color:var(--bg); }
.cc-btn-create:hover { filter:brightness(1.1); }

/* Output Feed */
.output-feed { padding:16px 20px; overflow-y:auto; flex:1; }
.output-filters { display:flex; gap:6px; margin-bottom:16px; flex-wrap:wrap; }
.output-filter {
  padding:4px 10px; font-size:11px; font-weight:600; border-radius:12px;
  border:1px solid var(--border); background:none; color:var(--text2);
  cursor:pointer; transition:all .15s;
}
.output-filter:hover { border-color:var(--text2); color:var(--text); }
.output-filter.active { border-color:var(--accent); background:var(--accent-dim); color:var(--accent); }
.output-card {
  padding:12px 14px; border:1px solid var(--border); border-radius:var(--radius);
  margin-bottom:8px; cursor:pointer; transition:all .15s;
}
.output-card:hover { border-color:rgba(240,180,41,0.3); background:var(--surface); }
.output-card.expanded { background:var(--surface); border-color:var(--border2); }
.oc-header { display:flex; align-items:center; gap:8px; margin-bottom:4px; }
.oc-agent { font-size:12px; font-weight:700; display:flex; align-items:center; gap:4px; }
.oc-file { font-size:12px; font-family:'JetBrains Mono',monospace; color:var(--text2); flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.oc-time { font-size:10px; color:var(--muted); font-family:'JetBrains Mono',monospace; white-space:nowrap; }
.oc-badge {
  font-size:9px; font-weight:700; padding:2px 6px; border-radius:3px; white-space:nowrap;
}
.oc-badge.tweets-ready { background:var(--green-dim); color:var(--green); }
.oc-badge.tiktok-scripts { background:var(--purple-dim); color:var(--purple); }
.oc-badge.outreach { background:var(--accent-dim); color:var(--accent); }
.oc-badge.research { background:var(--blue-dim); color:var(--blue); }
.oc-badge.strategy { background:rgba(244,114,182,0.1); color:var(--pink); }
.oc-badge.drafts { background:var(--accent-dim); color:var(--accent); }
.oc-badge.content { background:rgba(255,255,255,0.05); color:var(--text2); }
.oc-badge.security { background:var(--red-dim); color:var(--red); }
.oc-preview { font-size:12px; color:var(--muted); line-height:1.4; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; margin-top:4px; }
.oc-full-content {
  display:none; margin-top:12px; padding-top:12px; border-top:1px solid var(--border);
  font-size:13px; line-height:1.6; color:var(--text); max-height:500px; overflow-y:auto;
}
.oc-full-content.show { display:block; }
.oc-full-content h1,.oc-full-content h2,.oc-full-content h3 { color:var(--accent); margin:12px 0 6px; }
.oc-full-content code { font-family:'JetBrains Mono',monospace; font-size:12px; background:var(--surface2); padding:1px 4px; border-radius:3px; }
.oc-full-content strong { color:var(--text); }
.output-count { font-size:11px; color:var(--muted); margin-bottom:12px; }

/* Hide view utility */
.view-hidden { display:none !important; }
</style>
</head>
<body>

<div class="waitlist-page" id="waitlistPage">
  <div class="wl-emoji">ü¶û</div>
  <h1>Agent HQ</h1>
  <p>Your AI team's workspace. Manage agents, watch them coordinate, and grow your business ‚Äî all from one place.</p>
  <div class="wl-form" id="wlForm">
    <input type="email" id="wlEmail" placeholder="you@example.com">
    <button class="wl-btn" onclick="submitWaitlist()">Get Early Access ü¶û</button>
  </div>
  <div class="wl-success" id="wlSuccess">‚úÖ You're on the list!</div>
</div>

<div class="app" id="app" style="display:none">
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-header">
      <span class="status-dot-sm" id="gatewayDot"></span>
      <span class="logo">HUDDLECLAW</span>
    </div>

    <div class="sidebar-nav" id="sidebarNav">
      <!-- Channels -->
      <div class="nav-section">
        <div class="nav-section-title">
          Channels
          <span class="section-action" onclick="openCreateChannel()" title="Create channel">+</span>
        </div>
        <div id="channelList">
          <div class="nav-item active" data-channel="general" onclick="switchChannel('general')">
            <span class="nav-icon">#</span>
            <span class="nav-label">general</span>
          </div>
          <div class="nav-item" data-channel="activity" onclick="switchChannel('activity')">
            <span class="nav-icon">üìã</span>
            <span class="nav-label">activity-log</span>
          </div>
          <div class="nav-item" data-channel="output" onclick="switchChannel('output')">
            <span class="nav-icon">üìÇ</span>
            <span class="nav-label">output-review</span>
          </div>
        </div>
      </div>

      <div class="nav-divider"></div>

      <!-- Direct Messages -->
      <div class="nav-section">
        <div class="nav-section-title">
          Direct Messages
          <span class="section-action" onclick="openHireModal()" title="Hire agent">+</span>
        </div>
        <div id="dmList"></div>
      </div>

      <div class="nav-divider"></div>

      <!-- Agent Comms -->
      <div class="nav-section">
        <div class="nav-section-title">Agent Comms</div>
        <div id="agentCommsList"></div>
      </div>
    </div>

    <div class="sidebar-footer">
      <div class="user-avatar">üë§</div>
      <div class="user-info">
        <div class="user-name">You</div>
        <div class="user-role">Owner</div>
      </div>
      <button class="settings-btn" onclick="toggleOffice()" title="Toggle office view">üè¢</button>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <div class="channel-header">
      <span class="ch-icon" id="chIcon">#</span>
      <div class="ch-info">
        <div class="ch-name" id="chName">general</div>
        <div class="ch-topic" id="chTopic">Team-wide chat ‚Äî all agents see your messages</div>
      </div>
      <div class="ch-actions">
        <button class="ch-action-btn" onclick="toggleOffice()" title="Toggle office" id="officeToggle">üè¢</button>
        <button class="ch-action-btn" onclick="openHireModal()" title="Hire agent">‚ö°</button>
      </div>
    </div>

    <div class="messages-area" id="messagesArea">
      <div class="spacer"></div>
    </div>

    <div class="typing-bar" id="typingBar"></div>

    <div class="chat-input-area" id="chatInputArea">
      <div class="chat-input-wrapper">
        <textarea id="chatInput" placeholder="Message #general..." rows="1" autocomplete="off"></textarea>
        <button class="send-btn" onclick="sendMessage()">‚Üë</button>
      </div>
    </div>
  </div>

  <!-- Office Panel -->
  <div class="office-panel" id="officePanel">
    <div class="office-inner">
      <div class="office-wall"></div>
      <div class="office-title">HUDDLECLAW</div>
      <div class="office-deco whiteboard">üìä GOALS<br>$14K ‚Üí $30K MRR<br>Productize platform<br>üî• LFG</div>
      <div class="office-deco window"></div>
      <div class="office-deco plant1">ü™¥</div>
      <div class="office-deco plant2">üåø</div>
      <div class="office-deco cat" id="officeCat">üò∫</div>
      <div class="office-desk-area" id="officeDesks"></div>
      <div class="office-floor"></div>
    </div>
  </div>
</div>

<!-- Agent Detail Modal -->
<div class="modal-overlay" id="detailModal" onclick="if(event.target===this)closeDetail()">
  <div class="modal">
    <div class="modal-header">
      <h2 id="detailTitle">Agent</h2>
      <button class="modal-close" onclick="closeDetail()">‚úï</button>
    </div>
    <div class="detail-stats" id="detailStats">
      <div class="detail-stat"><div class="val" id="statSessions">-</div><div class="lbl">Sessions</div></div>
      <div class="detail-stat"><div class="val" id="statMessages">-</div><div class="lbl">Messages</div></div>
      <div class="detail-stat"><div class="val" id="statTools">-</div><div class="lbl">Tool Calls</div></div>
    </div>
    <div class="detail-tabs">
      <button class="detail-tab active" onclick="switchDetailTab('timeline')">Timeline</button>
      <button class="detail-tab" onclick="switchDetailTab('files')">Files</button>
      <button class="detail-tab" onclick="switchDetailTab('sessions')">Sessions</button>
    </div>
    <div class="detail-body">
      <div class="detail-section active" id="secTimeline"><div class="sessions-list" style="padding:20px;color:var(--muted);font-size:13px">Loading...</div></div>
      <div class="detail-section" id="secFiles"><div class="sessions-list" id="filesList" style="padding:12px 16px"></div></div>
      <div class="detail-section" id="secSessions"><div class="sessions-list" id="sessionsList"></div></div>
    </div>
  </div>
</div>

<!-- Hire Modal -->
<div class="modal-overlay" id="hireModal" onclick="if(event.target===this)closeHireModal()">
  <div class="modal">
    <div class="modal-header">
      <h2 id="hireTitle">‚ö° Hire an Agent</h2>
      <button class="modal-close" onclick="closeHireModal()">‚úï</button>
    </div>
    <div id="hireBrowse" style="flex:1;overflow-y:auto"></div>
    <div id="hireDetailView" class="view-hidden" style="flex:1;overflow-y:auto"></div>
    <div id="hireOnboarding" class="view-hidden" style="flex:1;overflow-y:auto;display:flex;align-items:center;justify-content:center"></div>
    <div id="hireCelebration" class="view-hidden" style="flex:1;overflow-y:auto"></div>
  </div>
</div>

<!-- Create Channel Modal -->
<div class="create-channel-overlay" id="createChannelOverlay" onclick="if(event.target===this)closeCreateChannel()">
  <div class="create-channel-box">
    <h3># Create a Channel</h3>
    <div class="cc-desc">Channels are for topic-based discussions with selected agents.</div>
    <label>Channel Name</label>
    <input type="text" id="ccName" placeholder="e.g. tiktok-strategy" autocomplete="off">
    <label>Invite Agents</label>
    <div class="cc-agents" id="ccAgents"></div>
    <div class="cc-btns">
      <button class="cc-btn cc-btn-cancel" onclick="closeCreateChannel()">Cancel</button>
      <button class="cc-btn cc-btn-create" onclick="createChannel()">Create Channel</button>
    </div>
  </div>
</div>

<!-- File Viewer -->
<div class="file-viewer-overlay" id="fileViewerOverlay" onclick="if(event.target===this)closeFileViewer()">
  <div class="file-viewer">
    <div class="file-viewer-header">
      <span class="fv-path" id="fvPath"></span>
      <button class="fv-close" onclick="closeFileViewer()">‚úï</button>
    </div>
    <div class="file-viewer-content" id="fvContent"></div>
  </div>
</div>

<!-- Confirm Modal -->
<div class="confirm-overlay" id="confirmOverlay">
  <div class="confirm-box" id="confirmBox"></div>
</div>

<script>
// ‚ïê‚ïê‚ïê State ‚ïê‚ïê‚ïê
let ws=null, agents=[], registeredAgents=[], agentSessions={}, streamBuffers={};
let currentChannel='general', officeOpen=false;
const LOCAL=location.origin;
const AGENT_COLORS = { 'üìà':'#34d399', 'üî•':'#f87171', 'üîí':'#60a5fa', 'üí∞':'#f0b429', 'ü¶û':'#f0b429', 'ü§ñ':'#a78bfa' };

// Channel message storage: { channelId: [{sender,text,emoji,time,agentId}] }
const channelMessages = {};
// Unread counts: { channelId: number }
const unreadCounts = {};
// Custom channels: [{ id, name, agents: [agentId,...] }]
let customChannels = [];

// Stable client ID
function getClientId() {
  let id=localStorage.getItem('hq-client-id');
  if(!id){id=crypto.randomUUID().slice(0,8);localStorage.setItem('hq-client-id',id);}
  return id;
}
const CLIENT_ID=getClientId();

// ‚ïê‚ïê‚ïê Init ‚ïê‚ïê‚ïê
async function init() {
  loadSavedMessages();
  setupInputHandlers();
  setupCat();
  await checkConnection();
}

async function checkConnection() {
  try {
    const res=await fetch(`${LOCAL}/api/agents`,{signal:AbortSignal.timeout(3000)});
    if(!res.ok) throw 0;
    document.getElementById('app').style.display='flex';
    setGatewayStatus(true);
    await loadAgents();
    connectWS();
    renderCurrentChannel();
    updateUnreadBadges();
  } catch {
    document.getElementById('waitlistPage').classList.add('active');
    setGatewayStatus(false);
  }
}

function setGatewayStatus(on) {
  const dot=document.getElementById('gatewayDot');
  dot.className=`status-dot-sm ${on?'':'off'}`;
}

// ‚ïê‚ïê‚ïê Agents ‚ïê‚ïê‚ïê
async function loadAgents() {
  const [a,r]=await Promise.all([
    fetch(`${LOCAL}/api/agents`).then(r=>r.json()),
    fetch(`${LOCAL}/api/agents/registered`).then(r=>r.json())
  ]);
  agents=a; registeredAgents=r;
  renderSidebar();
  renderOfficeDesks();
}

function isInstalled(a) {
  const ids=new Set(registeredAgents.map(x=>x.id));
  return ids.has(a.name.replace(/-agent$/,''))||ids.has(a.agentId);
}

function getAgentId(a) { return a.agentId||a.name.replace(/-agent$/,''); }
function getAgentByChannel(ch) { return agents.find(a=>getAgentId(a)===ch && isInstalled(a)); }
function getInstalledAgents() { return agents.filter(isInstalled); }

// ‚ïê‚ïê‚ïê Sidebar ‚ïê‚ïê‚ïê
function renderSidebar() {
  const installed=getInstalledAgents();

  // Custom channels
  const chList=document.getElementById('channelList');
  let chHtml=`<div class="nav-item${currentChannel==='general'?' active':''}" data-channel="general" onclick="switchChannel('general')">
    <span class="nav-icon">#</span><span class="nav-label">general</span>
  </div>
  <div class="nav-item${currentChannel==='activity'?' active':''}" data-channel="activity" onclick="switchChannel('activity')">
    <span class="nav-icon">üìã</span><span class="nav-label">activity-log</span>
  </div>
  <div class="nav-item${currentChannel==='output'?' active':''}" data-channel="output" onclick="switchChannel('output')">
    <span class="nav-icon">üìÇ</span><span class="nav-label">output-review</span>
  </div>`;
  for(const ch of customChannels) {
    const memberEmojis=ch.agents.map(id=>{const a=agents.find(x=>getAgentId(x)===id);return a?.emoji||'ü§ñ';}).join('');
    chHtml+=`<div class="nav-item${currentChannel===ch.id?' active':''}" data-channel="${ch.id}" onclick="switchChannel('${ch.id}')">
      <span class="nav-icon">#</span><span class="nav-label">${esc(ch.name)}</span>
    </div>`;
  }
  chList.innerHTML=chHtml;

  // DM list
  const dmList=document.getElementById('dmList');
  dmList.innerHTML=installed.map(a=>{
    const id=getAgentId(a);
    return `<div class="nav-item" data-channel="dm-${id}" onclick="switchChannel('dm-${id}')">
      <span class="status-indicator online" id="sidebar-dot-${id}"></span>
      <span class="nav-label">${a.emoji||'ü§ñ'} ${a.displayName||a.name}</span>
      <span class="section-action" onclick="event.stopPropagation();openAgentDetail('${a.name}')" title="View details" style="opacity:0.5;font-size:11px">‚ÑπÔ∏è</span>
    </div>`;
  }).join('');

  // Agent comms (pairs) ‚Äî placeholder for now
  const commsEl=document.getElementById('agentCommsList');
  if(installed.length>=2) {
    const pairs=[];
    for(let i=0;i<installed.length;i++) {
      for(let j=i+1;j<installed.length;j++) {
        const a=installed[i], b=installed[j];
        pairs.push({a,b,id:`comms-${getAgentId(a)}-${getAgentId(b)}`});
      }
    }
    commsEl.innerHTML=pairs.slice(0,6).map(p=>`<div class="nav-item" data-channel="${p.id}" onclick="switchChannel('${p.id}')">
      <span class="nav-icon">üîó</span>
      <span class="nav-label">${p.a.emoji} ‚Üî ${p.b.emoji} ${(p.a.displayName||'').split(' ')[0]} ¬∑ ${(p.b.displayName||'').split(' ')[0]}</span>
    </div>`).join('');
  } else {
    commsEl.innerHTML='<div style="padding:4px 8px;font-size:11px;color:var(--muted)">Hire 2+ agents to see comms</div>';
  }
}

// ‚ïê‚ïê‚ïê Channel Switching ‚ïê‚ïê‚ïê
function switchChannel(ch) {
  currentChannel=ch;
  clearUnread(ch);

  // Update sidebar active state
  document.querySelectorAll('.nav-item').forEach(el=>{
    el.classList.toggle('active', el.dataset.channel===ch);
  });

  // Update header
  const icon=document.getElementById('chIcon');
  const name=document.getElementById('chName');
  const topic=document.getElementById('chTopic');
  const input=document.getElementById('chatInput');
  const inputArea=document.getElementById('chatInputArea');

  if(ch==='general') {
    icon.textContent='#'; name.textContent='general';
    topic.textContent='Team-wide chat ‚Äî all agents see your messages';
    input.placeholder='Message #general...';
    inputArea.style.display='';
  } else if(ch==='output') {
    icon.textContent='üìÇ'; name.textContent='output-review';
    topic.textContent='Review queue ‚Äî all agent work products';
    inputArea.style.display='none';
    loadOutputFeed();
  } else if(ch==='activity') {
    icon.textContent='üìã'; name.textContent='activity-log';
    topic.textContent='Compliance changelog ‚Äî all agent actions recorded';
    inputArea.style.display='none';
    loadActivityLog();
  } else if(ch.startsWith('dm-')) {
    const agentId=ch.slice(3);
    const agent=agents.find(a=>getAgentId(a)===agentId);
    icon.textContent=agent?.emoji||'ü§ñ';
    name.textContent=agent?.displayName||agentId;
    topic.textContent=agent?.title||'Direct message';
    input.placeholder=`Message ${agent?.displayName||agentId}...`;
    inputArea.style.display='';
  } else if(ch.startsWith('comms-')) {
    const parts=ch.slice(6).split('-');
    const a=agents.find(x=>getAgentId(x)===parts[0]);
    const b=agents.find(x=>getAgentId(x)===parts[1]);
    icon.textContent='üîó';
    name.textContent=`${a?.displayName||parts[0]} ‚Üî ${b?.displayName||parts[1]}`;
    topic.textContent='Agent-to-agent communication (read-only)';
    inputArea.style.display='none';
  } else if(ch.startsWith('ch-')) {
    const custom=customChannels.find(c=>c.id===ch);
    if(custom) {
      const memberNames=custom.agents.map(id=>{const a=agents.find(x=>getAgentId(x)===id);return a?.displayName||id;}).join(', ');
      icon.textContent='#';
      name.textContent=custom.name;
      topic.textContent=`${memberNames}`;
      input.placeholder=`Message #${custom.name}...`;
      inputArea.style.display='';
    }
  }

  renderCurrentChannel();
}

function renderCurrentChannel() {
  const area=document.getElementById('messagesArea');
  const msgs=channelMessages[currentChannel]||[];

  let html='<div class="spacer"></div>';

  if(currentChannel==='activity' || currentChannel==='output') return; // handled by dedicated loaders

  if(msgs.length===0) {
    html+=`<div class="msg-system-line"><span>${getChannelWelcome()}</span></div>`;
  }

  for(const m of msgs) {
    if(m.system) {
      html+=`<div class="msg-system-line"><span>${esc(m.text)}</span></div>`;
    } else {
      const senderClass=m.sender==='You'?'you':'agent';
      const senderColor=m.sender==='You'?'var(--accent)':(AGENT_COLORS[m.emoji]||'var(--green)');
      html+=`<div class="message-group">
        <div class="msg-avatar">${m.emoji||'üë§'}</div>
        <div class="msg-body">
          <div class="msg-header">
            <span class="msg-sender ${senderClass}" style="color:${senderColor}">${esc(m.sender)}</span>
            <span class="msg-time">${m.time||''}</span>
          </div>
          <div class="msg-text">${renderMarkdown(m.text)}</div>
        </div>
      </div>`;
    }
  }

  area.innerHTML=html;
  area.scrollTop=area.scrollHeight;
}

function getChannelWelcome() {
  if(currentChannel==='general') return 'üëã Welcome to #general ‚Äî your whole team is here';
  if(currentChannel.startsWith('dm-')) {
    const id=currentChannel.slice(3);
    const a=agents.find(x=>getAgentId(x)===id);
    return `üí¨ Start of DM with ${a?.displayName||id}`;
  }
  if(currentChannel.startsWith('comms-')) return 'üîó Agent-to-agent communication will appear here';
  if(currentChannel.startsWith('ch-')) {
    const ch=customChannels.find(c=>c.id===currentChannel);
    return ch?`# Welcome to #${ch.name}`:'';}
  return '';
}

// ‚ïê‚ïê‚ïê Activity Log ‚ïê‚ïê‚ïê
async function loadActivityLog() {
  const area=document.getElementById('messagesArea');
  area.innerHTML='<div class="spacer"></div><div style="padding:20px;color:var(--muted);font-size:13px">Loading activity...</div>';
  try {
    const res=await fetch(`${LOCAL}/api/activity`);
    const events=await res.json();
    let html='<div class="spacer"></div>';
    html+='<div class="msg-system-line"><span>üìã Activity Log ‚Äî Compliance Record</span></div>';
    for(const ev of events.slice(0,50)) {
      const t=ev.updatedAt?new Date(ev.updatedAt).toLocaleString():'';
      html+=`<div class="message-group">
        <div class="msg-avatar">üìã</div>
        <div class="msg-body">
          <div class="msg-header">
            <span class="msg-sender agent">${esc(ev.agentId)}</span>
            <span class="msg-time">${t}</span>
          </div>
          <div class="msg-text">${esc(ev.kind||'session')} ‚Äî ${esc(ev.label||ev.sessionKey||'')}</div>
        </div>
      </div>`;
    }
    area.innerHTML=html;
    area.scrollTop=area.scrollHeight;
  } catch { area.innerHTML='<div class="spacer"></div><div style="padding:20px;color:var(--muted)">Failed to load</div>'; }
}

// ‚ïê‚ïê‚ïê Send Message ‚ïê‚ïê‚ïê
function sendMessage() {
  const input=document.getElementById('chatInput');
  const text=input.value.trim();
  if(!text||!ws||ws.readyState!==WebSocket.OPEN) return;
  input.value=''; input.style.height='auto';

  const now=new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
  addMessage(currentChannel, {sender:'You',text,emoji:'üë§',time:now});

  if(currentChannel==='general') {
    // Broadcast to all installed agents
    getInstalledAgents().forEach(agent=>{
      ws.send(JSON.stringify({type:'chat',agentPkg:agent.name,message:text,sessionKey:agentSessions[agent.name]||null}));
    });
  } else if(currentChannel.startsWith('dm-')) {
    // DM to specific agent
    const agentId=currentChannel.slice(3);
    const agent=agents.find(a=>getAgentId(a)===agentId);
    if(agent) {
      ws.send(JSON.stringify({type:'chat',agentPkg:agent.name,message:text,sessionKey:agentSessions[agent.name]||null}));
    }
  } else if(currentChannel.startsWith('ch-')) {
    // Custom channel ‚Äî send to selected agents only
    const ch=customChannels.find(c=>c.id===currentChannel);
    if(ch) {
      for(const agentId of ch.agents) {
        const agent=agents.find(a=>getAgentId(a)===agentId);
        if(agent) {
          ws.send(JSON.stringify({type:'chat',agentPkg:agent.name,message:`[#${ch.name}] ${text}`,sessionKey:agentSessions[agent.name]||null}));
        }
      }
    }
  }
}

function addMessage(channel, msg) {
  if(!channelMessages[channel]) channelMessages[channel]=[];
  channelMessages[channel].push(msg);
  if(channel===currentChannel) renderCurrentChannel();
  saveMessages();

  // Track unread if not current channel
  if(channel!==currentChannel && !msg.system) {
    unreadCounts[channel]=(unreadCounts[channel]||0)+1;
    saveUnread();
    updateUnreadBadges();
  }
}

function updateUnreadBadges() {
  document.querySelectorAll('.nav-item[data-channel]').forEach(el=>{
    const ch=el.dataset.channel;
    const count=unreadCounts[ch]||0;
    const existing=el.querySelector('.nav-badge');
    if(count>0) {
      el.classList.add('unread');
      if(existing) { existing.textContent=count; }
      else {
        const badge=document.createElement('span');
        badge.className='nav-badge';
        badge.textContent=count;
        el.appendChild(badge);
      }
    } else {
      el.classList.remove('unread');
      if(existing) existing.remove();
    }
  });
}

function clearUnread(channel) {
  if(unreadCounts[channel]) {
    delete unreadCounts[channel];
    saveUnread();
    updateUnreadBadges();
  }
}

function addSystemMessage(channel, text) {
  addMessage(channel, {system:true, text});
}

// ‚ïê‚ïê‚ïê WebSocket ‚ïê‚ïê‚ïê
function connectWS() {
  if(ws&&ws.readyState===WebSocket.OPEN) return;
  ws=new WebSocket(`ws://${location.host}`);
  ws.onopen=()=>{setGatewayStatus(true);ws.send(JSON.stringify({type:'identify',clientId:CLIENT_ID}));};
  ws.onclose=()=>{setGatewayStatus(false);setTimeout(connectWS,3000);};
  ws.onmessage=e=>{try{handleWsMsg(JSON.parse(e.data))}catch(err){console.error(err)}};
}

function handleWsMsg(msg) {
  if(msg.type==='status') setGatewayStatus(msg.connected);
  if(msg.type==='chat-delta') onChatDelta(msg);
  if(msg.type==='chat-final') onChatFinal(msg);
}

function onChatDelta(msg) {
  const text=extractText(msg.message); if(!text) return;
  streamBuffers[msg.runId]=text;
  if(msg.sessionKey) agentSessions[msg.agentPkg]=msg.sessionKey;
  const agent=agents.find(a=>a.name===msg.agentPkg);
  const name=agent?.displayName||msg.agentPkg;
  showTyping(name);

  // Update sidebar status
  const id=getAgentId(agent||{name:msg.agentPkg});
  const dot=document.getElementById(`sidebar-dot-${id}`);
  if(dot) dot.className='status-indicator busy';
}

function onChatFinal(msg) {
  const text=streamBuffers[msg.runId]||extractText(msg.message);
  delete streamBuffers[msg.runId];
  if(msg.sessionKey) agentSessions[msg.agentPkg]=msg.sessionKey;
  const agent=agents.find(a=>a.name===msg.agentPkg);
  const name=agent?.displayName||msg.agentPkg;
  const emoji=agent?.emoji||'ü§ñ';
  const id=getAgentId(agent||{name:msg.agentPkg});
  const now=new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});

  hideTyping();

  // Reset sidebar status
  const dot=document.getElementById(`sidebar-dot-${id}`);
  if(dot) dot.className='status-indicator online';

  if(text) {
    // Add to #general
    addMessage('general', {sender:name,text,emoji,time:now,agentId:id});
    // Also add to DM channel
    addMessage(`dm-${id}`, {sender:name,text,emoji,time:now,agentId:id});
  }
}

function extractText(m) {
  if(typeof m==='string') return m;
  if(Array.isArray(m)) return m.filter(p=>p.type==='text').map(p=>p.text).join('');
  if(m?.content) return extractText(m.content);
  return m?.text||'';
}

function showTyping(name) {
  document.getElementById('typingBar').innerHTML=`${esc(name)} is typing<span class="typing-dots"><span>.</span><span>.</span><span>.</span></span>`;
}
function hideTyping() { document.getElementById('typingBar').innerHTML=''; }

// ‚ïê‚ïê‚ïê Office ‚ïê‚ïê‚ïê
function toggleOffice() {
  officeOpen=!officeOpen;
  document.getElementById('officePanel').classList.toggle('open',officeOpen);
  document.getElementById('officeToggle').classList.toggle('active',officeOpen);
}

function renderOfficeDesks() {
  const area=document.getElementById('officeDesks');
  const installed=getInstalledAgents();
  area.innerHTML=installed.map(a=>{
    const id=getAgentId(a);
    return `<div class="office-desk" onclick="switchChannel('dm-${id}')">
      <div class="od-avatar">${a.emoji||'ü§ñ'}<div class="od-dot"></div></div>
      <div class="od-name">${(a.displayName||a.name).split(' ')[0]}</div>
      <div class="od-table"></div>
    </div>`;
  }).join('')+`<div class="office-desk" onclick="openHireModal()" style="opacity:0.4">
    <div class="od-avatar" style="border-style:dashed;border-color:var(--accent)">+</div>
    <div class="od-name" style="color:var(--accent)">Hire</div>
  </div>`;
}

function setupCat() {
  const cat=document.getElementById('officeCat');
  const faces=['üò∫','üò∏','üòπ','üòª','üòº','üòΩ','üôÄ','üòø','üòæ'];
  let i=0;
  cat?.addEventListener('click',()=>{i=(i+1)%faces.length;cat.textContent=faces[i];});
}

// ‚ïê‚ïê‚ïê Agent Detail ‚ïê‚ïê‚ïê
async function openAgentDetail(agentName) {
  const agent=agents.find(a=>a.name===agentName);
  if(!agent) return;
  detailAgentName=agentName;
  document.getElementById('detailTitle').innerHTML=`${agent.emoji||'ü§ñ'} ${agent.displayName||agent.name}`;
  document.getElementById('detailModal').classList.add('open');

  // Reset
  document.getElementById('secTimeline').innerHTML='<div style="padding:20px;color:var(--muted);font-size:13px">Loading...</div>';
  document.getElementById('statSessions').textContent='-';
  document.getElementById('statMessages').textContent='-';
  document.getElementById('statTools').textContent='-';
  switchDetailTab('timeline');

  try {
    const res=await fetch(`${LOCAL}/api/agents/${agentName}/activity`);
    const data=await res.json();
    renderDetail(data);
  } catch { document.getElementById('secTimeline').innerHTML='<div style="padding:20px;color:var(--muted)">Failed to load</div>'; }
}

function renderDetail(data) {
  const {sessions:sess,history}=data;
  document.getElementById('statSessions').textContent=sess.length;
  let msgCount=0,toolCount=0;

  const el=document.getElementById('secTimeline');
  if(!history?.length) { el.innerHTML='<div style="padding:20px;color:var(--muted);font-size:13px">No recent activity</div>'; }
  else {
    let html='';
    for(const msg of history) {
      const role=msg.role||'unknown', text=msg.text||'', tools=msg.toolCalls||[];
      const time=msg.timestamp?new Date(msg.timestamp).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}):'';
      if(role==='assistant') {
        msgCount++;
        for(const tc of tools) {
          toolCount++;
          html+=`<div class="timeline-item"><div class="tl-icon tool">üîß</div><div class="tl-body">
            <div class="tl-title">Tool <span class="tool-tag">${esc(tc.name||'tool')}</span></div>
            <div class="tl-preview" onclick="this.classList.toggle('expanded')">${esc((tc.input||'').slice(0,200))}</div>
            <div class="tl-time">${time}</div></div></div>`;
        }
        if(text) {
          html+=`<div class="timeline-item"><div class="tl-icon msg">üí¨</div><div class="tl-body">
            <div class="tl-title">Message</div>
            <div class="tl-preview" onclick="this.classList.toggle('expanded')">${esc(text.slice(0,300))}</div>
            <div class="tl-time">${time}</div></div></div>`;
        }
      } else if(role==='user' && text) {
        html+=`<div class="timeline-item"><div class="tl-icon sys">üë§</div><div class="tl-body">
          <div class="tl-title">Input</div>
          <div class="tl-preview" onclick="this.classList.toggle('expanded')">${esc(text.slice(0,200))}</div>
          <div class="tl-time">${time}</div></div></div>`;
      }
    }
    el.innerHTML=html||'<div style="padding:20px;color:var(--muted)">No activity</div>';
  }
  document.getElementById('statMessages').textContent=msgCount;
  document.getElementById('statTools').textContent=toolCount;

  const sl=document.getElementById('sessionsList');
  sl.innerHTML=sess.map(s=>`<div class="session-card">
    <div class="sc-header"><span class="sc-label">${esc(s.label||s.key?.split(':').pop()||'session')}</span><span class="sc-kind">${s.kind||'chat'}</span></div>
    <div class="sc-time">${s.updatedAt?timeAgo(new Date(s.updatedAt)):''}</div>
  </div>`).join('')||'<div style="padding:20px;color:var(--muted)">No sessions</div>';
}

function closeDetail() { document.getElementById('detailModal').classList.remove('open'); }

let detailAgentName=null;
function switchDetailTab(tab) {
  const tabs=['timeline','files','sessions'];
  document.querySelectorAll('.detail-tab').forEach((t,i)=>t.classList.toggle('active',tabs[i]===tab));
  document.getElementById('secTimeline').classList.toggle('active',tab==='timeline');
  document.getElementById('secFiles').classList.toggle('active',tab==='files');
  document.getElementById('secSessions').classList.toggle('active',tab==='sessions');
  if(tab==='files'&&detailAgentName) loadAgentFiles(detailAgentName);
}

async function loadAgentFiles(agentName) {
  const el=document.getElementById('filesList');
  el.innerHTML='<div style="color:var(--muted);font-size:13px">Loading files...</div>';
  try {
    const res=await fetch(`${LOCAL}/api/agents/${agentName}/files`);
    const files=await res.json();
    if(!files.length) { el.innerHTML='<div style="color:var(--muted);font-size:13px">No files in workspace</div>'; return; }
    
    // Group: show dirs with their files, sorted by modified time
    const fileItems=files.filter(f=>f.type==='file').sort((a,b)=>(b.mtime||0)-(a.mtime||0));
    const dirs=new Set(files.filter(f=>f.type==='dir').map(f=>f.name));
    
    let html='<div style="margin-bottom:8px;font-size:11px;color:var(--muted)">'+(fileItems.length)+' files in workspace</div>';
    html+='<ul class="file-tree">';
    for(const f of fileItems) {
      const ext=f.name.split('.').pop();
      const icon=ext==='md'?'üìÑ':ext==='json'?'üìã':ext==='js'?'‚öôÔ∏è':'üìé';
      const size=f.size>1024?(f.size/1024).toFixed(1)+'KB':f.size+'B';
      const age=f.mtime?timeAgo(new Date(f.mtime)):'';
      html+=`<li class="file-item" onclick="viewFile('${agentName}','${f.name.replace(/'/g,"\\'")}')">
        <span class="fi-icon">${icon}</span>
        <span class="fi-name">${esc(f.name)}</span>
        <span class="fi-size">${size}</span>
        <span class="fi-time">${age}</span>
      </li>`;
    }
    html+='</ul>';
    el.innerHTML=html;
  } catch(e) { el.innerHTML='<div style="color:var(--muted)">Failed to load files</div>'; }
}

async function viewFile(agentName, filePath) {
  document.getElementById('fvPath').textContent=filePath;
  document.getElementById('fvContent').textContent='Loading...';
  document.getElementById('fileViewerOverlay').classList.add('open');
  try {
    const res=await fetch(`${LOCAL}/api/agents/${agentName}/file/${encodeURIComponent(filePath)}`);
    if(!res.ok) throw new Error('Not found');
    const text=await res.text();
    // Simple markdown rendering for .md files
    if(filePath.endsWith('.md')) {
      document.getElementById('fvContent').innerHTML=renderFileMarkdown(text);
    } else {
      document.getElementById('fvContent').textContent=text;
    }
  } catch(e) { document.getElementById('fvContent').textContent='Failed to load file'; }
}

function closeFileViewer() { document.getElementById('fileViewerOverlay').classList.remove('open'); }

function renderFileMarkdown(text) {
  return esc(text)
    .replace(/^### (.+)$/gm,'<h3>$1</h3>')
    .replace(/^## (.+)$/gm,'<h2>$1</h2>')
    .replace(/^# (.+)$/gm,'<h1>$1</h1>')
    .replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>')
    .replace(/`([^`]+)`/g,'<code style="background:var(--surface2);padding:1px 4px;border-radius:3px">$1</code>')
    .replace(/^- (.+)$/gm,'‚Ä¢ $1')
    .replace(/^(\d+)\. (.+)$/gm,'$1. $2')
    .replace(/\n/g,'<br>');
}

// ‚ïê‚ïê‚ïê Create Channel ‚ïê‚ïê‚ïê
function openCreateChannel() {
  const installed=getInstalledAgents();
  document.getElementById('ccName').value='';
  document.getElementById('ccAgents').innerHTML=installed.map(a=>{
    const id=getAgentId(a);
    return `<div class="cc-agent-chip selected" data-agent="${id}" onclick="this.classList.toggle('selected')">
      <span class="cc-check">‚úì</span>
      <span>${a.emoji||'ü§ñ'} ${a.displayName||a.name}</span>
    </div>`;
  }).join('');
  document.getElementById('createChannelOverlay').classList.add('open');
  document.getElementById('ccName').focus();
}

function closeCreateChannel() {
  document.getElementById('createChannelOverlay').classList.remove('open');
}

function createChannel() {
  const name=document.getElementById('ccName').value.trim().toLowerCase().replace(/[^a-z0-9-]/g,'-').replace(/-+/g,'-');
  if(!name) { alert('Enter a channel name'); return; }
  if(customChannels.find(c=>c.id===`ch-${name}`)) { alert('Channel already exists'); return; }

  const selectedAgents=[];
  document.querySelectorAll('#ccAgents .cc-agent-chip.selected').forEach(el=>{
    selectedAgents.push(el.dataset.agent);
  });
  if(!selectedAgents.length) { alert('Select at least one agent'); return; }

  const channel={ id:`ch-${name}`, name, agents:selectedAgents };
  customChannels.push(channel);
  saveChannels();
  renderSidebar();
  closeCreateChannel();
  switchChannel(channel.id);
  addSystemMessage(channel.id, `üéâ Channel #${name} created ‚Äî ${selectedAgents.length} agent${selectedAgents.length>1?'s':''} invited`);
}

// ‚ïê‚ïê‚ïê Hire Modal ‚ïê‚ïê‚ïê
function openHireModal() {
  document.getElementById('hireTitle').textContent='‚ö° Hire an Agent';
  renderHireList();
  showHireView('hireBrowse');
  document.getElementById('hireModal').classList.add('open');
}
function closeHireModal() { document.getElementById('hireModal').classList.remove('open'); }

function showHireView(id) {
  ['hireBrowse','hireDetailView','hireOnboarding','hireCelebration'].forEach(v=>{
    document.getElementById(v).classList.toggle('view-hidden',v!==id);
  });
}

function renderHireList() {
  const el=document.getElementById('hireBrowse');
  el.innerHTML=agents.map(a=>{
    const inst=isInstalled(a);
    const price=formatPrice(a.price);
    const pc=(!a.price||a.price==='FREE')?'free':'paid';
    return `<div class="hire-card ${inst?'on-team':''}" onclick="${inst?'':`showHireDetail('${a.name}')`}">
      <div class="hc-top">
        <div class="hc-emoji">${a.emoji||'ü§ñ'}</div>
        <div class="hc-meta"><div class="hc-name">${a.displayName||a.name}</div><div class="hc-title">${a.title||''}</div></div>
        ${inst?'<span class="on-team-badge">‚úì Hired</span>':`<span class="hc-price ${pc}">${price}</span>`}
      </div>
      <div class="hc-desc">${a.description||''}</div>
    </div>`;
  }).join('');
}

function showHireDetail(name) {
  const a=agents.find(x=>x.name===name); if(!a) return;
  document.getElementById('hireTitle').textContent='Agent Details';
  const price=formatPrice(a.price);
  const pc=(!a.price||a.price==='FREE')?'free':'paid';
  document.getElementById('hireDetailView').innerHTML=`<div class="hire-detail-view">
    <button class="hd-back" onclick="showHireView('hireBrowse');document.getElementById('hireTitle').textContent='‚ö° Hire an Agent'">‚Üê Back</button>
    <div class="hd-hero"><div class="hd-emoji">${a.emoji||'ü§ñ'}</div><div class="hd-name">${a.displayName||a.name}</div><div class="hd-title">${a.title||''}</div></div>
    <div class="hd-section"><h3>About</h3><p>${a.description||'Ready to join your team.'}</p></div>
    ${(a.skills||[]).length?`<div class="hd-section"><h3>Skills</h3><div class="hd-skills">${a.skills.map(s=>`<span class="hd-skill">${esc(s)}</span>`).join('')}</div></div>`:''}
    <button class="hd-hire-btn" onclick="startOnboarding('${a.name}')">Hire ${a.displayName||a.name} ‚Üí</button>
  </div>`;
  showHireView('hireDetailView');
}

async function startOnboarding(name) {
  const a=agents.find(x=>x.name===name);
  const dn=a?.displayName||name;
  document.getElementById('hireTitle').textContent='Onboarding';
  document.getElementById('hireOnboarding').innerHTML=`<div class="onboarding-view">
    <div class="ob-emoji">${a?.emoji||'ü§ñ'}</div>
    <div class="ob-title">Hiring ${dn}...</div>
    <div class="ob-subtitle">Setting up workspace and tools</div>
    <div class="ob-steps">
      <div class="ob-step active" id="ob1"><span class="ob-check">‚è≥</span> Creating workspace</div>
      <div class="ob-step" id="ob2"><span class="ob-check">‚óã</span> Installing personality</div>
      <div class="ob-step" id="ob3"><span class="ob-check">‚óã</span> Configuring tools</div>
      <div class="ob-step" id="ob4"><span class="ob-check">‚óã</span> Booting agent</div>
    </div>
    <div class="ob-progress"><div class="ob-bar" id="obBar"></div></div>
  </div>`;
  showHireView('hireOnboarding');

  const steps=['ob1','ob2','ob3','ob4'];
  let step=0;
  function advance() {
    if(step>0){const p=document.getElementById(steps[step-1]);if(p){p.classList.remove('active');p.classList.add('done');p.querySelector('.ob-check').textContent='‚úì';}}
    if(step<4){const c=document.getElementById(steps[step]);if(c){c.classList.add('active');c.querySelector('.ob-check').textContent='‚è≥';}document.getElementById('obBar').style.width=((step+1)/4*100)+'%';}
    step++;
  }

  advance(); await sleep(800);
  advance();
  try { const r=await fetch(`${LOCAL}/api/agents/${name}/install`,{method:'POST'}); const d=await r.json(); if(!d.ok) throw new Error(d.error); } catch(e) { alert('Failed: '+e.message); showHireView('hireBrowse'); return; }
  await sleep(600); advance(); await sleep(800); advance(); await sleep(1000);
  const last=document.getElementById('ob4'); if(last){last.classList.remove('active');last.classList.add('done');last.querySelector('.ob-check').textContent='‚úì';}
  document.getElementById('obBar').style.width='100%';
  await sleep(500);
  showCelebration(a);
}

function showCelebration(a) {
  const dn=a?.displayName||a?.name||'Agent';
  document.getElementById('hireTitle').textContent='üéâ Welcome!';
  document.getElementById('hireCelebration').innerHTML=`<div class="celebration-view">
    <div class="cel-emoji">${a?.emoji||'ü§ñ'}</div>
    <h2>${dn} joined the team!</h2>
    <p>They're ready to work. Send them a DM to get started!</p>
    <button class="cel-btn" onclick="finishHiring('${getAgentId(a)}')">Go to DM ‚Üí</button>
  </div>`;
  showHireView('hireCelebration');
  spawnConfetti();
  loadAgents();
}

function finishHiring(agentId) {
  closeHireModal();
  switchChannel(`dm-${agentId}`);
  addSystemMessage('general', 'üéâ New team member hired!');
}

function spawnConfetti() {
  const c=document.createElement('div');c.className='confetti';document.body.appendChild(c);
  const colors=['#f0b429','#34d399','#60a5fa','#f87171','#a78bfa','#f472b6'];
  for(let i=0;i<50;i++){const p=document.createElement('div');p.className='confetti-piece';p.style.left=Math.random()*100+'%';p.style.background=colors[Math.floor(Math.random()*colors.length)];p.style.animationDelay=Math.random()+'s';p.style.animationDuration=(1.5+Math.random()*1.5)+'s';c.appendChild(p);}
  setTimeout(()=>c.remove(),4000);
}

// ‚ïê‚ïê‚ïê Fire Agent ‚ïê‚ïê‚ïê
function fireAgent(name) {
  const a=agents.find(x=>x.name===name);
  document.getElementById('confirmBox').innerHTML=`
    <div class="conf-emoji">${a?.emoji||'ü§ñ'}</div>
    <h3>Remove ${esc(a?.displayName||name)}?</h3>
    <p>They'll leave but their workspace is kept. You can hire them back later.</p>
    <div class="conf-btns">
      <button class="conf-btn conf-cancel" onclick="document.getElementById('confirmOverlay').classList.remove('open')">Keep</button>
      <button class="conf-btn conf-danger" onclick="doFire('${name}')">Remove</button>
    </div>`;
  document.getElementById('confirmOverlay').classList.add('open');
}
async function doFire(name) {
  document.getElementById('confirmOverlay').classList.remove('open');
  try { const r=await fetch(`${LOCAL}/api/agents/${name}/fire`,{method:'POST'}); const d=await r.json(); if(d.ok){addSystemMessage('general','üëã Agent removed.');setTimeout(()=>loadAgents(),2000);}} catch(e){alert(e.message);}
}

// ‚ïê‚ïê‚ïê Input Handling ‚ïê‚ïê‚ïê
function setupInputHandlers() {
  const input=document.getElementById('chatInput');
  input.addEventListener('keydown',e=>{
    if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMessage();}
  });
  // Auto-resize
  input.addEventListener('input',()=>{
    input.style.height='auto';
    input.style.height=Math.min(input.scrollHeight,120)+'px';
  });
}

// ‚ïê‚ïê‚ïê Persistence ‚ïê‚ïê‚ïê
function saveMessages() {
  localStorage.setItem('hq-messages',JSON.stringify(channelMessages));
  localStorage.setItem('hq-sessions',JSON.stringify(agentSessions));
}
function loadSavedMessages() {
  try { const m=JSON.parse(localStorage.getItem('hq-messages')||'{}'); Object.assign(channelMessages,m); } catch{}
  try { const s=JSON.parse(localStorage.getItem('hq-sessions')||'{}'); Object.assign(agentSessions,s); } catch{}
  try { customChannels=JSON.parse(localStorage.getItem('hq-custom-channels')||'[]'); } catch{}
  try { const u=JSON.parse(localStorage.getItem('hq-unread')||'{}'); Object.assign(unreadCounts,u); } catch{}
}
function saveChannels() { localStorage.setItem('hq-custom-channels',JSON.stringify(customChannels)); }
function saveUnread() { localStorage.setItem('hq-unread',JSON.stringify(unreadCounts)); }

// ‚ïê‚ïê‚ïê Waitlist ‚ïê‚ïê‚ïê
async function submitWaitlist() {
  const email=document.getElementById('wlEmail').value.trim();
  if(!email||!email.includes('@')) return alert('Enter a valid email.');
  try{await fetch('/api/waitlist',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,source:'hq',timestamp:new Date().toISOString()})});}catch{}
  document.getElementById('wlForm').style.display='none';
  document.getElementById('wlSuccess').classList.add('show');
}

// ‚ïê‚ïê‚ïê Helpers ‚ïê‚ïê‚ïê
function formatPrice(p){if(!p||p==='FREE')return'FREE';if(typeof p==='object')return`$${p.amount}/${p.interval}`;return p;}
function sleep(ms){return new Promise(r=>setTimeout(r,ms));}
function timeAgo(d){const s=Math.floor((Date.now()-d)/1000);if(s<60)return'just now';if(s<3600)return`${Math.floor(s/60)}m ago`;if(s<86400)return`${Math.floor(s/3600)}h ago`;return`${Math.floor(s/86400)}d ago`;}
function esc(t){const d=document.createElement('div');d.textContent=t||'';return d.innerHTML;}
function renderMarkdown(t) {
  return esc(t).replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/`([^`]+)`/g,'<code>$1</code>').replace(/\n/g,'<br>').replace(/(https?:\/\/[^\s<]+)/g,'<a href="$1" target="_blank">$1</a>');
}

// ‚ïê‚ïê‚ïê Output Feed ‚ïê‚ïê‚ïê
let outputFeedData = [];
let outputFilterAgent = 'all';
let outputFilterCategory = 'all';

async function loadOutputFeed() {
  const area = document.getElementById('messagesArea');
  area.innerHTML = '<div class="spacer"></div><div style="padding:20px;color:var(--muted);font-size:13px">Loading output files...</div>';
  try {
    const res = await fetch(`${LOCAL}/api/output-feed`);
    outputFeedData = await res.json();
    renderOutputFeed();
  } catch(e) {
    area.innerHTML = '<div class="spacer"></div><div style="padding:20px;color:var(--muted)">Failed to load output feed</div>';
  }
}

function renderOutputFeed() {
  const area = document.getElementById('messagesArea');
  const agents = [...new Set(outputFeedData.map(f => f.agentId))];
  const categories = [...new Set(outputFeedData.map(f => f.category))];

  let filtered = outputFeedData;
  if (outputFilterAgent !== 'all') filtered = filtered.filter(f => f.agentId === outputFilterAgent);
  if (outputFilterCategory !== 'all') filtered = filtered.filter(f => f.category === outputFilterCategory);

  let html = '<div class="output-feed">';
  // Filters
  html += '<div class="output-filters">';
  html += `<button class="output-filter${outputFilterAgent==='all'?' active':''}" onclick="setOutputFilter('agent','all')">All Agents</button>`;
  for (const a of agents) {
    const info = outputFeedData.find(f => f.agentId === a);
    html += `<button class="output-filter${outputFilterAgent===a?' active':''}" onclick="setOutputFilter('agent','${a}')">${info?.agentEmoji||'ü§ñ'} ${info?.agentName||a}</button>`;
  }
  html += '</div><div class="output-filters">';
  html += `<button class="output-filter${outputFilterCategory==='all'?' active':''}" onclick="setOutputFilter('category','all')">All Types</button>`;
  for (const c of categories) {
    html += `<button class="output-filter${outputFilterCategory===c?' active':''}" onclick="setOutputFilter('category','${c}')">${esc(c)}</button>`;
  }
  html += '</div>';
  html += `<div class="output-count">${filtered.length} files</div>`;

  // Cards
  for (let i = 0; i < filtered.length; i++) {
    const f = filtered[i];
    const age = f.mtime ? timeAgo(new Date(f.mtime)) : '';
    html += `<div class="output-card" id="oc-${i}" onclick="toggleOutputCard(${i},'${f.agentId}','${encodeURIComponent(f.path)}')">
      <div class="oc-header">
        <span class="oc-agent">${f.agentEmoji} ${f.agentName}</span>
        <span class="oc-badge ${f.category}">${f.category}</span>
        <span class="oc-file">${esc(f.filename)}</span>
        <span class="oc-time">${age}</span>
      </div>
      <div class="oc-preview">${esc(f.preview.slice(0, 200))}</div>
      <div class="oc-full-content" id="oc-full-${i}"></div>
    </div>`;
  }

  if (filtered.length === 0) {
    html += '<div style="padding:40px;text-align:center;color:var(--muted)">üì≠ No output files found</div>';
  }
  html += '</div>';
  area.innerHTML = html;
}

function setOutputFilter(type, value) {
  if (type === 'agent') outputFilterAgent = value;
  if (type === 'category') outputFilterCategory = value;
  renderOutputFeed();
}

async function toggleOutputCard(idx, agentId, encodedPath) {
  const el = document.getElementById(`oc-full-${idx}`);
  const card = document.getElementById(`oc-${idx}`);
  if (el.classList.contains('show')) {
    el.classList.remove('show');
    card.classList.remove('expanded');
    return;
  }
  card.classList.add('expanded');
  el.innerHTML = '<div style="color:var(--muted);font-size:12px">Loading...</div>';
  el.classList.add('show');
  try {
    const res = await fetch(`${LOCAL}/api/output-file/${agentId}/${encodedPath}`);
    if (!res.ok) throw new Error('Not found');
    const text = await res.text();
    el.innerHTML = renderFileMarkdown(text);
  } catch(e) {
    el.innerHTML = '<div style="color:var(--red)">Failed to load</div>';
  }
}

init();
</script>
</body>
</html>
