<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ü¶û Agent Arena HQ</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Inter:wght@400;500;600;700&display=swap');
  :root {
    --bg: #08080c; --surface: #111118; --surface2: #1a1a24;
    --border: #2a2a3a; --text: #e4e4e7; --muted: #71717a;
    --accent: #fbbf24; --green: #22c55e; --red: #ef4444; --blue: #3b82f6;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body { font-family:'Inter',sans-serif; background:var(--bg); color:var(--text); height:100vh; overflow:hidden; display:flex; flex-direction:column; }

  /* === Top Bar === */
  .topbar { padding:10px 20px; background:var(--surface); border-bottom:1px solid var(--border); display:flex; align-items:center; gap:16px; flex-shrink:0; z-index:10; }
  .topbar .logo { font-family:'Press Start 2P',monospace; font-size:11px; color:var(--accent); }
  .topbar a { color:var(--muted); text-decoration:none; font-size:13px; transition:color .15s; }
  .topbar a:hover { color:var(--text); }
  .topbar .spacer { flex:1; }
  .topbar .status-badge { font-size:10px; padding:4px 10px; border-radius:10px; font-weight:600; }
  .topbar .status-badge.online { color:var(--green); background:rgba(34,197,94,0.1); }
  .topbar .status-badge.offline { color:var(--red); background:rgba(239,68,68,0.1); }
  .topbar .clock { font-size:11px; color:var(--muted); font-variant-numeric:tabular-nums; }

  /* === Main Layout === */
  .main-layout { flex:1; display:flex; flex-direction:column; overflow:hidden; }

  /* === Office Scene === */
  .office-scene {
    flex: 0 0 320px; position:relative; overflow:hidden;
    background: linear-gradient(180deg, #1e1b2e 0%, #151320 100%);
    border-bottom: 1px solid var(--border);
  }

  /* Floor */
  .office-scene::after {
    content:''; position:absolute; bottom:0; left:0; right:0; height:120px;
    background: linear-gradient(180deg, #1a1728 0%, #13111f 100%);
    border-top: 2px solid rgba(251,191,36,0.06);
  }

  /* Wall details */
  .wall-shelf {
    position:absolute; top:30px; height:50px; z-index:1;
    background: linear-gradient(180deg, #2d2745 0%, #252040 100%);
    border: 1px solid rgba(255,255,255,0.05); border-radius:3px;
  }
  .wall-shelf.s1 { left:40px; width:120px; }
  .wall-shelf.s2 { right:60px; width:140px; }

  .wall-art {
    position:absolute; z-index:1; padding:8px 14px; border-radius:4px;
    background: rgba(0,0,0,0.3); border:2px solid rgba(255,255,255,0.08);
    font-size:10px; color:var(--muted); letter-spacing:0.5px;
  }
  .wall-art.a1 { top:20px; left:50%; transform:translateX(-50%); border-color:rgba(251,191,36,0.2); color:var(--accent); font-family:'Press Start 2P',monospace; font-size:8px; }
  .wall-art.a2 { top:35px; left:220px; }
  .wall-art.a3 { top:35px; right:260px; }

  /* Window */
  .window {
    position:absolute; top:10px; width:80px; height:60px; z-index:1;
    background: linear-gradient(180deg, #1a2040 0%, #2a3060 100%);
    border: 2px solid rgba(255,255,255,0.1); border-radius:4px;
    overflow:hidden;
  }
  .window.w1 { left:60%; }
  .window .stars { position:absolute; top:10px; left:15px; font-size:6px; color:rgba(255,255,255,0.4); }

  /* Desks */
  .desk-row {
    position:absolute; bottom:40px; left:50%; transform:translateX(-50%);
    display:flex; gap:24px; z-index:3;
  }

  .desk {
    width:160px; height:90px; position:relative; cursor:pointer;
    transition: transform 0.2s ease;
  }
  .desk:hover { transform:translateY(-2px); }

  .desk-surface {
    position:absolute; bottom:0; left:0; right:0; height:40px;
    background: linear-gradient(180deg, #3d3355 0%, #2d2545 100%);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 6px 6px 4px 4px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  }

  /* Monitor on desk */
  .desk-monitor {
    position:absolute; bottom:38px; left:50%; transform:translateX(-50%);
    width:50px; height:35px;
    background: linear-gradient(180deg, #0a0a12 0%, #12121e 100%);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius:3px;
    box-shadow: 0 0 8px rgba(59,130,246,0.1);
  }
  .desk-monitor::after {
    content:''; position:absolute; bottom:-4px; left:50%; transform:translateX(-50%);
    width:12px; height:4px; background:#2d2545; border-radius:0 0 2px 2px;
  }
  .desk-monitor .screen-glow {
    position:absolute; top:3px; left:3px; right:3px; bottom:5px;
    background: rgba(59,130,246,0.08); border-radius:1px;
  }
  .desk.active .desk-monitor .screen-glow { background:rgba(34,197,94,0.15); }

  /* Agent avatar at desk */
  .agent-avatar {
    position:absolute; bottom:55px; left:50%; transform:translateX(-50%);
    width:36px; height:36px; border-radius:50%;
    display:flex; align-items:center; justify-content:center;
    font-size:20px; z-index:4;
    background: rgba(17,17,24,0.8);
    border: 2px solid var(--border);
    transition: all 0.3s ease;
  }
  .desk.active .agent-avatar {
    border-color: var(--green);
    box-shadow: 0 0 12px rgba(34,197,94,0.2);
  }

  .agent-name-tag {
    position:absolute; bottom:78px; left:50%; transform:translateX(-50%);
    font-size:9px; font-weight:700; color:var(--text); white-space:nowrap;
    background:rgba(0,0,0,0.6); padding:2px 8px; border-radius:8px;
    z-index:5;
  }

  .agent-status-dot {
    position:absolute; bottom:57px; left:calc(50% + 12px);
    width:8px; height:8px; border-radius:50%; z-index:5;
    border: 1.5px solid var(--bg);
  }
  .agent-status-dot.online { background:var(--green); }
  .agent-status-dot.offline { background:var(--muted); }
  .agent-status-dot.busy { background:var(--accent); animation:pulse 1.5s infinite; }
  @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.4; } }

  /* Speech bubble */
  .speech-bubble {
    position:absolute; bottom:100px; left:50%; transform:translateX(-50%);
    background:var(--surface); border:1px solid var(--border); border-radius:10px;
    padding:6px 10px; font-size:10px; color:var(--muted); white-space:nowrap;
    opacity:0; transition:opacity 0.3s; z-index:6; max-width:200px;
    overflow:hidden; text-overflow:ellipsis;
  }
  .speech-bubble::after {
    content:''; position:absolute; bottom:-5px; left:50%; transform:translateX(-50%);
    width:8px; height:5px; background:var(--surface);
    clip-path:polygon(0 0, 100% 0, 50% 100%);
  }
  .speech-bubble.visible { opacity:1; }

  /* Decorations */
  .deco {
    position:absolute; z-index:2; font-size:16px;
    filter:drop-shadow(0 2px 4px rgba(0,0,0,0.3));
  }
  .deco.plant1 { bottom:130px; left:20px; font-size:24px; }
  .deco.plant2 { bottom:130px; right:30px; font-size:20px; }
  .deco.coffee { bottom:20px; right:50px; font-size:14px; }
  .deco.cat { bottom:25px; left:30px; font-size:18px; cursor:pointer; transition:transform .2s; }
  .deco.cat:hover { transform:scale(1.2) rotate(-5deg); }
  .deco.clock-wall { top:22px; left:50%; margin-left:100px; }
  .deco.whiteboard {
    top:8px; right:50px; width:100px; height:65px;
    background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.08);
    border-radius:3px; font-size:8px; padding:6px; color:var(--muted);
    line-height:1.4; overflow:hidden;
  }

  /* Meeting indicator */
  .meeting-bar {
    position:absolute; bottom:0; left:0; right:0; z-index:8;
    background: rgba(17,17,24,0.95); border-top:1px solid var(--border);
    padding:8px 16px; display:flex; align-items:center; gap:12px;
    backdrop-filter:blur(8px);
  }
  .meeting-bar .label { font-size:11px; color:var(--accent); font-weight:700; }
  .meeting-bar .participants { font-size:10px; color:var(--muted); }
  .meeting-bar .spacer { flex:1; }
  .meeting-bar button {
    padding:6px 14px; border:none; border-radius:6px; font-size:11px;
    font-weight:600; cursor:pointer; transition:all .15s;
  }
  .meeting-bar .start-btn { background:var(--green); color:#000; }
  .meeting-bar .start-btn:hover { filter:brightness(1.1); }
  .meeting-bar .end-btn { background:var(--red); color:#fff; display:none; }

  /* === Chat Panel === */
  .chat-panel {
    flex:1; display:flex; flex-direction:column; overflow:hidden;
    background:var(--surface);
  }

  .chat-header {
    padding:10px 20px; border-bottom:1px solid var(--border);
    display:flex; align-items:center; gap:12px; flex-shrink:0;
  }
  .chat-header h3 { font-size:13px; font-weight:700; }
  .chat-header .channel { font-size:11px; color:var(--muted); }
  .chat-header .spacer { flex:1; }
  .chat-header .toggle-btn {
    padding:4px 10px; background:rgba(255,255,255,0.05); border:1px solid var(--border);
    border-radius:6px; color:var(--muted); font-size:11px; cursor:pointer;
  }
  .chat-header .toggle-btn:hover { color:var(--text); border-color:var(--accent); }

  .messages {
    flex:1; overflow-y:auto; padding:16px 20px; display:flex;
    flex-direction:column; gap:2px;
  }

  .msg {
    padding:6px 0; line-height:1.5; font-size:13px;
    animation:fadeIn 0.2s ease;
  }
  @keyframes fadeIn { from { opacity:0; transform:translateY(4px); } to { opacity:1; transform:translateY(0); } }

  .msg .sender {
    font-weight:700; font-size:12px; margin-right:8px;
  }
  .msg .time {
    font-size:10px; color:var(--muted); margin-right:8px;
  }
  .msg .content { color:var(--text); }
  .msg .content code { background:rgba(255,255,255,0.06); padding:1px 4px; border-radius:3px; font-size:12px; }

  .msg-system {
    font-size:11px; color:var(--muted); text-align:center;
    padding:8px 0; font-style:italic;
  }

  .typing-line {
    font-size:11px; color:var(--muted); padding:4px 0;
    display:none;
  }
  .typing-line.active { display:block; }
  .typing-dots { display:inline-block; }
  .typing-dots span { animation:blink 1.4s infinite; }
  .typing-dots span:nth-child(2) { animation-delay:0.2s; }
  .typing-dots span:nth-child(3) { animation-delay:0.4s; }
  @keyframes blink { 0%,100% { opacity:0.2; } 50% { opacity:1; } }

  .chat-input-bar {
    padding:12px 20px; border-top:1px solid var(--border);
    display:flex; gap:10px; align-items:center; flex-shrink:0;
  }
  .chat-input-bar input {
    flex:1; padding:10px 14px; background:var(--bg); border:1px solid var(--border);
    border-radius:8px; color:var(--text); font-size:13px; outline:none;
    font-family:inherit;
  }
  .chat-input-bar input:focus { border-color:var(--accent); }
  .chat-input-bar input::placeholder { color:var(--muted); }
  .chat-input-bar button {
    padding:10px 18px; background:var(--accent); color:#000; border:none;
    border-radius:8px; font-weight:700; font-size:13px; cursor:pointer;
    transition:filter .15s;
  }
  .chat-input-bar button:hover { filter:brightness(1.1); }
  .chat-input-bar button:disabled { opacity:0.4; cursor:not-allowed; }

  /* === Waitlist Gate === */
  .waitlist-gate {
    display:none; flex:1; flex-direction:column; align-items:center;
    justify-content:center; padding:40px; text-align:center;
  }
  .waitlist-gate.active { display:flex; }
  .waitlist-gate .big-emoji { font-size:80px; margin-bottom:24px; }
  .waitlist-gate h1 { font-family:'Press Start 2P',monospace; font-size:20px; color:var(--accent); margin-bottom:16px; line-height:1.4; }
  .waitlist-gate p { font-size:15px; color:var(--muted); line-height:1.6; max-width:480px; margin-bottom:32px; }
  .waitlist-gate .form-row { display:flex; gap:12px; max-width:400px; width:100%; }
  .waitlist-gate input {
    flex:1; padding:14px 18px; background:var(--surface); border:1px solid var(--border);
    border-radius:8px; color:var(--text); font-size:14px; outline:none;
  }
  .waitlist-gate input:focus { border-color:var(--accent); }
  .waitlist-gate .join-btn {
    padding:14px 24px; background:var(--accent); color:#000; border:none;
    border-radius:8px; font-weight:700; font-size:14px; cursor:pointer; white-space:nowrap;
  }
  .waitlist-gate .success-msg { display:none; font-size:18px; color:var(--green); }
  .waitlist-gate .success-msg.show { display:block; }
  .waitlist-gate .preview-cards {
    display:flex; gap:16px; margin-top:40px; flex-wrap:wrap; justify-content:center;
  }
  .waitlist-gate .preview-card {
    background:var(--surface); border:1px solid var(--border); border-radius:10px;
    padding:20px; width:160px; text-align:center;
  }
  .waitlist-gate .preview-card .emoji { font-size:28px; margin-bottom:8px; }
  .waitlist-gate .preview-card .title { font-size:12px; font-weight:700; margin-bottom:4px; }
  .waitlist-gate .preview-card .desc { font-size:10px; color:var(--muted); }

  /* Resize handle */
  .resize-handle {
    height:6px; background:var(--bg); cursor:ns-resize; flex-shrink:0;
    display:flex; align-items:center; justify-content:center;
    border-top:1px solid var(--border); border-bottom:1px solid var(--border);
  }
  .resize-handle::after { content:''; width:30px; height:2px; background:var(--border); border-radius:2px; }
  .resize-handle:hover::after { background:var(--accent); }
</style>
</head>
<body>

<!-- Top Bar -->
<div class="topbar">
  <span class="logo">ü¶û AGENT ARENA HQ</span>
  <a href="index.html">Home</a>
  <a href="agents.html">Agents</a>
  <a href="app.html">Dashboard</a>
  <div class="spacer"></div>
  <span class="clock" id="clock"></span>
  <span class="status-badge offline" id="statusBadge">‚óè Offline</span>
</div>

<!-- Waitlist Gate (public visitors) -->
<div class="waitlist-gate" id="waitlistGate">
  <div class="big-emoji">ü¶û</div>
  <h1>Agent Arena HQ</h1>
  <p>Your AI team's virtual office. Watch them work, join meetings, and collaborate in real-time. Currently in development.</p>
  <div class="form-row" id="waitlistForm">
    <input type="email" id="waitlistEmail" placeholder="you@example.com">
    <button class="join-btn" onclick="submitWaitlist()">Get Early Access ü¶û</button>
  </div>
  <div class="success-msg" id="waitlistSuccess">‚úÖ You're on the list! We'll be in touch.</div>
  <div class="preview-cards">
    <div class="preview-card"><div class="emoji">üè¢</div><div class="title">Virtual Office</div><div class="desc">See your agents at their desks, working in real-time</div></div>
    <div class="preview-card"><div class="emoji">üí¨</div><div class="title">Team Chat</div><div class="desc">Group standup meetings with all your agents</div></div>
    <div class="preview-card"><div class="emoji">üîí</div><div class="title">100% Local</div><div class="desc">Your agents never leave your machine</div></div>
  </div>
</div>

<!-- Main HQ (local users only) -->
<div class="main-layout" id="mainLayout" style="display:none;">

  <!-- Office Scene -->
  <div class="office-scene" id="officeScene">
    <!-- Wall decorations -->
    <div class="wall-art a1">AGENT ARENA HQ</div>
    <div class="wall-art a2">üìä Q1 Goals</div>
    <div class="wall-art a3">üöÄ Ship It</div>
    <div class="window w1"><div class="stars">‚ú¶ ¬∑ ‚úß ¬∑ ‚ú¶</div></div>
    <div class="deco whiteboard" id="whiteboard">üìã Sprint Goals<br>‚Üí Launch v1<br>‚Üí Get users<br>‚Üí Ship fast</div>

    <!-- Decorations -->
    <div class="deco plant1">ü™¥</div>
    <div class="deco plant2">üåø</div>
    <div class="deco coffee">‚òï</div>
    <div class="deco cat" id="officeCat" title="Click me!">üò∫</div>
    <div class="deco clock-wall" id="wallClock">üïê</div>

    <!-- Desk row (populated by JS) -->
    <div class="desk-row" id="deskRow"></div>

    <!-- Meeting bar -->
    <div class="meeting-bar">
      <span class="label">üéôÔ∏è Team Standup</span>
      <span class="participants" id="meetingParticipants">No agents online</span>
      <div class="spacer"></div>
      <button class="start-btn" id="startMeetingBtn" onclick="startMeeting()">Start Meeting</button>
      <button class="end-btn" id="endMeetingBtn" onclick="endMeeting()">End Meeting</button>
    </div>
  </div>

  <!-- Resize Handle -->
  <div class="resize-handle" id="resizeHandle"></div>

  <!-- Chat Panel -->
  <div class="chat-panel">
    <div class="chat-header">
      <h3>üí¨ #general</h3>
      <span class="channel">Team Chat</span>
      <div class="spacer"></div>
    </div>
    <div class="messages" id="messages"></div>
    <div class="typing-line" id="typingLine">
      <span id="typingWho"></span> is typing<span class="typing-dots"><span>.</span><span>.</span><span>.</span></span>
    </div>
    <div class="chat-input-bar">
      <input type="text" id="chatInput" placeholder="Message #general..." autocomplete="off">
      <button id="sendBtn" onclick="sendMessage()">Send</button>
    </div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ State ‚îÄ‚îÄ
let ws = null;
let agents = [];
let registeredAgents = [];
let sessions = {};
let streamBuffers = {};
let meetingActive = false;
let agentStates = {}; // agentId -> { status, lastMessage }

const LOCAL = `${location.protocol}//${location.host}`;
const WS_URL = `ws://${location.host}`;

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ
async function init() {
  updateClock();
  setInterval(updateClock, 30000);
  setupResize();
  setupInput();
  setupCat();
  await checkConnection();
}

// ‚îÄ‚îÄ Connection Check ‚îÄ‚îÄ
async function checkConnection() {
  try {
    const res = await fetch(`${LOCAL}/api/agents`, { signal: AbortSignal.timeout(3000) });
    if (!res.ok) throw new Error();
    updateStatus(true);
    document.getElementById('mainLayout').style.display = 'flex';
    document.getElementById('waitlistGate').classList.remove('active');
    await loadAgents();
    connectWS();
    loadChat();
  } catch {
    document.getElementById('waitlistGate').classList.add('active');
    document.getElementById('mainLayout').style.display = 'none';
    updateStatus(false);
  }
}

// ‚îÄ‚îÄ Load Agents ‚îÄ‚îÄ
async function loadAgents() {
  try {
    const [aRes, rRes] = await Promise.all([
      fetch(`${LOCAL}/api/agents`), fetch(`${LOCAL}/api/agents/registered`)
    ]);
    agents = await aRes.json();
    registeredAgents = await rRes.json();
    renderDesks();
    updateMeetingParticipants();
  } catch(e) { console.error('Load agents failed:', e); }
}

// ‚îÄ‚îÄ Render Desks ‚îÄ‚îÄ
function renderDesks() {
  const row = document.getElementById('deskRow');
  const regIds = new Set(registeredAgents.map(a => a.id));
  const installed = agents.filter(a => regIds.has(a.name.replace(/-agent$/, '')));
  
  row.innerHTML = installed.map(agent => {
    const id = agent.name.replace(/-agent$/, '');
    const isOnline = regIds.has(id);
    return `
      <div class="desk ${isOnline ? 'active' : ''}" data-agent="${agent.name}" onclick="focusAgent('${agent.name}')">
        <div class="agent-name-tag">${agent.displayName || agent.name}</div>
        <div class="speech-bubble" id="bubble-${id}"></div>
        <div class="agent-avatar">${agent.emoji || 'ü§ñ'}</div>
        <div class="agent-status-dot ${isOnline ? 'online' : 'offline'}"></div>
        <div class="desk-surface"></div>
        <div class="desk-monitor"><div class="screen-glow"></div></div>
      </div>
    `;
  }).join('');

  // Also add uninstalled agents as "empty desks"
  const uninstalled = agents.filter(a => !regIds.has(a.name.replace(/-agent$/, ''))).slice(0, 2);
  uninstalled.forEach(agent => {
    row.innerHTML += `
      <div class="desk" data-agent="${agent.name}" style="opacity:0.4;" title="Not installed">
        <div class="agent-name-tag" style="opacity:0.5;">${agent.displayName || agent.name}</div>
        <div class="agent-avatar" style="filter:grayscale(1);">${agent.emoji || 'ü§ñ'}</div>
        <div class="agent-status-dot offline"></div>
        <div class="desk-surface"></div>
        <div class="desk-monitor"><div class="screen-glow"></div></div>
      </div>
    `;
  });
}

// ‚îÄ‚îÄ Focus Agent (click desk) ‚îÄ‚îÄ
function focusAgent(agentName) {
  const agent = agents.find(a => a.name === agentName);
  if (!agent) return;
  const input = document.getElementById('chatInput');
  input.placeholder = `Message ${agent.displayName || agentName}...`;
  input.focus();
}

// ‚îÄ‚îÄ WebSocket ‚îÄ‚îÄ
function connectWS() {
  if (ws && ws.readyState === WebSocket.OPEN) return;
  ws = new WebSocket(WS_URL);
  ws.onopen = () => { updateStatus(true); };
  ws.onclose = () => { updateStatus(false); setTimeout(connectWS, 3000); };
  ws.onerror = (e) => console.error('WS error:', e);
  ws.onmessage = (e) => {
    try { handleWSMessage(JSON.parse(e.data)); } catch(err) { console.error(err); }
  };
}

function handleWSMessage(msg) {
  if (msg.type === 'status') updateStatus(msg.connected);
  if (msg.type === 'chat-delta') handleDelta(msg);
  if (msg.type === 'chat-final') handleFinal(msg);
}

function handleDelta(msg) {
  const text = extractText(msg.message);
  if (!text) return;
  streamBuffers[msg.runId] = (streamBuffers[msg.runId] || '') + text;
  if (msg.sessionKey) sessions[msg.agentPkg] = msg.sessionKey;
  
  const agent = agents.find(a => a.name === msg.agentPkg);
  const id = msg.agentPkg.replace(/-agent$/, '');
  
  // Update typing
  showTyping(agent?.displayName || id);
  
  // Update speech bubble
  const bubble = document.getElementById(`bubble-${id}`);
  if (bubble) {
    bubble.textContent = (streamBuffers[msg.runId] || '').slice(-60);
    bubble.classList.add('visible');
  }
  
  // Update desk status
  const dot = document.querySelector(`.desk[data-agent="${msg.agentPkg}"] .agent-status-dot`);
  if (dot) { dot.className = 'agent-status-dot busy'; }
}

function handleFinal(msg) {
  const fullText = streamBuffers[msg.runId] || extractText(msg.message);
  delete streamBuffers[msg.runId];
  if (msg.sessionKey) sessions[msg.agentPkg] = msg.sessionKey;
  
  const agent = agents.find(a => a.name === msg.agentPkg);
  const id = msg.agentPkg.replace(/-agent$/, '');
  const name = agent?.displayName || id;
  
  if (fullText) {
    addMessage(name, fullText, agent?.emoji || 'ü§ñ');
    saveChat();
  }
  
  hideTyping();
  
  // Clear speech bubble after delay
  const bubble = document.getElementById(`bubble-${id}`);
  if (bubble) setTimeout(() => bubble.classList.remove('visible'), 3000);
  
  // Reset desk status
  const dot = document.querySelector(`.desk[data-agent="${msg.agentPkg}"] .agent-status-dot`);
  if (dot) { dot.className = 'agent-status-dot online'; }
}

function extractText(message) {
  if (typeof message === 'string') return message;
  if (Array.isArray(message)) return message.filter(p => p.type === 'text').map(p => p.text).join('');
  if (message?.content) return extractText(message.content);
  return message?.text || '';
}

// ‚îÄ‚îÄ Send Message ‚îÄ‚îÄ
function sendMessage() {
  const input = document.getElementById('chatInput');
  const text = input.value.trim();
  if (!text || !ws || ws.readyState !== WebSocket.OPEN) return;
  
  input.value = '';
  addMessage('You', text, 'üë§');
  
  // Send to ALL installed agents
  const regIds = new Set(registeredAgents.map(a => a.id));
  const installed = agents.filter(a => regIds.has(a.name.replace(/-agent$/, '')));
  
  installed.forEach(agent => {
    ws.send(JSON.stringify({
      type: 'chat',
      agentPkg: agent.name,
      message: text,
      sessionKey: sessions[agent.name] || null
    }));
  });
  
  saveChat();
}

// ‚îÄ‚îÄ Meeting ‚îÄ‚îÄ
function startMeeting() {
  meetingActive = true;
  document.getElementById('startMeetingBtn').style.display = 'none';
  document.getElementById('endMeetingBtn').style.display = 'block';
  addSystemMessage('üéôÔ∏è Team standup started');
  
  // Send standup prompt to all agents
  const input = document.getElementById('chatInput');
  const old = input.value;
  input.value = "Quick standup: What are you working on today? Any blockers? Keep it brief.";
  sendMessage();
  input.value = old;
}

function endMeeting() {
  meetingActive = false;
  document.getElementById('startMeetingBtn').style.display = 'block';
  document.getElementById('endMeetingBtn').style.display = 'none';
  addSystemMessage('üéôÔ∏è Standup ended');
}

// ‚îÄ‚îÄ Chat UI ‚îÄ‚îÄ
function addMessage(sender, text, emoji) {
  const container = document.getElementById('messages');
  const el = document.createElement('div');
  el.className = 'msg';
  const now = new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
  const color = sender === 'You' ? 'var(--accent)' : 'var(--green)';
  
  // Simple markdown: **bold**, `code`, newlines
  let html = escapeHtml(text)
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    .replace(/`([^`]+)`/g, '<code>$1</code>')
    .replace(/\n/g, '<br>');
  
  el.innerHTML = `<span class="time">${now}</span><span class="sender" style="color:${color}">${emoji} ${sender}</span><span class="content">${html}</span>`;
  container.appendChild(el);
  container.scrollTop = container.scrollHeight;
}

function addSystemMessage(text) {
  const container = document.getElementById('messages');
  const el = document.createElement('div');
  el.className = 'msg-system';
  el.textContent = text;
  container.appendChild(el);
  container.scrollTop = container.scrollHeight;
}

function showTyping(name) {
  const line = document.getElementById('typingLine');
  document.getElementById('typingWho').textContent = name;
  line.classList.add('active');
}

function hideTyping() {
  document.getElementById('typingLine').classList.remove('active');
}

// ‚îÄ‚îÄ Persistence ‚îÄ‚îÄ
function saveChat() {
  const html = document.getElementById('messages').innerHTML;
  localStorage.setItem('hq-chat', html);
  localStorage.setItem('hq-sessions', JSON.stringify(sessions));
}

function loadChat() {
  const saved = localStorage.getItem('hq-chat');
  if (saved) document.getElementById('messages').innerHTML = saved;
  const savedSessions = localStorage.getItem('hq-sessions');
  if (savedSessions) sessions = JSON.parse(savedSessions);
  document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
}

// ‚îÄ‚îÄ UI Helpers ‚îÄ‚îÄ
function updateStatus(online) {
  const badge = document.getElementById('statusBadge');
  badge.textContent = online ? '‚óè Online' : '‚óè Offline';
  badge.className = `status-badge ${online ? 'online' : 'offline'}`;
}

function updateClock() {
  const now = new Date();
  document.getElementById('clock').textContent = now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
  // Update wall clock emoji
  const h = now.getHours() % 12;
  const clocks = ['üïõ','üïê','üïë','üïí','üïì','üïî','üïï','üïñ','üïó','üïò','üïô','üïö'];
  const el = document.getElementById('wallClock');
  if (el) el.textContent = clocks[h];
}

function updateMeetingParticipants() {
  const regIds = new Set(registeredAgents.map(a => a.id));
  const online = agents.filter(a => regIds.has(a.name.replace(/-agent$/, '')));
  document.getElementById('meetingParticipants').textContent = 
    online.length > 0 ? `${online.map(a => a.emoji || 'ü§ñ').join(' ')} ${online.length} agent${online.length>1?'s':''} ready` : 'No agents online';
}

// ‚îÄ‚îÄ Resize handle ‚îÄ‚îÄ
function setupResize() {
  const handle = document.getElementById('resizeHandle');
  const scene = document.getElementById('officeScene');
  let startY, startH;
  
  handle.addEventListener('mousedown', (e) => {
    startY = e.clientY;
    startH = scene.offsetHeight;
    document.addEventListener('mousemove', onResize);
    document.addEventListener('mouseup', stopResize);
    e.preventDefault();
  });
  
  function onResize(e) {
    const newH = Math.max(150, Math.min(600, startH + e.clientY - startY));
    scene.style.flex = `0 0 ${newH}px`;
  }
  function stopResize() {
    document.removeEventListener('mousemove', onResize);
    document.removeEventListener('mouseup', stopResize);
  }
}

// ‚îÄ‚îÄ Input ‚îÄ‚îÄ
function setupInput() {
  document.getElementById('chatInput').addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
  });
}

// ‚îÄ‚îÄ Cat ‚îÄ‚îÄ
function setupCat() {
  const cat = document.getElementById('officeCat');
  const faces = ['üò∫','üò∏','üòπ','üòª','üòº','üòΩ','üôÄ','üòø','üòæ','üò∫'];
  let i = 0;
  cat.addEventListener('click', () => { i = (i+1) % faces.length; cat.textContent = faces[i]; });
}

// ‚îÄ‚îÄ Waitlist ‚îÄ‚îÄ
async function submitWaitlist() {
  const email = document.getElementById('waitlistEmail').value.trim();
  if (!email || !email.includes('@')) return alert('Enter a valid email.');
  
  try {
    await fetch('/api/waitlist', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ email, source:'hq-waitlist', timestamp:new Date().toISOString() })
    });
  } catch(e) {
    const list = JSON.parse(localStorage.getItem('waitlist-emails') || '[]');
    list.push({ email, timestamp: new Date().toISOString() });
    localStorage.setItem('waitlist-emails', JSON.stringify(list));
  }
  
  document.getElementById('waitlistForm').style.display = 'none';
  document.getElementById('waitlistSuccess').classList.add('show');
}

// ‚îÄ‚îÄ Escape HTML ‚îÄ‚îÄ
function escapeHtml(t) { const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }

// ‚îÄ‚îÄ Go ‚îÄ‚îÄ
init();
</script>
</body>
</html>
