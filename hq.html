<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ü¶û Agent Arena HQ</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Inter:wght@400;500;600;700&display=swap');
  :root {
    --bg: #0d0d14; --surface: #16161e; --border: #2a2a3a;
    --text: #e4e4e7; --muted: #71717a; --accent: #fbbf24;
    --green: #22c55e; --red: #ef4444;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body { font-family:'Inter',sans-serif; background:var(--bg); color:var(--text); height:100vh; display:flex; flex-direction:column; overflow:hidden; }

  nav { padding:10px 20px; background:var(--surface); border-bottom:1px solid var(--border); display:flex; align-items:center; gap:16px; flex-shrink:0; }
  nav .logo { font-family:'Press Start 2P',monospace; font-size:11px; color:var(--accent); }
  nav a { color:var(--muted); text-decoration:none; font-size:13px; }
  nav a:hover, nav a.active { color:var(--text); }
  nav .spacer { flex:1; }
  nav .status { font-size:11px; padding:4px 10px; border-radius:10px; }
  nav .status.online { color:var(--green); background:rgba(34,197,94,0.1); }
  nav .status.offline { color:var(--red); background:rgba(239,68,68,0.1); }

  .main { flex:1; display:flex; overflow:hidden; }

  /* Office */
  .office-wrap { flex:1; display:flex; flex-direction:column; border-right:1px solid var(--border); }
  .office-topbar { padding:10px 16px; background:var(--surface); border-bottom:1px solid var(--border); display:flex; align-items:center; gap:12px; }
  .office-topbar h2 { font-family:'Press Start 2P',monospace; font-size:10px; color:var(--accent); }
  .office-topbar .squad { font-size:11px; color:var(--muted); }
  .office-topbar .clock { font-size:11px; color:var(--muted); margin-left:auto; }

  .office {
    flex:1; position:relative; overflow:hidden;
    background: linear-gradient(170deg, #2a2540 0%, #1e1b30 40%, #231f35 100%);
  }
  .wall { position:absolute; top:0; left:0; right:0; height:100px;
    background: linear-gradient(180deg, #4a3f6b 0%, #3d3355 50%, #2a2540 100%);
    border-bottom: 3px solid rgba(251,191,36,0.08);
  }
  .wall::after { content:''; position:absolute; bottom:0; left:0; right:0; height:4px;
    background: linear-gradient(90deg, #5c3d1e, #8b6842, #5c3d1e);
  }
  .poster { position:absolute; padding:6px 12px; border-radius:3px; background:rgba(0,0,0,0.3);
    border:2px solid rgba(255,255,255,0.1); font-size:9px; color:var(--muted); z-index:2; }
  .poster.p1 { top:12px; left:40px; border-color:rgba(34,197,94,0.3); }
  .poster.p2 { top:16px; left:200px; border-color:rgba(251,191,36,0.3); }
  .poster.p3 { top:12px; right:40px; border-color:rgba(239,68,68,0.3); }

  .desk { position:absolute; width:120px; height:50px; z-index:3;
    background: linear-gradient(135deg, #8b6842, #5c3d1e);
    border-radius:4px; border:1px solid rgba(255,255,255,0.05);
    box-shadow: 0 4px 8px rgba(0,0,0,0.4);
  }
  .desk::before { content:''; position:absolute; top:4px; left:8px; right:8px; height:28px;
    background: linear-gradient(135deg, #333, #222); border-radius:3px;
    box-shadow: inset 0 0 4px rgba(0,200,255,0.1);
  }
  .desk-label { position:absolute; bottom:-14px; left:50%; transform:translateX(-50%);
    font-family:'Press Start 2P',monospace; font-size:6px; color:var(--muted); white-space:nowrap; }

  .plant { position:absolute; font-size:20px; z-index:2; }
  .couch { position:absolute; z-index:2; font-size:11px; color:var(--muted); padding:8px 14px;
    background:rgba(100,60,30,0.3); border-radius:8px; border:1px solid rgba(100,60,30,0.4); }
  .coffee-station { position:absolute; z-index:2; text-align:center; font-size:9px; color:var(--muted); }
  .coffee-station .icon { font-size:18px; }

  .agent-char { position:absolute; z-index:10; cursor:pointer; text-align:center; transition: left 2s ease, top 2s ease; }
  .agent-char:hover { z-index:20; }
  .agent-char:hover .bubble { opacity:1 !important; }
  .agent-char.selected .bubble { opacity:1 !important; }
  .agent-char.selected { filter: drop-shadow(0 0 8px rgba(251,191,36,0.6)); }
  .agent-sprite { font-size:28px; position:relative; }
  .agent-sprite .dot { position:absolute; bottom:0; right:-2px; width:8px; height:8px; border-radius:50%; border:2px solid var(--bg); }
  .dot.on { background:var(--green); box-shadow:0 0 6px rgba(34,197,94,0.5); }
  .nametag { font-family:'Press Start 2P',monospace; font-size:5px; margin-top:2px; }
  .bubble { position:absolute; bottom:100%; left:50%; transform:translateX(-50%);
    background:rgba(0,0,0,0.7); color:var(--text); font-size:9px; padding:4px 8px;
    border-radius:8px; white-space:nowrap; opacity:0; transition:opacity 0.2s; pointer-events:none; margin-bottom:4px; }

  /* Chat */
  .chat-wrap { width:400px; display:flex; flex-direction:column; }
  .chat-header { padding:12px 16px; background:var(--surface); border-bottom:1px solid var(--border); display:flex; align-items:center; gap:10px; }
  .chat-header h2 { font-family:'Press Start 2P',monospace; font-size:10px; color:var(--accent); }
  .chat-header .online { font-size:11px; color:var(--green); }

  .messages { flex:1; overflow-y:auto; padding:16px; display:flex; flex-direction:column; gap:10px; }
  .msg { max-width:85%; padding:8px 12px; border-radius:10px; font-size:12px; line-height:1.5; word-wrap:break-word; }
  .msg.agent { background:var(--surface); border:1px solid var(--border); align-self:flex-start; }
  .msg .sender { font-size:10px; font-weight:700; margin-bottom:4px; }
  .msg.user { background:rgba(251,191,36,0.1); border:1px solid rgba(251,191,36,0.2); align-self:flex-end; }
  .msg.system { align-self:center; color:var(--muted); font-size:10px; background:none; border:none; }

  .chat-input { padding:10px 16px; border-top:1px solid var(--border); display:flex; gap:6px; }
  .chat-input input { flex:1; padding:8px 12px; background:var(--surface); border:1px solid var(--border);
    border-radius:6px; color:var(--text); font-size:12px; outline:none; }
  .chat-input input:focus { border-color:var(--accent); }
  .chat-input button { padding:8px 14px; background:var(--accent); color:#000; border:none;
    border-radius:6px; font-weight:600; cursor:pointer; font-size:12px; }

  @media(max-width:768px) {
    .main { flex-direction:column; }
    .office-wrap { height:35vh; border-right:none; border-bottom:1px solid var(--border); }
    .chat-wrap { width:100%; flex:1; }
  }
</style>
</head>
<body>

<nav>
  <span class="logo">ü¶û AGENT ARENA</span>
  <a href="index.html">Home</a>
  <a href="agents.html">Agents</a>
  <a href="hq.html" class="active">HQ</a>
  <span class="spacer"></span>
  <span class="status offline" id="gwStatus">‚óè Disconnected</span>
</nav>

<div class="main">
  <div class="office-wrap">
    <div class="office-topbar">
      <h2>üè¢ THE OFFICE</h2>
      <span class="squad" id="squadCount">0 agents</span>
      <span class="clock" id="clock"></span>
    </div>
    <div class="office" id="office">
      <div class="wall">
        <div class="poster p1">ü¶û SHIP IT</div>
        <div class="poster p2">üìà GROW OR DIE</div>
        <div class="poster p3">üîí TRUST NO PORT</div>
      </div>
      <div class="plant" style="left:20px;top:120px;">ü™¥</div>
      <div class="plant" style="right:20px;top:130px;">üåø</div>
      <div class="couch" style="left:30px;bottom:40px;">üõãÔ∏è chill zone</div>
      <div class="coffee-station" style="right:30px;top:120px;"><div class="icon">‚òï</div>COFFEE</div>
      <div id="desks"></div>
      <div id="chars"></div>
    </div>
  </div>

  <div class="chat-wrap">
    <div class="chat-header">
      <h2>üí¨ GROUP CHAT</h2>
      <span class="online" id="onlineCount">0 online</span>
    </div>
    <div class="messages" id="messages">
      <div class="msg system">Message your team ‚Äî all agents respond here</div>
    </div>
    <div class="chat-input">
      <input type="text" id="chatInput" placeholder="Message your team..." onkeydown="if(event.key==='Enter')send()">
      <button onclick="send()">Send</button>
    </div>
  </div>
</div>

<script>
const WS_URL = `ws://${location.host}`;
let ws = null;
let agentData = {};   // id -> {emoji, displayName, pkgName, ...}
let sessions = {};    // id -> sessionKey (for the arena session)
let streamBuffers = {};
let pendingAgents = new Set(); // agents we're waiting on a response from

function connectWS() {
  ws = new WebSocket(WS_URL);
  ws.onopen = () => updateGW(true);
  ws.onclose = () => { updateGW(false); setTimeout(connectWS, 3000); };
  ws.onmessage = e => { try { handleMsg(JSON.parse(e.data)); } catch(err) { console.error(err); } };
}

function updateGW(on) {
  const el = document.getElementById('gwStatus');
  el.textContent = on ? '‚óè Connected' : '‚óè Disconnected';
  el.className = 'status ' + (on ? 'online' : 'offline');
}

function handleMsg(msg) {
  if (msg.type === 'status') updateGW(msg.connected);

  if (msg.type === 'chat-delta') {
    const id = pkgToId(msg.agentPkg);
    const text = extractText(msg.message);
    if (text) streamBuffers[msg.runId] = text;
    // Save session key
    if (msg.sessionKey && !sessions[id]) sessions[id] = msg.sessionKey;
    // Update streaming bubble in chat
    if (pendingAgents.has(id) && text) {
      const a = agentData[id];
      const el = document.getElementById('messages');
      let s = document.getElementById('stream-' + id);
      if (!s) { s = document.createElement('div'); s.id = 'stream-' + id; s.className = 'msg agent'; el.appendChild(s); }
      s.innerHTML = `<div class="sender" style="color:${a?.color || '#fbbf24'}">${a?.emoji || 'ü§ñ'} ${a?.displayName || id}</div>${esc(streamBuffers[msg.runId])}`;
      el.scrollTop = el.scrollHeight;
      // Update office bubble
      const bubble = document.getElementById('bubble-' + id);
      if (bubble) { bubble.textContent = 'Typing...'; bubble.style.opacity = '0.9'; }
    }
  }

  if (msg.type === 'chat-final') {
    const id = pkgToId(msg.agentPkg);
    if (msg.sessionKey) sessions[id] = msg.sessionKey;
    let text = streamBuffers[msg.runId] || extractText(msg.message);
    delete streamBuffers[msg.runId];
    if (pendingAgents.has(id) && text) {
      pendingAgents.delete(id);
      const a = agentData[id];
      const el = document.getElementById('messages');
      // Remove stream element
      const s = document.getElementById('stream-' + id);
      if (s) s.remove();
      // Add final message
      el.innerHTML += `<div class="msg agent"><div class="sender" style="color:${a?.color || '#fbbf24'}">${a?.emoji || 'ü§ñ'} ${a?.displayName || id}</div>${esc(text)}</div>`;
      el.scrollTop = el.scrollHeight;
      // Update office bubble
      const bubble = document.getElementById('bubble-' + id);
      if (bubble) { bubble.textContent = 'Done'; setTimeout(() => { bubble.style.opacity = ''; bubble.textContent = 'Click to chat'; }, 3000); }
    }
  }

  if (msg.type === 'error') console.error('Server:', msg.error);
}

function extractText(m) {
  if (typeof m === 'string') return m;
  if (Array.isArray(m)) return m.filter(p => p.type === 'text').map(p => p.text).join('');
  if (m?.content) return extractText(m.content);
  return m?.text || '';
}
function pkgToId(pkg) { return pkg?.replace(/-agent$/, '') || pkg; }
function esc(s) { return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>'); }

const deskSlots = [
  { left: 80, top: 160 }, { left: 260, top: 160 }, { left: 440, top: 160 },
  { left: 170, top: 280 }, { left: 350, top: 280 },
];

async function init() {
  try {
    const [regRes, pkgRes] = await Promise.all([fetch('/api/agents/registered'), fetch('/api/agents')]);
    const registered = await regRes.json(), packages = await pkgRes.json();
    const pkgMap = {}; packages.forEach(p => pkgMap[p.name] = p);
    const desksEl = document.getElementById('desks'), charsEl = document.getElementById('chars');
    let count = 0;

    registered.forEach((a, i) => {
      const id = a.id, pkg = pkgMap[id + '-agent'] || pkgMap[id] || {};
      const slot = deskSlots[i % deskSlots.length];
      const color = pkg.color || ['#22c55e', '#ec4899', '#ef4444', '#3b82f6', '#a855f7'][i % 5];

      agentData[id] = {
        emoji: pkg.emoji || 'ü§ñ', displayName: pkg.displayName || a.name || id,
        pkgName: pkg.name || id + '-agent', color, slot,
      };

      desksEl.innerHTML += `<div class="desk" style="left:${slot.left}px;top:${slot.top}px;">
        <div class="desk-label">${(a.name || id).toUpperCase()}</div></div>`;

      charsEl.innerHTML += `<div class="agent-char" id="char-${id}" style="left:${slot.left + 45}px;top:${slot.top - 45}px;" onclick="clickAgent('${id}')">
        <div class="bubble" id="bubble-${id}">Click to chat</div>
        <div class="agent-sprite">${agentData[id].emoji}<div class="dot on"></div></div>
        <div class="nametag" style="color:${color}">${(a.name || id).toUpperCase()}</div>
      </div>`;
      count++;
    });

    document.getElementById('squadCount').textContent = count + ' agent' + (count !== 1 ? 's' : '');
    document.getElementById('onlineCount').textContent = count + ' online';
  } catch(e) { console.error('Init failed:', e); }
}

function clickAgent(id) {
  // Highlight in office
  document.querySelectorAll('.agent-char').forEach(c => c.classList.remove('selected'));
  document.getElementById('char-' + id)?.classList.add('selected');
  // Focus input
  document.getElementById('chatInput').focus();
}

function send() {
  const input = document.getElementById('chatInput');
  const text = input.value.trim();
  if (!text || !ws || ws.readyState !== 1) return;
  input.value = '';

  // Show user message
  const el = document.getElementById('messages');
  el.innerHTML += `<div class="msg user">${esc(text)}</div>`;
  el.scrollTop = el.scrollHeight;

  // Send to ALL agents
  for (const [id, a] of Object.entries(agentData)) {
    pendingAgents.add(id);
    ws.send(JSON.stringify({
      type: 'chat', agentPkg: a.pkgName,
      message: text, sessionKey: sessions[id] || null,
    }));
  }
}

function updateClock() {
  document.getElementById('clock').textContent = new Date().toLocaleTimeString('en-US', { hour:'2-digit', minute:'2-digit', timeZoneName:'short' });
}

// Clear old session keys on fresh load
localStorage.removeItem('hq-sessions');

init();
connectWS();
updateClock();
setInterval(updateClock, 1000);
</script>
</body>
</html>
